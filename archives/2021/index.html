
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="codexdawn">
    <title>Archives: 2021 - codexdawn</title>
    <meta name="author" content="codexdawn">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="codexdawn">
<meta property="og:url" content="https://codexdawn.github.io/archives/2021/index.html">
<meta property="og:site_name" content="codexdawn">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="codexdawn">
<meta name="twitter:card" content="summary">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-3sspfygaapf5d6tbrnqmyrhdcstv0iwwmi4wor2yeip9c44sowy9gbdzyyjm.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            codexdawn
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/codexdawn"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.facebook.com/beherzt.dev"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/sim-jisung-3048872a/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:cloudkaiser@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/10/mapstruct-1/"
                            aria-label=": mapstruct-1"
                        >
                            mapstruct-1
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-10T03:18:01+00:00">
	
		    May 10, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Mapstruct/">Mapstruct</a>, <a class="category-link" href="/categories/%EC%9C%A0%EB%A0%88%EC%B9%B4or%EC%82%BD%EC%A7%88/">유레카or삽질</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Mapstruct-삽질기"><a href="#Mapstruct-삽질기" class="headerlink" title="Mapstruct 삽질기"></a>Mapstruct 삽질기</h1><h2 id="1-Mapstruct란"><a href="#1-Mapstruct란" class="headerlink" title="1. Mapstruct란?"></a>1. Mapstruct란?</h2><p><img src="https://mapstruct.org/" alt="Mapstruct 공식사이트"></p>
<p>MapStruct is a code generator that greatly simplifies the implementation of mappings between Java bean types based on a convention over configuration approach.<br>자바빈즈기반의 객체를 간단한 컨벤션 설정을 통해 매핑시켜주는 역할을 담당한다고 생각하면 됨. 그냥 ModelMapper와 유사한 기능을 한다고 생각하면 됨. (그렇다고 둘이 매커니즘이 같은건 아님. )</p>
<hr>
<h2 id="2-왜-사용함"><a href="#2-왜-사용함" class="headerlink" title="2. 왜 사용함?"></a>2. 왜 사용함?</h2><p>Multi-layered applications often require to map between different object models (e.g. entities and DTOs). Writing such mapping code is a tedious and error-prone task. MapStruct aims at simplifying this work by automating it as much as possible.<br>In contrast to other mapping frameworks MapStruct generates bean mappings at compile-time which ensures a high performance, allows for fast developer feedback and thorough error checking.</p>
<p>Multi-layered (멀티모듈 프로젝트 같은것?)은 다른 객체 모델에 대해서 매핑시켜줘야하는 일들이 많다. 예를들어서 Entity를 DTO로. 기존 노가다성 메핑할떄는 세레머니 코드들이 많이 들어가있고(map,mapToList..) 에러를 유발시킬수있는 코드로 실수할수있는데, MapStruct는 이런 부분을 자동으로 간단스하게 처리 해줌.<br>다른 매핑프레임워크에 비해서 MapStruct는 컴파일 시점에 mapping 코드를 생성하기때문에 성능적으로 안정적인 부분과 컴파일시점에 에러를 잡아낼수있어서, 개발자의 실수를 줄일수있음. (modelmapper는 runtime시점에 mapping하기때문에 생성비용이 꽤나큼 뭐 Bean Scope가 singleton이라 한번 컨테이너 올리면.. 그닥 큰 이슈가 아닐란가싶긴하지만..runtime과 compile시점은 엄청난 차이가 있음. compile시점이 사실 안정적으로 실수나 에러검증을 해주기가 아주 유리함!)</p>
<hr>
<h2 id="3-설정"><a href="#3-설정" class="headerlink" title="3. 설정"></a>3. 설정</h2><h3 id="3-1-build-gradle"><a href="#3-1-build-gradle" class="headerlink" title="3-1. build.gradle"></a>3-1. build.gradle</h3><p>설정위해서는 lombok 의존성을 추가한 root 프로젝트쪽 build.gradle쪽에 추가해줘야함. 중요한 부분은 lombok을 사용하면 의존성 추가할때 위치나 버전에 따라 설정이 달라질수있음. </p>
<figure class="highlight plain"><figcaption><span>root-build.gradle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">dependencies &#123;</span><br><span class="line"></span><br><span class="line">        implementation &#39;org.mapstruct:mapstruct:1.4.1.Final&#39;</span><br><span class="line">        compileOnly &#39;org.projectlombok:lombok&#39;</span><br><span class="line">        compile group: &#39;org.projectlombok&#39;, name: &#39;lombok-mapstruct-binding&#39;, version: &#39;0.2.0&#39;</span><br><span class="line">        annotationProcessor &#39;org.springframework.boot:spring-boot-configuration-processor&#39;</span><br><span class="line">        annotationProcessor &#39;org.projectlombok:lombok&#39;</span><br><span class="line">        annotationProcessor &#39;org.mapstruct:mapstruct-processor:1.4.1.Final&#39;</span><br><span class="line"></span><br><span class="line">        testImplementation(&#39;org.springframework.boot:spring-boot-starter-test&#39;) &#123;</span><br><span class="line">            exclude group: &#39;org.junit.vintage&#39;, module: &#39;junit-vintage-engine&#39;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; jackson</span><br><span class="line">        implementation(&#39;com.fasterxml.jackson.core:jackson-databind&#39;)</span><br><span class="line">        implementation(&#39;com.google.code.gson:gson:2.8.0&#39;)</span><br><span class="line">        implementation(&#39;com.google.guava:guava:28.0-jre&#39;)</span><br><span class="line">        implementation(&#39;commons-codec:commons-codec&#39;)</span><br><span class="line">        implementation(&#39;org.apache.commons:commons-lang3:3.9&#39;)</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; jsr validation</span><br><span class="line">        implementation(&#39;javax.validation:validation-api:2.0.1.Final&#39;)</span><br><span class="line"></span><br><span class="line">        testCompile group: &#39;junit&#39;, name: &#39;junit&#39;, version: &#39;4.12&#39;</span><br><span class="line">        testImplementation(&#39;org.easytesting:fest-assert:1.4&#39;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-GenericMapper"><a href="#3-2-GenericMapper" class="headerlink" title="3-2. GenericMapper"></a>3-2. GenericMapper</h3><p>사실 굳이 안만들어도 되긴하는데, 한벌 만들어놓으면 공통로직으로 사용하기 용이함 </p>
<figure class="highlight java"><figcaption><span>api-GenericMapper</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.api.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mapstruct.NullValuePropertyMappingStrategy.IGNORE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mapstruct.BeanMapping;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.MappingTarget;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GenericMapper</span>&lt;<span class="title">D</span>,<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">D <span class="title">toDto</span><span class="params">(E e)</span></span>;</span><br><span class="line">    <span class="function">E <span class="title">toEntity</span><span class="params">(D d)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeanMapping(nullValuePropertyMappingStrategy = IGNORE)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateFromDto</span><span class="params">(D dto, <span class="meta">@MappingTarget</span> E entity)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-사용방법"><a href="#4-사용방법" class="headerlink" title="4. 사용방법"></a>4. 사용방법</h2><p>사용 예시는 mapToList 의 예시이다. 하지만 기존 modelMapper에서 처리하는 부분도 @Mapper내에서 가능한것으로 파악되어짐. </p>
<figure class="highlight java"><figcaption><span>entity to dto 사용방법</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.api.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.api.dto.order.PurchaseInfo;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.repository.escrow.order.Purchase;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper(componentModel = &quot;spring&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PurchaseMapper</span> <span class="keyword">extends</span> <span class="title">GenericMapper</span>&lt;<span class="title">PurchaseInfo</span>, <span class="title">Purchase</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;PurchaseInfo&gt; <span class="title">getPurchaseInfo</span><span class="params">(List&lt;Purchase&gt; purchaseEntity)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>실사용소스</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.api.service.purchase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.api.dto.order.PurchaseInfo;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.api.dto.order.PurchaseRequestParam;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.api.mapper.PurchaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.provider.order.PurchaseProvider;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.utils.ModelMapperUtils;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.order.OrderType;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.factory.Mappers;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PurchaseService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PurchaseProvider purchaseProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PurchaseMapper purchaseMapper = Mappers.getMapper(PurchaseMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PurchaseInfo&gt; <span class="title">getPurchaseInfo</span><span class="params">(PurchaseRequestParam param)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//return ModelMapperUtils.mapToList(purchaseProvider.findByOrderTypeAndMid(param.getOrderType(),param.getMid()),PurchaseInfo.class);</span></span><br><span class="line">        <span class="keyword">return</span> purchaseMapper.getPurchaseInfo(purchaseProvider.findByOrderTypeAndMid(param.getOrderType(),param.getMid()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PurchaseInfo&gt; <span class="title">getPurchaseInfoByOrderType</span><span class="params">(OrderType orderType)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//return ModelMapperUtils.mapToList(purchaseProvider.findByOrderTypeEquals(orderType),PurchaseInfo.class);</span></span><br><span class="line">        <span class="keyword">return</span> purchaseMapper.getPurchaseInfo(purchaseProvider.findByOrderTypeEquals(orderType));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-참고"><a href="#5-참고" class="headerlink" title="5. 참고"></a>5. 참고</h2><p><img src="https://www.baeldung.com/mapstruct" alt="baeldung-mapstruct 가이드"><br><img src="https://mapstruct.org/documentation/stable/reference/html/" alt="mapstruct공식사이트"></p>
<hr>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/10/mapstruct-1/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/08/java8-chaptor2/"
                            aria-label=": java8-chaptor2"
                        >
                            java8-chaptor2
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-08T08:18:24+00:00">
	
		    May 08, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Java8InAction/">Java8InAction</a>, <a class="category-link" href="/categories/Study/">Study</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Chapter-2-동작파라미터화-코드-전달하기"><a href="#Chapter-2-동작파라미터화-코드-전달하기" class="headerlink" title="Chapter 2. 동작파라미터화 코드 전달하기"></a>Chapter 2. 동작파라미터화 코드 전달하기</h1><h2 id="목차"><a href="#목차" class="headerlink" title="목차"></a>목차</h2><ol>
<li><a href="#1.%EB%B3%80%ED%99%94%ED%95%98%EB%8A%94-%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD%EC%97%90-%EB%8C%80%EC%9D%91">변화하는 요구사항에 대응</a></li>
<li><a href="#2.%EB%8F%99%EC%9E%91%ED%8C%8C%EB%9D%BC%EB%AF%B8%ED%84%B0%ED%99%94">동작파라미터화</a></li>
<li><a href="#3.%EC%9D%B5%EB%AA%85%ED%81%B4%EB%9E%98%EC%8A%A4">익명클래스</a></li>
<li><a href="#4.%EB%9E%8C%EB%8B%A4-%ED%91%9C%ED%98%84%EC%8B%9D-%EB%AF%B8%EB%A6%AC%EB%B3%B4%EA%B8%B0">람다 표현식 미리보기</a></li>
<li><a href="#5.%EC%8B%A4%EC%A0%84%EC%98%88%EC%A0%9C:-Comparator,Runnable,GUI">실전예제: Comparator,Runnable,GUI</a></li>
</ol>
<hr>
<h2 id="1-변화하는-요구사항에-대응"><a href="#1-변화하는-요구사항에-대응" class="headerlink" title="1.변화하는 요구사항에 대응"></a>1.변화하는 요구사항에 대응</h2><ul>
<li>우리가 어떤 상황에서 일을 하든 소비자 요구사항은 항상 바뀐다. 변화하는 요구사항은 소프트웨어 엔지니어링에서 피할수 없는 문제다. </li>
<li>동작 파라미터화(behavior parameterization) 을 활용하면 자주 바뀌는 요구사항에 효과적으로 대응 할수 있다. </li>
<li>동작 파라미터란? 아직은 어떻게 실행할 것인지 결정하지 않은 코드 블록을 의미함. 이 코드 블록은 나중에 프로그램에서 호출한다. 즉, 코드블록의 실행은 나중으로 미뤄진다. </li>
</ul>
<h3 id="1-1-첫번째시도-녹색사과-필터링"><a href="#1-1-첫번째시도-녹색사과-필터링" class="headerlink" title="1-1. 첫번째시도:녹색사과 필터링"></a>1-1. 첫번째시도:녹색사과 필터링</h3><figure class="highlight java"><figcaption><span>filterGreenApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Color</span> </span>&#123; RED, GREEN &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterGreenApples</span><span class="params">(List&lt;Apple&gt; inventory)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();                          <span class="number">1.</span>사과 누적리스트</span><br><span class="line">    <span class="keyword">for</span>(Apple apple: inventory)&#123;</span><br><span class="line">        <span class="keyword">if</span>( GREEN.equals(apple.getColor() ) &#123;                        <span class="number">2.</span>녹색사과 필터 </span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-두번째시도-색을-파라미터화"><a href="#1-2-두번째시도-색을-파라미터화" class="headerlink" title="1-2. 두번째시도:색을 파라미터화"></a>1-2. 두번째시도:색을 파라미터화</h4><figure class="highlight java"><figcaption><span>filterGreenApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApplesByColor</span><span class="params">(List&lt;Apple&gt; inventory,</span></span></span><br><span class="line"><span class="function"><span class="params">Color color)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Apple apple: inventory) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( apple.getColor().equals(color) ) &#123;</span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Apple&gt; greenApples = filterApplesByColor(inventory, GREEN);</span><br><span class="line">List&lt;Apple&gt; redApples = filterApplesByColor(inventory, RED);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 농부의 다양한 요구사항을 들어보니 색과 마찬가지로 앞으로 무게의 기준도 얼마든지 바뀔수있다는걸 알게됫음.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApplesByWeight</span><span class="params">(List&lt;Apple&gt; inventory,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> weight)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    For (Apple apple: inventory)&#123;</span><br><span class="line">        <span class="keyword">if</span> ( apple.getWeight() &gt; weight ) &#123;</span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>주로 내가 현업에서 개발하던 스타일이며 자주 보던 스타일이다. 코드 자체가 저렇게 필터링 되는 조건만 달라지고 나머지는 거의 동일한 로직으로 처리되는 로직들을 종종 볼수있었다. 그렇다보니 최악의 코드이며 가장 더러운 방식까지 내려가던일도 진짜 가끔있었다. 세번째 시도를 한번 보자.</p>
<h4 id="1-3-세번째-시도-가능한-모든-속성으로-필터링"><a href="#1-3-세번째-시도-가능한-모든-속성으로-필터링" class="headerlink" title="1-3. 세번째 시도: 가능한 모든 속성으로 필터링"></a>1-3. 세번째 시도: 가능한 모든 속성으로 필터링</h4><figure class="highlight java"><figcaption><span>filterApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApples</span><span class="params">(List&lt;Apple&gt; inventory, Color color,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">int</span> weight, <span class="keyword">boolean</span> flag)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Apple apple: inventory) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (flag &amp;&amp; apple.getColor().equals(color)) ||</span><br><span class="line">             (!flag &amp;&amp; apple.getWeight() &gt; weight) )&#123;          <span class="number">1.</span> 정말 더럽다. 코드가..-_-; flag의 용도는 대체 뭐임? </span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위 코드를 보자하니, 정말 답이없다. 우선 flag의 용도는 뭘까? 하나의 공통 코드로 만들어보려다가 오히려 똥 만들어놨다. 부끄럽지만 나도 저렇게 짜려고 했던적이 있던것 같다. 이제부터 동작 파라미터화를 하는 방법에 대해서 확인해보자! </p>
<hr>
<h2 id="2-동작파라미터화"><a href="#2-동작파라미터화" class="headerlink" title="2.동작파라미터화"></a>2.동작파라미터화</h2><h3 id="2-1-네번째시도-추상적조건으로-필터링"><a href="#2-1-네번째시도-추상적조건으로-필터링" class="headerlink" title="2-1. 네번째시도: 추상적조건으로 필터링"></a>2-1. 네번째시도: 추상적조건으로 필터링</h3><figure class="highlight java"><figcaption><span>predicate</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplePredicate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">test</span> <span class="params">(Apple apple)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppleHeavyWeightPredicate</span> <span class="keyword">implements</span> <span class="title">ApplePredicate</span> </span>&#123;   <span class="number">1.</span> 무게 <span class="number">150</span>이상</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple apple)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> apple.getWeight() &gt; <span class="number">150</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppleGreenColorPredicate</span> <span class="keyword">implements</span> <span class="title">ApplePredicate</span> </span>&#123;    <span class="number">2.</span> 녹색사과만 </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple apple)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> GREEN.equals(apple.getColor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppleRedAndHeavyPredicate</span> <span class="keyword">implements</span> <span class="title">ApplePredicate</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple apple)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> RED.equals(apple.getColor())</span><br><span class="line">                       &amp;&amp; apple.getWeight() &gt; <span class="number">150</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApples</span><span class="params">(List&lt;Apple&gt; inventory,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       ApplePredicate p)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Apple apple: inventory) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p.test(apple)) &#123;                       <span class="number">1.</span> predicate객체로 사과 검사 조건 캡슐화</span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">List&lt;Apple&gt; redAndHeavyApples =</span><br><span class="line">    filterApples(inventory, <span class="keyword">new</span> AppleRedAndHeavyPredicate());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/java8/java-1.png" alt="사과를 선택하는 다양한 전략"></p>
<p>위 그림처럼 전략패턴을 활용해서 사과의 필터조건을 결정하도록 개발하게되었다. 이렇게되면 각 구체 클래스에서 정의한 조건을 ApplePredicate 에 파라미터화 시키면 된다. 확실히 더러웠던 3번째시도 보다는 아주 스마트하고 깔끔해졌다. 역시 이래서 디자인패턴을 활용해야하나 보다. </p>
<hr>
<h2 id="3-익명클래스"><a href="#3-익명클래스" class="headerlink" title="3.익명클래스"></a>3.익명클래스</h2><ul>
<li>익명 클래스는 자바의 지역클래스(블록 내부에 설정된 클래스)와 비슷한개념이다.</li>
<li>익명 클래스를 이용하면 클래스 선언과 인스턴스화를 동시에 할 수 있다.</li>
</ul>
<h3 id="3-1-다섯번째-시도-익명클래스-사용"><a href="#3-1-다섯번째-시도-익명클래스-사용" class="headerlink" title="3-1. 다섯번째 시도: 익명클래스 사용"></a>3-1. 다섯번째 시도: 익명클래스 사용</h3><figure class="highlight java"><figcaption><span>filterApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">List&lt;Apple&gt; redApples = filterApples(inventory, <span class="keyword">new</span> ApplePredicate() &#123;     <span class="number">1.</span>메서드를 파라미터화 시켰음. </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple apple)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RED.equals(apple.getColor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>위 처럼 메서드를 파라미터화 시켜서 익명클래스를 적용은 시켰지만 여전히 빨간사과를 필터링하는 조건이 이외에 코드들이 너무 장황하다. 이런 익명클래스는 람다식을 통해 코드량을 단축시킬수있다. </p>
<hr>
<h2 id="4-람다-표현식-미리보기"><a href="#4-람다-표현식-미리보기" class="headerlink" title="4.람다 표현식 미리보기"></a>4.람다 표현식 미리보기</h2><h3 id="4-1-여섯번째-시도-람다-표현식-사용"><a href="#4-1-여섯번째-시도-람다-표현식-사용" class="headerlink" title="4-1. 여섯번째 시도: 람다 표현식 사용"></a>4-1. 여섯번째 시도: 람다 표현식 사용</h3><figure class="highlight java"><figcaption><span>filterApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">List&lt;Apple&gt; result =</span><br><span class="line">  filterApples(inventory, (Apple apple) -&gt; RED.equals(apple.getColor()));</span><br></pre></td></tr></table></figure>

<p>이렇게 람다 표현식을 사용하면 코드를 더 심플하게 작성이 가능하다. </p>
<h3 id="4-2-일곱번째-시도-리스트형식-추상화"><a href="#4-2-일곱번째-시도-리스트형식-추상화" class="headerlink" title="4-2. 일곱번째 시도: 리스트형식 추상화"></a>4-2. 일곱번째 시도: 리스트형식 추상화</h3><figure class="highlight java"><figcaption><span>filterApples:generic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Predicate</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(T t)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">filter</span><span class="params">(List&lt;T&gt; list, Predicate&lt;T&gt; p)</span> </span>&#123;     <span class="number">1</span></span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(T e: list) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p.test(e)) &#123;</span><br><span class="line">            result.add(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>앞으로 이렇게 추상화 시켜서, 공통 모듈로 만드는 습관이 필요하다. 모든 개발할때 저런 추상화를 늘 고려해서 개발하는 경지에 이르렀으면 좋겠다. </p>
<hr>
<h2 id="5-실전예제-Comparator-Runnable-GUI"><a href="#5-실전예제-Comparator-Runnable-GUI" class="headerlink" title="5.실전예제: Comparator,Runnable,GUI"></a>5.실전예제: Comparator,Runnable,GUI</h2><h3 id="5-1-Comparator로-정렬하기"><a href="#5-1-Comparator로-정렬하기" class="headerlink" title="5-1. Comparator로 정렬하기"></a>5-1. Comparator로 정렬하기</h3><figure class="highlight java"><figcaption><span>Comparator정렬</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">inventory.sort(<span class="keyword">new</span> Comparator&lt;Apple&gt;() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Apple a1, Apple a2)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> a1.getWeight().compareTo(a2.getWeight());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inventory.sort(</span><br><span class="line">  (Apple a1, Apple a2) -&gt; a1.getWeight().compareTo(a2.getWeight()));</span><br><span class="line">  </span><br></pre></td></tr></table></figure>


<h3 id="5-2-Runnable"><a href="#5-2-Runnable" class="headerlink" title="5-2. Runnable"></a>5-2. Runnable</h3><figure class="highlight java"><figcaption><span>Runnable</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">// java.lang.Runnable 인터페이스</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//익명클래스 표현</span></span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//람다식표현</span></span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">&quot;Hello world&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// java.util.concurrent.Callable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">V <span class="title">call</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">Future&lt;String&gt; threadName = executorService.submit(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Future&lt;String&gt; threadName = executorService.submit(</span><br><span class="line">                     () -&gt; Thread.currentThread().getName());</span><br></pre></td></tr></table></figure>


<h3 id="5-3-GUI-이벤트-처리하기"><a href="#5-3-GUI-이벤트-처리하기" class="headerlink" title="5-3. GUI 이벤트 처리하기"></a>5-3. GUI 이벤트 처리하기</h3><figure class="highlight java"><figcaption><span>GUI</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">Button button = <span class="keyword">new</span> Button(<span class="string">&quot;Send&quot;</span>);</span><br><span class="line">button.setOnAction(<span class="keyword">new</span> EventHandler&lt;ActionEvent&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(ActionEvent event)</span> </span>&#123;</span><br><span class="line">        label.setText(<span class="string">&quot;Sent!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">button.setOnAction((ActionEvent event) -&gt; label.setText(<span class="string">&quot;Sent!!&quot;</span>));</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/08/java8-chaptor2/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/08/jpa-obj-query-2/"
                            aria-label=": jpa-obj-query-2"
                        >
                            jpa-obj-query-2
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-08T02:54:28+00:00">
	
		    May 08, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5%EC%BF%BC%EB%A6%AC%EC%96%B8%EC%96%B4/">객체지향쿼리언어</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="객체지향-쿼리-언어2"><a href="#객체지향-쿼리-언어2" class="headerlink" title="객체지향 쿼리 언어2"></a>객체지향 쿼리 언어2</h1><h2 id="1-경로표현식"><a href="#1-경로표현식" class="headerlink" title="1. 경로표현식"></a>1. 경로표현식</h2><h3 id="1-1-경로표현식이란"><a href="#1-1-경로표현식이란" class="headerlink" title="1-1. 경로표현식이란?"></a>1-1. 경로표현식이란?</h3><ul>
<li>. 찍어서 객체그래프를 탐색하는 것 </li>
</ul>
<h3 id="1-2-경로표현식-특징"><a href="#1-2-경로표현식-특징" class="headerlink" title="1-2. 경로표현식 특징"></a>1-2. 경로표현식 특징</h3><ul>
<li>상태 필드(state field): 경로 탐색의 끝, 탐색X</li>
<li>단일 값 연관 경로: 묵시적 내부 조인(inner join) 발생, 탐색O<ul>
<li>@ManyToOne, @OneToOne, 대상이 엔티티(ex: m.team)</li>
</ul>
</li>
<li>컬렉션 값 연관 경로: 묵시적 내부 조인 발생, 탐색X<ul>
<li>FROM 절에서 명시적 조인을 통해 별칭을 얻으면 별칭을 통 해 탐색 가능</li>
<li>@OneToMany, @ManyToMany, 대상이 컬렉션(ex: m.orders)</li>
</ul>
</li>
</ul>
<h3 id="1-3-경로탐색을-사용한-묵시적-조인-시-주의사항"><a href="#1-3-경로탐색을-사용한-묵시적-조인-시-주의사항" class="headerlink" title="1-3. 경로탐색을 사용한 묵시적 조인 시 주의사항"></a>1-3. 경로탐색을 사용한 묵시적 조인 시 주의사항</h3><ul>
<li>항상 내부조인 걸림 </li>
<li>걸렉션은 경로 탐색이 안된다. (사이즈만 받을수있음) 따라서 컬렉션은 반드시 명시적 조인으로 별칭을 얻어서 경로탐색하도록 해야함<ul>
<li>select m.username from Team t join t.members m</li>
</ul>
</li>
<li>경로탐색은 주로 SELECT/WHERE 절에서만 하는데, 묵시적조인을 사용하면 SQL에서 FROM(JOIN) 절에 영향을 줌 </li>
</ul>
<h3 id="1-4-실무자의-조언"><a href="#1-4-실무자의-조언" class="headerlink" title="1-4. 실무자의 조언"></a>1-4. 실무자의 조언</h3><ul>
<li>가급적 묵시적 조인 하지말고 명시적 조인만 사용하도록 하자 (쿼리 튜닝 및 알아보기 힘듦)</li>
<li>조인은 sql튜닝에 가장 중요한 포인트(기승전 SQL)</li>
<li>묵시적 조인은 조인이 일어나는 상황을 한눈에 파악하기 어려움 </li>
</ul>
<h2 id="2-페치-조인-fetch-join"><a href="#2-페치-조인-fetch-join" class="headerlink" title="2. 페치 조인 (fetch join)"></a>2. 페치 조인 (fetch join)</h2><h3 id="2-1-페치-조인의-특징"><a href="#2-1-페치-조인의-특징" class="headerlink" title="2-1. 페치 조인의 특징"></a>2-1. 페치 조인의 특징</h3><ul>
<li>SQL join종류 아님 (sql 명령어 아님)</li>
<li>JPQL 성능 최적화를 위해 제공하는 기능 </li>
<li>연관된 엔티티나 컬렉션을 SQL 한번에 함께 조회 가능 (한방쿼리)</li>
<li>join fetch 명령어 사용 </li>
<li>페치 조인 ::= [ LEFT [OUTER] | INNER ] JOIN FETCH 조인경로</li>
</ul>
<h3 id="2-2-엔티티-페치-조인"><a href="#2-2-엔티티-페치-조인" class="headerlink" title="2-2. 엔티티 페치 조인"></a>2-2. 엔티티 페치 조인</h3><ul>
<li>ManyToOne, OneToOne 관계에서 조회할때 이슈라고 생각해도됨. </li>
<li>회원-팀 예시 기준으로 회원을 조회하면서 연관된 팀도 함께 조회 (SQL 한방 쿼리)</li>
<li>SQL을 보면 회원 뿐만 아니라 팀(T.*)도 함께 SELECT</li>
<li>[JPQL]<ul>
<li>select m from Member m join fetch m.team</li>
</ul>
</li>
<li>[SQL]<ul>
<li>SELECT M.<em>, T.</em> FROM MEMBER M INNER JOIN TEAM T ON M.TEAM_ID=T.ID</li>
</ul>
</li>
</ul>
<p><img src="/images/jpa/jpql-11.png" alt="엔티티페치조인 예시"><br><img src="/images/jpa/jpql-12.png" alt="엔티티페치코드 예시"></p>
<p>[Q1] 그냥 Member 엔티티를 쿼리를 날리고, 비즈니스코드에서 Team정보를 조회하면?</p>
<figure class="highlight java"><figcaption><span>엔티티조회</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; members =entityManager.createQuery(<span class="string">&quot;select m from Member m&quot;</span>, Member.class).getResultList();</span><br><span class="line"><span class="keyword">for</span> (Member member1 : members2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;member1.getUserName() = &quot;</span> + member1.getUserName() </span><br><span class="line">				+ <span class="string">&quot;/ teamName : &quot;</span> + member1.getTeam().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>–&gt; 위 처럼 비즈니스로직에서 Team정보를 호출하면 proxy상태이기때문에, 초기화처리로 각 멤버당 팀 정보를 디비를 통해 조회 해오게된다. 하지만 1차캐시에 등록된 그니까 영속성 관리가 되면 1차캐시 정보로 가져오게됨. </p>
<figure class="highlight plain"><figcaption><span>엔티티조회결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        m </span><br><span class="line">    from</span><br><span class="line">        Member m *&#x2F; select</span><br><span class="line">            member0_.member_id as member_i1_0_,</span><br><span class="line">            member0_.age as age2_0_,</span><br><span class="line">            member0_.team_id as team_id4_0_,</span><br><span class="line">            member0_.userName as userName3_0_ </span><br><span class="line">        from</span><br><span class="line">            Member member0_</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        team0_.team_id as team_id1_3_0_,</span><br><span class="line">        team0_.name as name2_3_0_ </span><br><span class="line">    from</span><br><span class="line">        Team team0_ </span><br><span class="line">    where</span><br><span class="line">        team0_.team_id&#x3D;?</span><br><span class="line">member1.getUserName() &#x3D; m1&#x2F; teamName : Team1</span><br><span class="line">member1.getUserName() &#x3D; m2&#x2F; teamName : Team1 &#x2F;&#x2F;여기서는 1차캐시로 조회된 정보 가져옴 </span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        team0_.team_id as team_id1_3_0_,</span><br><span class="line">        team0_.name as name2_3_0_ </span><br><span class="line">    from</span><br><span class="line">        Team team0_ </span><br><span class="line">    where</span><br><span class="line">        team0_.team_id&#x3D;?</span><br><span class="line">member1.getUserName() &#x3D; m3&#x2F; teamName : Team2</span><br></pre></td></tr></table></figure>

<p>[Q2] 위 쿼리에서 Team엔티티를 조인해서 조회하면 어떻게 될까? </p>
<figure class="highlight java"><figcaption><span>단순 조인시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; members =entityManager.createQuery(<span class="string">&quot;select m from Member m join m.team&quot;</span>, Member.class).getResultList();</span><br><span class="line"><span class="keyword">for</span> (Member member1 : members2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;member1.getUserName() = &quot;</span> + member1.getUserName() </span><br><span class="line">				+ <span class="string">&quot;/ teamName : &quot;</span> + member1.getTeam().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>–&gt; 단순 조인만 했지만 프로젝션 상에서 팀정보가 없다.<br>어쨋든 위 상황에서는 프로젝션상에서 Team엔티티 정보가 없기때문에 Q1 상황과 동일한 결과로 나오게됨.<br>(참고) 글로벌 페치 전략을 아무리 EAGER로 강제해도 동일한 결과 나올수밖에 없음. 프록시 이슈는 동일하게 나올수밖에없더라.<br>(추론) 만약에 저기서 조회를 가능하게 하려면 프로젝션상에서 t를 받고, 프로젝션에 맞는 신규DTO를 만들어서 객체로 반환하면 해결되지않을까 싶음. </p>
<figure class="highlight plain"><figcaption><span>단순 조인시 결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        m </span><br><span class="line">    from</span><br><span class="line">        Member m </span><br><span class="line">    join</span><br><span class="line">        m.team *&#x2F; select</span><br><span class="line">            member0_.member_id as member_i1_0_,</span><br><span class="line">            member0_.age as age2_0_,</span><br><span class="line">            member0_.team_id as team_id4_0_,</span><br><span class="line">            member0_.userName as userName3_0_ </span><br><span class="line">        from</span><br><span class="line">            Member member0_ </span><br><span class="line">        inner join &#x2F;&#x2F;조인만 됫지 프로젝션상에서는 Team정보가 없다..-_-; </span><br><span class="line">            Team team1_ </span><br><span class="line">                on member0_.team_id&#x3D;team1_.team_id</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        team0_.team_id as team_id1_3_0_,</span><br><span class="line">        team0_.name as name2_3_0_ </span><br><span class="line">    from</span><br><span class="line">        Team team0_ </span><br><span class="line">    where</span><br><span class="line">        team0_.team_id&#x3D;?</span><br><span class="line">member1.getUserName() &#x3D; m1&#x2F; teamName : Team1</span><br><span class="line">member1.getUserName() &#x3D; m2&#x2F; teamName : Team1</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        team0_.team_id as team_id1_3_0_,</span><br><span class="line">        team0_.name as name2_3_0_ </span><br><span class="line">    from</span><br><span class="line">        Team team0_ </span><br><span class="line">    where</span><br><span class="line">        team0_.team_id&#x3D;?</span><br><span class="line">member1.getUserName() &#x3D; m3&#x2F; teamName : Team2</span><br></pre></td></tr></table></figure>

<p>[Q3] 그럼 저렇게 N+1이 나면 어떻게 해결해야함?<br>–&gt; fetch join 하면 됨. </p>
<figure class="highlight java"><figcaption><span>조인페치시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; members =entityManager.createQuery(<span class="string">&quot;select m from Member m join fetch m.team&quot;</span>, Member.class).getResultList();</span><br><span class="line"><span class="keyword">for</span> (Member member1 : members2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;member1.getUserName() = &quot;</span> + member1.getUserName() </span><br><span class="line">				+ <span class="string">&quot;/ teamName : &quot;</span> + member1.getTeam().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>단순 조인시 결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        m </span><br><span class="line">    from</span><br><span class="line">        Member m </span><br><span class="line">    join</span><br><span class="line">        fetch m.team *&#x2F; select</span><br><span class="line">            member0_.member_id as member_i1_0_0_,</span><br><span class="line">            team1_.team_id as team_id1_3_1_,</span><br><span class="line">            member0_.age as age2_0_0_,</span><br><span class="line">            member0_.team_id as team_id4_0_0_,</span><br><span class="line">            member0_.userName as userName3_0_0_,</span><br><span class="line">            team1_.name as name2_3_1_ </span><br><span class="line">        from</span><br><span class="line">            Member member0_ </span><br><span class="line">        inner join</span><br><span class="line">            Team team1_ </span><br><span class="line">                on member0_.team_id&#x3D;team1_.team_id</span><br><span class="line">member1.getUserName() &#x3D; m1&#x2F; teamName : Team1</span><br><span class="line">member1.getUserName() &#x3D; m2&#x2F; teamName : Team1</span><br><span class="line">member1.getUserName() &#x3D; m3&#x2F; teamName : Team2</span><br></pre></td></tr></table></figure>

<h3 id="2-3-컬렉션-페치-조인"><a href="#2-3-컬렉션-페치-조인" class="headerlink" title="2-3. 컬렉션 페치 조인"></a>2-3. 컬렉션 페치 조인</h3><ul>
<li>일대다,다대다 관계, 컬렉션 페치 조인 </li>
<li>[JPQL]<ul>
<li>select t from Team t join fetch t.members where t.name = ‘팀A’</li>
</ul>
</li>
<li>[SQL]<ul>
<li>SELECT T.<em>, M.</em> FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID WHERE T.NAME = ‘팀A’</li>
</ul>
</li>
</ul>
<p><img src="/images/jpa/jpql-13.png" alt="컬렉션페치조인 예시"><br><img src="/images/jpa/jpql-14.png" alt="컬렉션페치코드 예시"></p>
<h3 id="컬렉션-페치-조인-혹은-그냥-조인을-걸었는데-중복-발생"><a href="#컬렉션-페치-조인-혹은-그냥-조인을-걸었는데-중복-발생" class="headerlink" title="컬렉션 페치 조인 혹은 그냥 조인을 걸었는데 중복 발생?"></a>컬렉션 페치 조인 혹은 그냥 조인을 걸었는데 중복 발생?</h3><p>OneToMany특성상 쿼리 뻥튀기가 되었기때문에 중복 row발생된것임. 이걸 해결할라면 jpql의 distinct를 걸어주면 해결됨. </p>
<h4 id="JPQL에서의-distinct"><a href="#JPQL에서의-distinct" class="headerlink" title="JPQL에서의 distinct"></a>JPQL에서의 distinct</h4><ul>
<li>SQL의 distinct 처리를 명령함  </li>
<li>JPQL에서는 distinct 2가지 기능 제공 <ol>
<li>SQL distinct 를 추가시킴. </li>
<li>애플리케이션에서 엔티티 중복을 제거시킴. </li>
</ol>
</li>
</ul>
<p>[Q1] Member 컬렉션을 조인하면 어떻게 될까?</p>
<figure class="highlight java"><figcaption><span>컬렉션조인시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select t from Team t join t.members&quot;</span>, Team.class)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션조인결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        t </span><br><span class="line">    from</span><br><span class="line">        Team t </span><br><span class="line">    join</span><br><span class="line">        t.members *&#x2F; select</span><br><span class="line">            team0_.team_id as team_id1_3_,</span><br><span class="line">            team0_.name as name2_3_ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ </span><br><span class="line">        inner join</span><br><span class="line">            Member members1_ </span><br><span class="line">                on team0_.team_id&#x3D;members1_.team_id</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        members0_.team_id as team_id4_0_0_,</span><br><span class="line">        members0_.member_id as member_i1_0_0_,</span><br><span class="line">        members0_.member_id as member_i1_0_1_,</span><br><span class="line">        members0_.age as age2_0_1_,</span><br><span class="line">        members0_.team_id as team_id4_0_1_,</span><br><span class="line">        members0_.userName as userName3_0_1_ </span><br><span class="line">    from</span><br><span class="line">        Member members0_ </span><br><span class="line">    where</span><br><span class="line">        members0_.team_id&#x3D;?</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2 &#x2F;&#x2F;컬렉션 조인시 요렇게 중복된 결과가 나오는걸 확인할수있음. 이럴때는 distinct를 걸어서 중복제거해야함. </span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        members0_.team_id as team_id4_0_0_,</span><br><span class="line">        members0_.member_id as member_i1_0_0_,</span><br><span class="line">        members0_.member_id as member_i1_0_1_,</span><br><span class="line">        members0_.age as age2_0_1_,</span><br><span class="line">        members0_.team_id as team_id4_0_1_,</span><br><span class="line">        members0_.userName as userName3_0_1_ </span><br><span class="line">    from</span><br><span class="line">        Member members0_ </span><br><span class="line">    where</span><br><span class="line">        members0_.team_id&#x3D;?</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br></pre></td></tr></table></figure>

<p>[Q2] 컬렉션 조인을 페치하면 어떻게 될까?<br>–&gt; 쿼리는 fetch가 되서 한방쿼리가 되었지만, distinct처리 안해서 중복 엔티티 row발생함. </p>
<figure class="highlight java"><figcaption><span>컬렉션조인시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select t from Team t join fetch t.members&quot;</span>, Team.class)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션조인결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        t </span><br><span class="line">    from</span><br><span class="line">        Team t </span><br><span class="line">    join</span><br><span class="line">        fetch t.members *&#x2F; select</span><br><span class="line">            team0_.team_id as team_id1_3_0_,</span><br><span class="line">            members1_.member_id as member_i1_0_1_,</span><br><span class="line">            team0_.name as name2_3_0_,</span><br><span class="line">            members1_.age as age2_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_1_,</span><br><span class="line">            members1_.userName as userName3_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_0__,</span><br><span class="line">            members1_.member_id as member_i1_0_0__ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ </span><br><span class="line">        inner join</span><br><span class="line">            Member members1_ </span><br><span class="line">                on team0_.team_id&#x3D;members1_.team_id</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2 &#x2F;&#x2F;fetch를하면 쿼리는 줄지만 distinct를 처리하지 않았기때문에 여전히 중복 발생 </span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br></pre></td></tr></table></figure>

<p>[Q3] 위 쿼리에서 distinct를 걸면 해결되나?<br>–&gt; 해결됨</p>
<figure class="highlight java"><figcaption><span>컬렉션페치조인 distinct처리</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select distinct t from Team t join fetch t.members&quot;</span>, Team.class)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션페치조인 distinct처리결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        distinct t </span><br><span class="line">    from</span><br><span class="line">        Team t </span><br><span class="line">    join</span><br><span class="line">        fetch t.members *&#x2F; select</span><br><span class="line">            distinct team0_.team_id as team_id1_3_0_,</span><br><span class="line">            members1_.member_id as member_i1_0_1_,</span><br><span class="line">            team0_.name as name2_3_0_,</span><br><span class="line">            members1_.age as age2_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_1_,</span><br><span class="line">            members1_.userName as userName3_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_0__,</span><br><span class="line">            members1_.member_id as member_i1_0_0__ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ </span><br><span class="line">        inner join</span><br><span class="line">            Member members1_ </span><br><span class="line">                on team0_.team_id&#x3D;members1_.team_id</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br></pre></td></tr></table></figure>

<p>[Q4] 컬렉션 페치 조인해서 페이징 적용하면 어떻게되나?<br>–&gt; 페이징 로직이 미적용되고, 메모리에 해당 엔티티들의 모든 row가 다 적재됨. (메모리 부하 발생 성능 다운됨.)</p>
<figure class="highlight java"><figcaption><span>컬렉션페치조인 페이징처리시도</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select distinct t from Team t join fetch t.members&quot;</span>, Team.class)</span><br><span class="line">                .setFirstResult(<span class="number">0</span>)</span><br><span class="line">                .setMaxResults(<span class="number">2</span>)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션페치조인 페이징적용결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        distinct t </span><br><span class="line">    from</span><br><span class="line">        Team t </span><br><span class="line">    join</span><br><span class="line">        fetch t.members *&#x2F; select</span><br><span class="line">            distinct team0_.team_id as team_id1_3_0_,</span><br><span class="line">            members1_.member_id as member_i1_0_1_,</span><br><span class="line">            team0_.name as name2_3_0_,</span><br><span class="line">            members1_.age as age2_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_1_,</span><br><span class="line">            members1_.userName as userName3_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_0__,</span><br><span class="line">            members1_.member_id as member_i1_0_0__ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ </span><br><span class="line">        inner join</span><br><span class="line">            Member members1_ </span><br><span class="line">                on team0_.team_id&#x3D;members1_.team_id &#x2F;&#x2F;페이징 처리 로직 미적용됨. </span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;메모리 다 적재됫다고 경고떳음</span><br><span class="line">5월 08, 2021 3:11:40 오후 org.hibernate.hql.internal.ast.QueryTranslatorImpl list</span><br><span class="line">WARN: HHH000104: firstResult&#x2F;maxResults specified with collection fetch; applying in memory!</span><br><span class="line">5월 08, 2021 3:11:40 오후 org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl$PoolState stop</span><br><span class="line">INFO: HHH10001008: Cleaning up connection pool [jdbc:h2:tcp:&#x2F;&#x2F;localhost&#x2F;~&#x2F;jpqlshop]</span><br></pre></td></tr></table></figure>

<p>–&gt; 페이징을 강제로 해결하려면 페치조인 걸었던것 제거하고 Team.members에 @BatchSize를 걸던지, 혹은 글로벌 설정에서 persistence.xml혹은 application.yml등에서 batchsize를 설정해야함. 보통 글로벌 설정으로 설정하고 시작한다고함. </p>
<figure class="highlight java"><figcaption><span>컬렉션페치조인 페이징처리 batchsize적용상태</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/////// Team.java /////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@BatchSize(size = 100)</span></span><br><span class="line"><span class="meta">@OneToMany(mappedBy = &quot;team&quot;)</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Member&gt; members = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">///////// 구분 /////////////</span></span><br><span class="line"></span><br><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select distinct t from Team t&quot;</span>, Team.class)</span><br><span class="line">                .setFirstResult(<span class="number">0</span>)</span><br><span class="line">                .setMaxResults(<span class="number">2</span>)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션페치조인 페이징적용결과-batchsize적용했을때</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        distinct t </span><br><span class="line">    from</span><br><span class="line">        Team t *&#x2F; select</span><br><span class="line">            distinct team0_.team_id as team_id1_3_,</span><br><span class="line">            team0_.name as name2_3_ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ limit ?</span><br><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* load one-to-many entity.Team.members *&#x2F; select</span><br><span class="line">        members0_.team_id as team_id4_0_1_,</span><br><span class="line">        members0_.member_id as member_i1_0_1_,</span><br><span class="line">        members0_.member_id as member_i1_0_0_,</span><br><span class="line">        members0_.age as age2_0_0_,</span><br><span class="line">        members0_.team_id as team_id4_0_0_,</span><br><span class="line">        members0_.userName as userName3_0_0_ </span><br><span class="line">    from</span><br><span class="line">        Member members0_ </span><br><span class="line">    where</span><br><span class="line">        members0_.team_id in (</span><br><span class="line">            ?, ?</span><br><span class="line">        )</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br></pre></td></tr></table></figure>

<h3 id="2-4-페치조인과-일반조인의-차이"><a href="#2-4-페치조인과-일반조인의-차이" class="headerlink" title="2-4. 페치조인과 일반조인의 차이"></a>2-4. 페치조인과 일반조인의 차이</h3><h4 id="일반-조인"><a href="#일반-조인" class="headerlink" title="일반 조인"></a>일반 조인</h4><ul>
<li>일반조인 실행시 연관된 엔티티를 함께 조회 안함 </li>
<li>[JPQL]<ul>
<li>select t from Team t join t.members m where t.name = ‘팀A’</li>
</ul>
</li>
<li>[SQL]<ul>
<li>SELECT T.* FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID  WHERE T.NAME = ‘팀A’</li>
</ul>
</li>
<li>JPQL은 결과를 반환할때 연관관계 고려안함</li>
<li>단지 select절에 지정한 엔티티만 조회한다.</li>
<li>따라서 Team엔티티만 조회할뿐, Member정보는 조회 안함</li>
</ul>
<h4 id="페치-조인"><a href="#페치-조인" class="headerlink" title="페치 조인"></a>페치 조인</h4><ul>
<li>페치 조인을 사용할때만 연관된 엔티티도 함께 조회 (즉시로딩됨)</li>
<li>페치 조인은 객체 그래프를 SQL한번에 조회하는 개념 </li>
<li>페치 조인은 연관된 엔티티를 함께 조회함</li>
<li>[JPQL]<ul>
<li>select t from Team t join fetch t.members where t.name = ‘팀A’</li>
</ul>
</li>
<li>[SQL]<ul>
<li>SELECT T.<em>, M.</em> FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID WHERE T.NAME = ‘팀A’</li>
</ul>
</li>
</ul>
<h3 id="2-5-페치-조인의-특징-과-한계"><a href="#2-5-페치-조인의-특징-과-한계" class="headerlink" title="2-5. 페치 조인의 특징 과 한계"></a>2-5. 페치 조인의 특징 과 한계</h3><ul>
<li>페치 조인 대상에서는 별칭을 줄수없다. (하이버네이트는 가능하지만 가급적 사용하지 말자)</li>
<li>둘 이상의 컬렉션은 페치 조인 할수 없다. (1:N:M의 관계로 가져오기때문에 관련된 모든 정보를 끌고오기때문에)</li>
<li>컬렉션을 페치조인하면 페이징 API를 사용할수 없다. <ul>
<li>1:1, N:1 같은 단일 값 연관 필드들은 페치 조인해도 페이징 가능 </li>
<li>1:N, N:M 같은 컬렉션은 강제로 페이징처리를 하면 페이징로직이 무시되고 해당 엔티티에 있는 모든 정보를 다 끌고옴. (하이버네이트에서 경고 로그 남기고 모든 row를 메모리에 올리는 불상사가 벌어짐.)</li>
<li>컬렉션은 그럼 페이징을 못하는가? 컬렉션 상태에서는 아니고 fetch join한 부분을 지우고 @BatchSize혹은 글로벌설정에서 batchsize를 설정하고 조회하면 페이징 처리는 가능 하지만 N+1을 완벽하게 해소되지 않은 상태지만 성능에는 큰 도움이됨. </li>
</ul>
</li>
<li>연관된 엔티티들을 SQL한번으로 조회 -&gt; 성능 최적화 </li>
<li>엔티티에 직접 적용하는 글로벌 로딩 전략보다 우선함 </li>
<li>실무에서는 글로벌 로딩전략은 모두 지연로딩으로 걸어두자</li>
<li>최적화 필요한곳만 페치 조인 적용 </li>
<li>페치조인을 사용해서 연관된 엔티티를 쿼리시점에 조회해서 지연로딩이 발생하지 않는데, 이때 준영속상태에서도 객체그래프를 탐색할수있다. 왜냐 1차캐시에 올라갔기때문에 </li>
</ul>
<h3 id="2-6-페치조인-정리"><a href="#2-6-페치조인-정리" class="headerlink" title="2-6. 페치조인 정리"></a>2-6. 페치조인 정리</h3><ul>
<li>모든것을 페치 조인으로 해결이 안될때가 있음. </li>
<li>페치 조인은 객체 그래프를 유지할때 사용하면 효과적 </li>
<li>여러 테이블을 조인해서 엔티티가 가진 모양이 아닌 전혀 다른 결과를 내야하면, 페치조인보다 일반 조인을 사용하고 필요한 데이터들만 프로젝션해서 DTO로 반환하는 것이 효과적</li>
</ul>
<h2 id="3-다형성-쿼리"><a href="#3-다형성-쿼리" class="headerlink" title="3. 다형성 쿼리"></a>3. 다형성 쿼리</h2><h3 id="3-1-TYPE"><a href="#3-1-TYPE" class="headerlink" title="3-1. TYPE"></a>3-1. TYPE</h3><ul>
<li>조회 대상을 특정 자식으로 한정 </li>
<li>예) 위 예제중 Item중에 Book, Movie를 조회해라</li>
<li>[JPQL]<ul>
<li>select i from Item i where type(i) IN (Book, Movie)</li>
</ul>
</li>
<li>[SQL]<ul>
<li>select i from i where i.DTYPE in (‘B’, ‘M’)</li>
</ul>
</li>
</ul>
<h3 id="3-2-TREAT-JPA-2-1"><a href="#3-2-TREAT-JPA-2-1" class="headerlink" title="3-2. TREAT (JPA 2.1)"></a>3-2. TREAT (JPA 2.1)</h3><ul>
<li>자바의 타입 캐스팅과 유사</li>
<li>상속 구조에서 부모타입을 특정 자식 타입으로 다룰때 사용 </li>
<li>FROM, WHERE, SELECT(하이버네이트 지원) 사용</li>
<li>예) 부모인 Item과 자식 Book이 있다.</li>
<li>[JPQL]<ul>
<li>select i from Item i where treat(i as Book).auther = ‘kim’</li>
</ul>
</li>
<li>[SQL]<ul>
<li>select i.* from Item i where i.DTYPE = ‘B’ and i.auther = ‘kim’</li>
</ul>
</li>
</ul>
<h2 id="4-엔티티-직접-사용"><a href="#4-엔티티-직접-사용" class="headerlink" title="4. 엔티티 직접 사용"></a>4. 엔티티 직접 사용</h2><p><img src="/images/jpa/jpql-15.png" alt="엔티티직접사용 예시"></p>
<ul>
<li>JPQL에서 엔티티를 직접 사용하면 SQL에서 해당 엔티티의 기 본 키 값을 사용</li>
<li>[JPQL]<ul>
<li>select count(m.id) from Member m //엔티티의 아이디를 사용</li>
<li>select count(m) from Member m //엔티티를 직접 사용</li>
</ul>
</li>
<li>[SQL] (JPQL 둘다 같은 다음 SQL 실행)<ul>
<li>select count(m.id) as cnt from Member m</li>
</ul>
</li>
</ul>
<p><img src="/images/jpa/jpql-16.png" alt="엔티티직접사용 기본키예시"><br><img src="/images/jpa/jpql-17.png" alt="엔티티직접사용 외래키예시"></p>
<h2 id="5-Named-쿼리"><a href="#5-Named-쿼리" class="headerlink" title="5. Named 쿼리"></a>5. Named 쿼리</h2><h3 id="5-1-Named쿼리-정적-쿼리"><a href="#5-1-Named쿼리-정적-쿼리" class="headerlink" title="5-1. Named쿼리 - 정적 쿼리"></a>5-1. Named쿼리 - 정적 쿼리</h3><ul>
<li>미리 정의해서 이름을 부여해두고 사용하는 JPQL</li>
<li>정적 쿼리</li>
<li>어노테이션, XML지원</li>
<li>애플리케이션 로딩 시점에 초기화 후 재사용 </li>
<li>애플리케이션 로딩 시점에 쿼리를 검증해줌 </li>
</ul>
<h3 id="5-2-Named쿼리-어노테이션-사용-방법"><a href="#5-2-Named쿼리-어노테이션-사용-방법" class="headerlink" title="5-2. Named쿼리 - 어노테이션 사용 방법"></a>5-2. Named쿼리 - 어노테이션 사용 방법</h3><p><img src="/images/jpa/jpql-18.png" alt="Named쿼리 어노테이션예시"></p>
<h3 id="5-3-Named쿼리-XML-사용방법"><a href="#5-3-Named쿼리-XML-사용방법" class="headerlink" title="5-3. Named쿼리 - XML 사용방법"></a>5-3. Named쿼리 - XML 사용방법</h3><p><img src="/images/jpa/jpql-19.png" alt="Named쿼리 XML예시"></p>
<h3 id="5-4-Named쿼리-환경에-따른-설정"><a href="#5-4-Named쿼리-환경에-따른-설정" class="headerlink" title="5-4. Named쿼리 환경에 따른 설정"></a>5-4. Named쿼리 환경에 따른 설정</h3><ul>
<li>XML이 항상 우선권을 가짐 </li>
<li>애플리케이션 운영 환경에 따라 다른 XML을 배포할수있다. </li>
</ul>
<h2 id="6-JPQL-벌크연산"><a href="#6-JPQL-벌크연산" class="headerlink" title="6. JPQL - 벌크연산"></a>6. JPQL - 벌크연산</h2><p><img src="/images/jpa/jpql-20.png" alt="벌크연산"><br><img src="/images/jpa/jpql-21.png" alt="벌크연산 예시"></p>
<h3 id="6-1-벌크연산시-주의"><a href="#6-1-벌크연산시-주의" class="headerlink" title="6-1. 벌크연산시 주의"></a>6-1. 벌크연산시 주의</h3><ul>
<li>벌크 연산은 영속성 컨텍스트를 무시하고 DB에 직접 쿼리 (JPQL로 사용하니 당연한 부분)<ul>
<li>벌크 연산을 먼저 실행 </li>
<li>벌크 연산 수행 후 영속성 컨텍스트 초기화 </li>
</ul>
</li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/08/jpa-obj-query-2/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/07/jpa-obj-query-1/"
                            aria-label=": jpa-obj-query-1"
                        >
                            jpa-obj-query-1
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-07T11:42:32+00:00">
	
		    May 07, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5%EC%BF%BC%EB%A6%AC%EC%96%B8%EC%96%B4/">객체지향쿼리언어</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="객체지향-쿼리-언어"><a href="#객체지향-쿼리-언어" class="headerlink" title="객체지향 쿼리 언어"></a>객체지향 쿼리 언어</h1><p>JPA는 다양한 쿼리 방법을 지원한다. JPQL,JPA Criteria, QueryDSL, 네이티브 SQL, JDBC API/MyBatis등과 같은 외부라이브러리 사용등<br>하지만 결론적으로 실무에서 자주 사용할것은, JPQL/QueryDSL 일것이다. 따라서 JPQL/QueryDSL 위주로 정리하도록 한다. </p>
<h2 id="1-JPQL"><a href="#1-JPQL" class="headerlink" title="1. JPQL"></a>1. JPQL</h2><h3 id="1-1-JPQL-특징"><a href="#1-1-JPQL-특징" class="headerlink" title="1-1. JPQL 특징"></a>1-1. JPQL 특징</h3><ul>
<li>JPQL은 객체지향 쿼리 언어이다. 따라서 테이블을 대상으로 쿼리하는것이 아니라, <strong>엔티티 객체를 대상</strong> 으로 쿼리한다.</li>
<li>JPQL은 SQL을 추상화해서 특정 데이터베이스 SQL에 의존하지 않는다. (여러 DB방언 지원 및 ANSI표준까지 지원)</li>
<li>JPQL의 종착지는 SQL이다. SQL로 결국 변환됨.</li>
</ul>
<p><img src="/images/jpa/jpql-1.png" alt="실습 샘플 모델"></p>
<h3 id="1-2-JPQL-기본-문법"><a href="#1-2-JPQL-기본-문법" class="headerlink" title="1-2. JPQL 기본 문법"></a>1-2. JPQL 기본 문법</h3><p><img src="/images/jpa/jpql-2.png" alt="JPQL기본문법 구조1"></p>
<ul>
<li>엔티티와 속성은 대소문자 구분함. </li>
<li>jpql 키워드는 대소문자 구분안함.</li>
<li>반드시 엔티티 이름으로 사용해야함. (테이블이름 안됨)</li>
<li>별칭은 필수! </li>
</ul>
<p><img src="/images/jpa/jpql-3.png" alt="JPQL기본문법 구조2"><br><img src="/images/jpa/jpql-4.png" alt="JPQL기본문법 구조3"></p>
<figure class="highlight java"><figcaption><span>jpql-basic-1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; members = entityManager.createQuery(<span class="string">&quot;select m from Member m&quot;</span>, Member.class)</span><br><span class="line">               .getResultList();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>jpql-basic-2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; paramResult = entityManager.createQuery(<span class="string">&quot;select m from Member m where m.userName = :userName&quot;</span>, Member.class)</span><br><span class="line">               .setParameter(<span class="string">&quot;userName&quot;</span>,<span class="string">&quot;m2&quot;</span>)</span><br><span class="line">               .getResultList();</span><br></pre></td></tr></table></figure>

<p>[주의] 아래와 같이 쿼리 짜지 말자! </p>
<figure class="highlight java"><figcaption><span>jpql-basic-3</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//이런식으로 쿼리짜지말자. join걸어서 가져오는걸로 (가독성이 떨어짐 비추 무조건 명시적조인을 하자)</span></span><br><span class="line"><span class="comment">//그리고 JPQL에서는 fetch상태 자체가 무시됨.(LAZY로 걸어도 그냥 조인됨)</span></span><br><span class="line">List&lt;Team&gt; teams = entityManager.createQuery(<span class="string">&quot;select m.team from Member m&quot;</span>, Team.class)</span><br><span class="line">               				.getResultList();</span><br></pre></td></tr></table></figure>

<h3 id="1-3-프로젝션"><a href="#1-3-프로젝션" class="headerlink" title="1-3. 프로젝션"></a>1-3. 프로젝션</h3><p><img src="/images/jpa/jpql-5.png" alt="JPQL프로젝션"><br><img src="/images/jpa/jpql-6.png" alt="JPQL프로젝션-여러값조회"></p>
<p>[참고]</p>
<ul>
<li>엔티티프로젝션은 Persistance Context에 관리된다.</li>
<li>임베디드타입은 엔티티 타입이 아닌 값타입이다. 따라서 직접 조회한 값타입인 임베디드타입은 Persistance Context에 관리되지않는다.</li>
</ul>
<figure class="highlight java"><figcaption><span>jpql-projection</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MemberInfo&gt; memberInfos = entityManager</span><br><span class="line">                .createQuery(<span class="string">&quot;select new entity.MemberInfo(m.userName,m.age) from Member m&quot;</span>, MemberInfo.class)</span><br><span class="line">                .getResultList();</span><br></pre></td></tr></table></figure>

<h3 id="1-4-페이징-API"><a href="#1-4-페이징-API" class="headerlink" title="1-4. 페이징 API"></a>1-4. 페이징 API</h3><p>JPA의 페이징은 여러 DB방언의 페이징처리를 추상화 되어있다.</p>
<ul>
<li>setFirstResult(int startPosition) : 조회 시작 위치 (0부터시작)</li>
<li>setMaxResults(int maxResult) : 조회할 데이터수 </li>
</ul>
<figure class="highlight java"><figcaption><span>jpql-paging</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; memberList = entityManager.createQuery(<span class="string">&quot;select m from Member m join fetch m.team t order by m.age desc&quot;</span>, Member.class)</span><br><span class="line">                .setFirstResult(<span class="number">0</span>)</span><br><span class="line">                .setMaxResults(<span class="number">20</span>)</span><br><span class="line">                .getResultList();</span><br></pre></td></tr></table></figure>

<h3 id="1-5-조인"><a href="#1-5-조인" class="headerlink" title="1-5. 조인"></a>1-5. 조인</h3><p>기본적인 inner join / left (outer) join / cross join (세타조인) 이 지원된다. 기본적인 ANSI표준 join이 그대로 지원된다고 생각하면됨.</p>
<h4 id="조인-ON절"><a href="#조인-ON절" class="headerlink" title="조인 - ON절"></a>조인 - ON절</h4><ol>
<li>조인 대상 필터링<ul>
<li>SELECT m, t FROM Member m LEFT JOIN m.team t on t.name = ‘A’</li>
<li>위 쿼리처럼 ON 절 뒤에 join하면서 필터작업을 미리 할수있는 기능  </li>
</ul>
</li>
<li>연관관계 없는 엔티티 외부 조인 (하이버네이트 5.1부터가능)<ul>
<li>보통 키값으로 조인을 하지만 전혀 관계없는 부분도 조인조건에 넣을수있음.</li>
<li>SELECT m, t FROM Member m LEFT JOIN Team t on m.username = t.name</li>
</ul>
</li>
</ol>
<h3 id="1-6-서브쿼리"><a href="#1-6-서브쿼리" class="headerlink" title="1-6. 서브쿼리"></a>1-6. 서브쿼리</h3><p><img src="/images/jpa/jpql-7.png" alt="JPQL서브쿼리"></p>
<figure class="highlight sql"><figcaption><span>서브쿼리-1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#나이가 평균보다 많은 회원 </span><br><span class="line"><span class="keyword">select</span> m <span class="keyword">from</span> <span class="keyword">Member</span> m </span><br><span class="line"><span class="keyword">where</span> m.age <span class="operator">&gt;</span> (<span class="keyword">select</span> <span class="built_in">avg</span>(m2.age) <span class="keyword">from</span> <span class="keyword">Member</span> m2) </span><br><span class="line"></span><br><span class="line">#한건이라도주문한고객</span><br><span class="line"><span class="keyword">select</span> m <span class="keyword">from</span> <span class="keyword">Member</span> m</span><br><span class="line"><span class="keyword">where</span> (<span class="keyword">select</span> <span class="built_in">count</span>(o) <span class="keyword">from</span> <span class="keyword">Order</span> o <span class="keyword">where</span> m <span class="operator">=</span> o.member) <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#팀A 소속인 회원</span><br><span class="line"><span class="keyword">select</span> m <span class="keyword">from</span> <span class="keyword">Member</span> m</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> t <span class="keyword">from</span> m.team t <span class="keyword">where</span> t.name <span class="operator">=</span> ‘팀A<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#전체 상품 각각의 재고보다 주문량이 많은 주문들</span></span><br><span class="line"><span class="string">select o from Order o </span></span><br><span class="line"><span class="string">where o.orderAmount &gt; ALL (select p.stockAmount from Product p)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#어떤 팀이든 팀에 소속된 회원</span></span><br><span class="line"><span class="string">select m from Member m </span></span><br><span class="line"><span class="string">where m.team = ANY (select t from Team t)</span></span><br></pre></td></tr></table></figure>

<h4 id="JPA-서브쿼리-한계"><a href="#JPA-서브쿼리-한계" class="headerlink" title="JPA 서브쿼리 한계"></a>JPA 서브쿼리 한계</h4><ul>
<li>JPA는 WHERE/HAVING절만 서브쿼리 사용가능 </li>
<li>하이버네이트에서는 SELECT절에서 서브쿼리 사용가능</li>
<li>FROM 절 서브쿼리는 현재 JPQL에서는 불가능 <ul>
<li>조인으로 풀수있으면 해결하고 그래도 안되면 쿼리를 쪼개서 처리하거나 그래도 안되면 native쿼리로 처리 해야함. </li>
</ul>
</li>
</ul>
<h3 id="1-7-JPQL-타입표현"><a href="#1-7-JPQL-타입표현" class="headerlink" title="1-7. JPQL 타입표현"></a>1-7. JPQL 타입표현</h3><h4 id="JPQL-타입-표현"><a href="#JPQL-타입-표현" class="headerlink" title="JPQL 타입 표현"></a>JPQL 타입 표현</h4><ul>
<li>문자: ‘HELLO’, ‘She’’s’ </li>
<li>Boolean: TRUE, FALSE</li>
<li>숫자: 10L(Long), 10D(Double), 10F(Float)</li>
<li>ENUM: jpabook.MemberType.Admin (패키지명 포함) </li>
<li>엔티티 타입: TYPE(m) = Member (상속 관계에서 사용)</li>
</ul>
<h4 id="JPQL-논리연산-및-비교연산"><a href="#JPQL-논리연산-및-비교연산" class="headerlink" title="JPQL 논리연산 및 비교연산"></a>JPQL 논리연산 및 비교연산</h4><ul>
<li>EXISTS, IN</li>
<li>AND, OR, NOT</li>
<li>=, &gt;, &gt;=, &lt;, &lt;=, &lt;&gt; BETWEEN, LIKE, IS NULL</li>
</ul>
<h4 id="JPQL-연산자-우선순위"><a href="#JPQL-연산자-우선순위" class="headerlink" title="JPQL 연산자 우선순위"></a>JPQL 연산자 우선순위</h4><ol>
<li>경로탐색연산(.)</li>
<li>수학연산 : 단항연산자(+,-),*,/,+,-</li>
<li>비교연산 : =,&gt;,&gt;=,&lt;,&lt;=,&lt;&gt;(다름),BETWEEN,LIKE,IN,IS NULL,IS EMPTY,EXIST </li>
<li>논리연산 : AND,OR,NOT</li>
</ol>
<h3 id="1-8-CASE-식"><a href="#1-8-CASE-식" class="headerlink" title="1-8. CASE 식"></a>1-8. CASE 식</h3><p><img src="/images/jpa/jpql-8.png" alt="CASE1"><br><img src="/images/jpa/jpql-9.png" alt="COALESCE/NULLIF"></p>
<h3 id="1-9-기본함수"><a href="#1-9-기본함수" class="headerlink" title="1-9. 기본함수"></a>1-9. 기본함수</h3><ul>
<li>concat, substring, trim, lower/upper, length, locate, abs, sqrt, mod, size, index(jpq전용)</li>
</ul>
<h4 id="사용자-정의-함수"><a href="#사용자-정의-함수" class="headerlink" title="사용자 정의 함수"></a>사용자 정의 함수</h4><p><img src="/images/jpa/jpql-10.png" alt="사용자정의함수"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/07/jpa-obj-query-1/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/07/jpa-querydsl-1/"
                            aria-label=": jpa-querydsl-1"
                        >
                            jpa-querydsl-1
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-07T04:24:52+00:00">
	
		    May 07, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/QueryDSL/">QueryDSL</a>, <a class="category-link" href="/categories/Spring-Boot/">Spring Boot</a>, <a class="category-link" href="/categories/Spring-Data-JPA/">Spring Data JPA</a>, <a class="category-link" href="/categories/%EC%9C%A0%EB%A0%88%EC%B9%B4or%EC%82%BD%EC%A7%88/">유레카or삽질</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="QueryDSL-간단-사용법-정리-Spring-Data-JPA"><a href="#QueryDSL-간단-사용법-정리-Spring-Data-JPA" class="headerlink" title="QueryDSL 간단 사용법 정리 (+ Spring Data JPA)"></a>QueryDSL 간단 사용법 정리 (+ Spring Data JPA)</h1><h2 id="1-QueryDSL-사전-세팅-및-설정"><a href="#1-QueryDSL-사전-세팅-및-설정" class="headerlink" title="1. QueryDSL 사전 세팅 및 설정"></a>1. QueryDSL 사전 세팅 및 설정</h2><h3 id="1-1-build-gradle"><a href="#1-1-build-gradle" class="headerlink" title="1-1. build.gradle"></a>1-1. build.gradle</h3><figure class="highlight plain"><figcaption><span>domain/build.gradle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">bootJar&#123;</span><br><span class="line">    enabled &#x3D; false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jar &#123;</span><br><span class="line">    enabled &#x3D; true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    ext &#123;</span><br><span class="line">        querydslPluginVersion &#x3D; &#39;1.0.10&#39;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123; url &quot;https:&#x2F;&#x2F;plugins.gradle.org&#x2F;m2&#x2F;&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-web&#39;)</span><br><span class="line"></span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-jdbc&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-data-jpa&#39;)</span><br><span class="line"></span><br><span class="line">    compile(&quot;com.querydsl:querydsl-core&quot;) &#x2F;&#x2F; querydsl</span><br><span class="line">    compile(&quot;com.querydsl:querydsl-jpa&quot;) &#x2F;&#x2F; querydsl</span><br><span class="line">    annotationProcessor &quot;com.querydsl:querydsl-apt:$&#123;dependencyManagement.importedProperties[&#39;querydsl.version&#39;]&#125;:jpa&quot; 		&#x2F;&#x2F; querydsl JPAAnnotationProcessor 사용 지정</span><br><span class="line"></span><br><span class="line">    annotationProcessor(&quot;jakarta.persistence:jakarta.persistence-api&quot;)</span><br><span class="line">    annotationProcessor(&quot;jakarta.annotation:jakarta.annotation-api&quot;)</span><br><span class="line"></span><br><span class="line">    runtime &#39;org.hibernate:hibernate-entitymanager&#39;</span><br><span class="line">    runtime &#39;mysql:mysql-connector-java&#39;</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; 나머지 의존관리 생략</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;* querydsl *&#x2F;</span><br><span class="line">&#x2F;&#x2F; compileJava 빌드시 생성되는 폴더 </span><br><span class="line">def generated&#x3D;&#39;src&#x2F;main&#x2F;generated&#39;</span><br><span class="line">sourceSets &#123;</span><br><span class="line">    main.java.srcDirs +&#x3D; [ generated ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    options.annotationProcessorGeneratedSourcesDirectory &#x3D; file(generated)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;generated된 폴더내 내용물 제거 (초기화 처리)</span><br><span class="line">clean.doLast &#123;</span><br><span class="line">    file(generated).deleteDir()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-application-yml-설정"><a href="#1-2-application-yml-설정" class="headerlink" title="1-2. application.yml 설정"></a>1-2. application.yml 설정</h3><p>application.yml은 domain쪽 모듈에 존재하는것이 아니라, api모듈에 존재하는것이 특징이다. </p>
<figure class="highlight plain"><figcaption><span>api/application.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  output:</span><br><span class="line">    ansi:</span><br><span class="line">      enabled: always</span><br><span class="line"></span><br><span class="line">  sleuth:</span><br><span class="line">    rxjava.schedulers.hook.enabled: false</span><br><span class="line">    enabled: false</span><br><span class="line">  zipkin:</span><br><span class="line">    enabled: false</span><br><span class="line"></span><br><span class="line">  jpa:</span><br><span class="line">    database-platform: org.hibernate.dialect.MySQL5InnoDBDialect</span><br><span class="line">    open-in-view: false</span><br><span class="line">    properties:</span><br><span class="line">      hibernate:</span><br><span class="line">        format_sql: true</span><br><span class="line">        show_sql: true</span><br><span class="line">        use_sql_comments: true</span><br><span class="line">        id:</span><br><span class="line">          new_generator_mappings: false</span><br><span class="line"></span><br><span class="line">        order_inserts: true</span><br><span class="line">        order_updates: true</span><br><span class="line">        jdbc:</span><br><span class="line">          batch_size: 1000</span><br><span class="line">    generate-ddl: false</span><br><span class="line"></span><br><span class="line">  datasource:</span><br><span class="line">    escrow-master:</span><br><span class="line">      driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">      jdbc-url: jdbc:mysql:&#x2F;&#x2F;1.17.0.193:3306&#x2F;wmp_escrow?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;connectionCollation&#x3D;utf8_bin&amp;characterSetResults&#x3D;utf8&amp;autoReconnect&#x3D;true&amp;serverTimezone&#x3D;Asia&#x2F;Seoul&amp;useSSL&#x3D;false&amp;zeroDateTimeBehavior&#x3D;convertToNull</span><br><span class="line">      username: app_escrow</span><br><span class="line">      password: 5Z9pjgBw3Pj1RMrVLQYv</span><br><span class="line">      maximum-pool-size: 10</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      connection-timeout: 5000 # ms</span><br><span class="line">      validation-timeout: 5000 # ms</span><br><span class="line">      max-lifetime: 55000 # ms, mysql wait_timeout is 60s. idleTimeout is close to or more than maxLifetime, disabling it.</span><br><span class="line">      transaction-isolation: TRANSACTION_READ_COMMITTED</span><br><span class="line">      pool-name: escrowMaster-db-pool</span><br><span class="line">      data-source-properties:</span><br><span class="line">        cachePrepStmts: true  # dbcp2의 pool-prepared-statements: true와 동일한 설정</span><br><span class="line">        prepStmtCacheSize: 50 # 기존 설정은 무제한이었으나 connection당 생성되므로 너무 크게 섫정하면 OOM이 발생할 수 있다.</span><br><span class="line">        prepStmtCacheSqlLimit: 2048 # sql 문장의 크기제한</span><br><span class="line"></span><br><span class="line">    escrow-slave:</span><br><span class="line">      driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">      jdbc-url: jdbc:mysql:&#x2F;&#x2F;1.17.0.193:3306&#x2F;wmp_escrow?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;connectionCollation&#x3D;utf8_bin&amp;characterSetResults&#x3D;utf8&amp;autoReconnect&#x3D;true&amp;serverTimezone&#x3D;Asia&#x2F;Seoul&amp;useSSL&#x3D;false&amp;zeroDateTimeBehavior&#x3D;convertToNull</span><br><span class="line">      username: app_escrow</span><br><span class="line">      password: 5Z9pjgBw3Pj1RMrVLQYv</span><br><span class="line">      maximum-pool-size: 10</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      connection-timeout: 5000 # ms</span><br><span class="line">      validation-timeout: 5000 # ms</span><br><span class="line">      max-lifetime: 55000 # ms, mysql wait_timeout is 60s. idleTimeout is close to or more than maxLifetime, disabling it.</span><br><span class="line">      transaction-isolation: TRANSACTION_READ_COMMITTED</span><br><span class="line">      pool-name: escorwSlave-db-pool</span><br><span class="line">      data-source-properties:</span><br><span class="line">        cachePrepStmts: true  # dbcp2의 pool-prepared-statements: true와 동일한 설정</span><br><span class="line">        prepStmtCacheSize: 50 # 기존 설정은 무제한이었으나 connection당 생성되므로 너무 크게 섫정하면 OOM이 발생할 수 있다.</span><br><span class="line">        prepStmtCacheSqlLimit: 2048 # sql 문장의 크기제한</span><br></pre></td></tr></table></figure>

<p>위 application.yml에서는 master/slave로 구성된 mysql 디비이며, 추가적인 멀디DB구성도 설정 할수 있다.</p>
<h3 id="1-3-Application-java"><a href="#1-3-Application-java" class="headerlink" title="1-3. Application.java"></a>1-3. Application.java</h3><figure class="highlight java"><figcaption><span>api/Application.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.VOcsDomain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses = &#123;VOcsApi.class, VOcsDomain.class&#125;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VOcsApiApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(VOcsApiApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">개별적인 DataSource세팅을 위해서 기존 자동설정 하는 Config제거 했음. </span><br></pre></td></tr></table></figure>

<h3 id="1-4-DBConfig-설정"><a href="#1-4-DBConfig-설정" class="headerlink" title="1-4. DBConfig 설정"></a>1-4. DBConfig 설정</h3><figure class="highlight java"><figcaption><span>domain/DBConfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.google.common.collect.Maps.newHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.configuration.db.DBConstant.Escrow;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.repository.escrow.EscrowRepository;</span><br><span class="line"><span class="keyword">import</span> com.zaxxer.hikari.HikariDataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManagerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.orm.jpa.EntityManagerFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AdviceMode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.LazyConnectionDataSourceProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackageClasses = EscrowRepository.class, entityManagerFactoryRef = &quot;escrowEntityManagerFactory&quot;)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true, mode = AdviceMode.PROXY)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EscrowDBConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.escrow-master&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">escrowMasterDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().type(HikariDataSource.class).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.escrow-slave&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">escrowSlaveDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().type(HikariDataSource.class).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">escrowNamedRoutingDataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;escrowMasterDataSource&quot;)</span> DataSource master, <span class="meta">@Qualifier(&quot;escrowSlaveDataSource&quot;)</span> DataSource slave)</span> </span>&#123;</span><br><span class="line">        NamedRoutingDataSource namedRoutingDataSource = <span class="keyword">new</span> NamedRoutingDataSource();</span><br><span class="line">        Map&lt;Object, Object&gt; datasourceMap = newHashMap();</span><br><span class="line">        datasourceMap.put(<span class="string">&quot;master&quot;</span>,master);</span><br><span class="line">        datasourceMap.put(<span class="string">&quot;slave&quot;</span>,slave);</span><br><span class="line">        namedRoutingDataSource.setTargetDataSources(datasourceMap);</span><br><span class="line">        namedRoutingDataSource.setDefaultTargetDataSource(master);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> namedRoutingDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">escrowDataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;escrowNamedRoutingDataSource&quot;)</span> DataSource namedRoutingDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyConnectionDataSourceProxy(namedRoutingDataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EntityManagerFactoryBuilder <span class="title">escrowEntityManagerFactoryBuilder</span><span class="params">(<span class="meta">@Qualifier(&quot;jpaProperties&quot;)</span> Map&lt;String,String&gt; jpaProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntityManagerFactoryBuilder(<span class="keyword">new</span> HibernateJpaVendorAdapter(), jpaProperties, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;escrowEntityManagerFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">escrowEntityManagerFactory</span><span class="params">(<span class="meta">@Qualifier(&quot;escrowEntityManagerFactoryBuilder&quot;)</span> EntityManagerFactoryBuilder builder</span></span></span><br><span class="line"><span class="function"><span class="params">        , <span class="meta">@Qualifier(&quot;escrowDataSource&quot;)</span> DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.dataSource(dataSource).packages(EscrowRepository.class).persistenceUnit(Escrow.NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = Escrow.TRANSACTION)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">escrowTransactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;escrowEntityManagerFactory&quot;)</span>EntityManagerFactory entityManagerFactory)</span> </span>&#123;</span><br><span class="line">        JpaTransactionManager jtm = <span class="keyword">new</span> JpaTransactionManager();</span><br><span class="line">        jtm.setEntityManagerFactory(entityManagerFactory);</span><br><span class="line">        <span class="keyword">return</span> jtm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-5-NamedRoutingDataSource"><a href="#1-5-NamedRoutingDataSource" class="headerlink" title="1-5. NamedRoutingDataSource"></a>1-5. NamedRoutingDataSource</h3><figure class="highlight java"><figcaption><span>domain/NamedRoutingDataSource.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.support.TransactionSynchronizationManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TransactionSynchronizationManager.isCurrentTransactionReadOnly()</span><br><span class="line">            ? <span class="string">&quot;slave&quot;</span> : <span class="string">&quot;master&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-6-QueryDslConfig"><a href="#1-6-QueryDslConfig" class="headerlink" title="1-6. QueryDslConfig"></a>1-6. QueryDslConfig</h3><figure class="highlight java"><figcaption><span>domain/QueryDslConfig.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.shipping.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.querydsl.jpa.impl.JPAQueryFactory;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.configuration.db.DbConstant.Benefit;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.configuration.db.DbConstant.Deal;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.configuration.db.DbConstant.Review;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.configuration.db.DbConstant.VContent;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManager;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.PersistenceContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryDslConfig</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@PersistenceContext(unitName = VContent.NAME)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext(unitName = Deal.NAME)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager dealEntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext(unitName = Review.NAME)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager reviewEntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext(unitName = Benefit.NAME)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager benefitEntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">jpaQueryFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(entityManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">dealJpaQueryFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(dealEntityManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">reviewJpaQueryFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(reviewEntityManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">benefitJpaQueryFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(benefitEntityManager);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">위와같이 디비를 여러군데 참조하는 경우 각 디비마다 설정되야할 EntityManagerFactory를 각각 설정해야한다. 그리고 EntityManager도 각각 설정해야함. </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-7-DbConstant"><a href="#1-7-DbConstant" class="headerlink" title="1-7. DbConstant"></a>1-7. DbConstant</h3><figure class="highlight java"><figcaption><span>domain/DbConstant.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.shipping.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbConstant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VContent</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">&quot;vcontent&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION = <span class="string">&quot;transactionManager&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deal</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">&quot;deal&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Review</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">&quot;review&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION = <span class="string">&quot;reviewTransactionManager&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Benefit</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">&quot;benefit&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION = <span class="string">&quot;benefitTransactionManager&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-8-JpaProperty"><a href="#1-8-JpaProperty" class="headerlink" title="1-8. JpaProperty"></a>1-8. JpaProperty</h3><figure class="highlight java"><figcaption><span>domain/JpaProperty.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.shipping.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaProperty</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,String&gt; <span class="title">jpaProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String,String&gt; properties = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.show_sql&quot;</span>, environment.getProperty(<span class="string">&quot;spring.jpa.properties.hibernate.show_sql&quot;</span>));</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.format_sql&quot;</span>, environment.getProperty(<span class="string">&quot;spring.jpa.properties.hibernate.format_sql&quot;</span>));</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.use_sql_comments&quot;</span>, environment.getProperty(<span class="string">&quot;spring.jpa.properties.hibernate.use_sql_comments&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>위 설정은 application.yml에 적용된 jpa 설정을 가져와서 설정을 반영하는 Config클래스다. 해당 프로젝트에서는 무슨 이유때문인지 application.yml에 설정된 jpa설정이 잘 동작되지 않았다. 그래서 위 와 같이 설정을 하게 되었음. </p>
<h3 id="1-9-VShippingDomainConfiguration-Application-java와-동일"><a href="#1-9-VShippingDomainConfiguration-Application-java와-동일" class="headerlink" title="1-9. VShippingDomainConfiguration (Application.java와 동일)"></a>1-9. VShippingDomainConfiguration (Application.java와 동일)</h3><p>도메인 영역에서는 Application.java를 따로 생성하지 않았기 때문에 config폴더 아래 와 설정 클래스를 생성하였음.</p>
<figure class="highlight java"><figcaption><span>domain/JpaProperty.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.shipping.domain.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.VShippingDomain;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaAuditing;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJpaAuditing</span> <span class="comment">//JPA사용활성화</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses = VShippingDomain.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VShippingDomainConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-개발"><a href="#2-개발" class="headerlink" title="2. 개발"></a>2. 개발</h2><h3 id="2-0-Entity-사용-예제-구성"><a href="#2-0-Entity-사용-예제-구성" class="headerlink" title="2-0. Entity 사용 예제 구성"></a>2-0. Entity 사용 예제 구성</h3><figure class="highlight java"><figcaption><span>entity 구성 예제</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;bundle&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bundle</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;bundle_no&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long bundleNo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;ship_method&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String shipMethod;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;ship_price&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> shipPrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;add_ship_price&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> addShipPrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;reg_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime regDt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;chg_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime chgDt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//JoinColumn 은 제거하면 기본키로 알아서 연관관계 맺음</span></span><br><span class="line">    <span class="meta">@ManyToOne(fetch = LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;purchase_no&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Purchase purchase;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne(mappedBy = &quot;bundle&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Shipping shipping;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.repository.escrow.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.order.OrderType;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Column;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.EnumType;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Enumerated;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.OneToMany;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Table;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;purchase&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Purchase</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;purchase_no&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long purchaseNo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;order_type&quot;)</span></span><br><span class="line">    <span class="meta">@Enumerated(value = EnumType.STRING)</span></span><br><span class="line">    <span class="keyword">private</span> OrderType orderType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;tot_prod_price&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> totProdPrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;tot_ship_price&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> totShipPrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;buyer_nm&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String buyerNm;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;buyer_phone&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String buyerPhone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;m_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;reg_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime regDt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;chg_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime chgDt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToMany(mappedBy = &quot;purchase&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Bundle&gt; bundles = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.repository.escrow.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> javax.persistence.FetchType.LAZY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Column;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.JoinColumn;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.OneToOne;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Table;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;shipping&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shipping</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;ship_no&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long shipNo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;m_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;partner_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String partnerId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;ship_method&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String shipMethod;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;ship_status&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String shipStatus;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;invoice_no&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String invoiceNo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;confirm_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime confirmDt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;shipping_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime shippingDt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;complete_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime completeDt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;reg_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime regDt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;chg_dt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime chgDt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OneToOne(fetch = LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;bundle_no&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Bundle bundle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-Spring-Data-JPA의-기본-Repository-로-CRUD-하기"><a href="#2-1-Spring-Data-JPA의-기본-Repository-로-CRUD-하기" class="headerlink" title="2-1. Spring Data JPA의 기본 Repository 로 CRUD 하기"></a>2-1. Spring Data JPA의 기본 Repository 로 CRUD 하기</h3><figure class="highlight java"><figcaption><span>기본 repository</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.repository.escrow.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.order.OrderType;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="comment">//JpaRepository 를 확장해서 사용하면 기본 CRUD제공된 부분까지 사용가능</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PurchaseRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Purchase</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Purchase&gt; <span class="title">findPurchaseByOrderTypeEqualsAndMidEquals</span><span class="params">(OrderType orderType, String mid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[참고] 해당 Repository의 특징 </p>
<ul>
<li>해당 인터페이스 안에 메소드가 정의되어있는데, findPurchaseByOrderTypeEqualsAndMidEquals 요 메소드는 단순 메소드가 아닌 메소드명을 분석해서 실제로 쿼리를 생성하는 기능이 있음. </li>
<li>페이징도 가능함. </li>
<li>간단한 쿼리조회 사용할때, insert/update 쿼리도 사용가능 </li>
</ul>
<h3 id="2-2-QueryDSL-로-조회하기-1"><a href="#2-2-QueryDSL-로-조회하기-1" class="headerlink" title="2-2. QueryDSL 로 조회하기 (1)"></a>2-2. QueryDSL 로 조회하기 (1)</h3><p>보통 도메인단위로 처리를 하는데, 각 도메인별로 기본적인 CRUD를 처리하기도하지만, JPQL혹은 QueryDSL을 통해서도 조회쿼리를 만들수도 있다. 따라서 Repository의 기능도 사용하면서, Custom하게 사용하는 조회성 쿼리들을 같이 쓰게 될것이다. 이를 통합하는 방법과 QueryDSL사용법 대해서 확인해보자. </p>
<figure class="highlight java"><figcaption><span>기본 repository</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.repository.escrow.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.order.OrderType;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="comment">//JpaRepository 를 확장해서 사용하면 기본 CRUD제공된 부분까지 사용가능</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PurchaseRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Purchase</span>,<span class="title">Long</span>&gt;,<span class="title">PurchaseRepositoryCustom</span> </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Purchase&gt; <span class="title">findPurchaseByOrderTypeEqualsAndMidEquals</span><span class="params">(OrderType orderType, String mid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>custom interface</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.repository.escrow.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.order.OrderType;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PurchaseRepositoryCustom</span> </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Purchase&gt; <span class="title">findByOrderTypeEquals</span><span class="params">(OrderType orderType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>custom interface 구현체</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.repository.escrow.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wemakeprice.v.ocs.domain.repository.escrow.order.QPurchase.purchase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.querydsl.jpa.impl.JPAQueryFactory;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.order.OrderType;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.support.QuerydslRepositorySupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PurchaseRepositoryCustomImpl</span> <span class="keyword">extends</span> <span class="title">QuerydslRepositorySupport</span> <span class="keyword">implements</span> <span class="title">PurchaseRepositoryCustom</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JPAQueryFactory jpaQueryFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PurchaseRepositoryCustomImpl</span><span class="params">(JPAQueryFactory jpaQueryFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Purchase.class);</span><br><span class="line">        <span class="keyword">this</span>.jpaQueryFactory = jpaQueryFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Purchase&gt; <span class="title">findByOrderTypeEquals</span><span class="params">(OrderType orderType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jpaQueryFactory.selectFrom(purchase)</span><br><span class="line">            .where(purchase.orderType.eq(orderType))</span><br><span class="line">            .fetch();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위와같은 구조로 가져가게 되면 기본 JpaRepository에서 사용되는 기본 쿼리와 개인적으로 추가하는 Custom한 쿼리까지 동시에 한 인터페이스에서 사용가능하게 된다. </p>
<p>[참고] JPAQueryFactory는 뭐하는 놈이지?<br><a target="_blank" rel="noopener" href="http://ojc.asia/bbs/board.php?bo_table=LecJpa&wr_id=341">JPAQueryFactory 내용확인</a></p>
<h3 id="2-3-QueryDSL-로-조회하기-2"><a href="#2-3-QueryDSL-로-조회하기-2" class="headerlink" title="2-3. QueryDSL 로 조회하기 (2)"></a>2-3. QueryDSL 로 조회하기 (2)</h3><figure class="highlight java"><figcaption><span>QueryDSL사용2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.repository.escrow.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wemakeprice.v.ocs.domain.repository.escrow.order.QBundle.bundle;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wemakeprice.v.ocs.domain.repository.escrow.order.QPurchase.purchase;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.wemakeprice.v.ocs.domain.repository.escrow.order.QShipping.shipping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.querydsl.core.types.ConstructorExpression;</span><br><span class="line"><span class="keyword">import</span> com.querydsl.core.types.Projections;</span><br><span class="line"><span class="keyword">import</span> com.querydsl.core.types.dsl.BooleanExpression;</span><br><span class="line"><span class="keyword">import</span> com.querydsl.jpa.impl.JPAQueryFactory;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.repository.escrow.order.parameter.PurchaseShipRequest;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.repository.escrow.order.projection.PurchaseShipInfo;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.order.OrderType;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.support.QuerydslRepositorySupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  [참고] 현재 QuerydslRepositorySupport 를 확장 받아서 사용중인데, 사실상 JPAQueryFactory를 사용하는데 목적이있어서, 페이징 처리가 아닌이상 굳이 상속받아서 사용할 이유가 없음.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PurchaseShipRepositorySupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JPAQueryFactory jpaQueryFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PurchaseShipRepositorySupport</span><span class="params">(JPAQueryFactory jpaQueryFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jpaQueryFactory = jpaQueryFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PurchaseShipInfo&gt; <span class="title">findPurchaseShipInfo</span><span class="params">(PurchaseShipRequest param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jpaQueryFactory.select(getPurchaseShipProjectionInfo())</span><br><span class="line">            .from(shipping,shipping)</span><br><span class="line">            .innerJoin(shipping.bundle,bundle)</span><br><span class="line">            .innerJoin(shipping.bundle.purchase,purchase)</span><br><span class="line">            .where(isEqualsMid(param.getMid()),</span><br><span class="line">                isEqualsOrderType(param.getOrderType()))</span><br><span class="line">            .fetch()</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ConstructorExpression&lt;PurchaseShipInfo&gt; <span class="title">getPurchaseShipProjectionInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Projections.constructor(PurchaseShipInfo.class</span><br><span class="line">            , purchase.purchaseNo, bundle.bundleNo, purchase.orderType,</span><br><span class="line">            purchase.buyerNm, shipping.shipMethod, shipping.shipStatus</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BooleanExpression <span class="title">isEqualsMid</span><span class="params">(String mid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shipping.mid.eq(mid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BooleanExpression <span class="title">isEqualsOrderType</span><span class="params">(OrderType orderType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> purchase.orderType.eq(orderType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Provider-Service-로직-구성-확인하기"><a href="#2-4-Provider-Service-로직-구성-확인하기" class="headerlink" title="2-4. Provider, Service 로직 구성 확인하기"></a>2-4. Provider, Service 로직 구성 확인하기</h3><h4 id="트랜잭션-설정-부분의-견해"><a href="#트랜잭션-설정-부분의-견해" class="headerlink" title="트랜잭션 설정 부분의 견해"></a>트랜잭션 설정 부분의 견해</h4><ul>
<li>보통 Service로직에 @Transactional 으로 트랜잭션 관리를 하는데, readOnly여부에 따라서 db replication 의 master/slave중 readOnly=true면 slave로 route가 된다 </li>
<li>readOnly세팅이 안되어있고, @Transactional(value = TransactionManagerName.EP_MASTER, isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED, rollbackFor = Exception.class) 이런식으로 사용하게 되면 master로 route되게 된다. </li>
</ul>
<h4 id="provider란"><a href="#provider란" class="headerlink" title="provider란?"></a>provider란?</h4><ul>
<li><p>RDBMS-JPA로 가져오는 부분이나, NoSQL의 mongodb든 레디스든 여러종류의 데이터를 다양한 repository로부터 provider에 세팅해두면 이 provider를 조합해서 A provider와 B provider를 합쳐서 C라는 provider를 만들어낼수도 있다. 이부분을 assembler라고 지칭하는것같다. 이 provider를 가지고 service로직에서 사용하게 된다. </p>
</li>
<li><p>쿠팡-배송쪽에서는 위 형태를 기반으로 key based로 데이터를 조회해서 저 provider들을 조합해서 assembler로 만들고 가공해서 데이터로 전달해주는 역할의 아키텍쳐로 수백만 수천만 데이터를 잘 버텨냈다고 한다. </p>
</li>
</ul>
<p>소스는 따로 붙이지 않았다. 왜냐면 그냥 MVC에서 사용하는 소스들 그대로 쓰기때문에 큰 특이사항이 없다. </p>
<h2 id="3-정리"><a href="#3-정리" class="headerlink" title="3. 정리"></a>3. 정리</h2><p>QueryDSL은 결국 JPQL을 효율적으로 적용하기 위한 일종의 쿼리도구이다. JPA에서 가장 큰 비중을 차지하는만큼 세세한 기능들을 확인해보도록 하자. </p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/07/jpa-querydsl-1/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/07/spring-openfeign-1/"
                            aria-label=": spring-openfeign-1"
                        >
                            spring-openfeign-1
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-07T02:28:45+00:00">
	
		    May 07, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Feign/">Feign</a>, <a class="category-link" href="/categories/Spring-Boot/">Spring Boot</a>, <a class="category-link" href="/categories/Spring-OpenFeign/">Spring OpenFeign</a>, <a class="category-link" href="/categories/%EC%9C%A0%EB%A0%88%EC%B9%B4or%EC%82%BD%EC%A7%88/">유레카or삽질</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Spring-OpenFeign-삽질기"><a href="#Spring-OpenFeign-삽질기" class="headerlink" title="Spring OpenFeign 삽질기"></a>Spring OpenFeign 삽질기</h1><p>사실 Spring OpenFeign을 먼저 공부하는것보다 Hystrix -&gt; Feign -&gt; Spring OpenFeign 순으로 스터디 하는것이 낫다라고 생각이 들긴하는데, 그냥 Spring OpenFeign부터 살펴보았다. </p>
<p>Spring OpenFeign은 Netflix에서 개발한 Feign을 가지고 Spring 입맛에 맞게 개발한 부분으로 Feign에 비해서는 아직까지 덜 개발된 부분이 있는듯하나, 스프링 웹 MVC개발 경험을 그대로 사용가능하다는 장점과 좀 더 손쉬운 Fallback및 Client관리가 장점이라고 갠적으로 생각한다. </p>
<h2 id="1-세팅"><a href="#1-세팅" class="headerlink" title="1. 세팅"></a>1. 세팅</h2><h3 id="1-1-build-gradle-의존성-추가"><a href="#1-1-build-gradle-의존성-추가" class="headerlink" title="1-1. build.gradle 의존성 추가"></a>1-1. build.gradle 의존성 추가</h3><p>[주의] spring openFeign은 spring cloud 그룹에 있기때문에 spring cloud가 먼저 의존성으로 추가되어있어야함. </p>
<figure class="highlight plain"><figcaption><span>build.gradle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">implementation(&#39;org.springframework.cloud:spring-cloud-starter-openfeign&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-2-hystrix-설정"><a href="#1-2-hystrix-설정" class="headerlink" title="1-2. hystrix 설정"></a>1-2. hystrix 설정</h3><figure class="highlight plain"><figcaption><span>application.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  hystrix:</span><br><span class="line">    enabled: true</span><br></pre></td></tr></table></figure>

<h2 id="2-개발"><a href="#2-개발" class="headerlink" title="2. 개발"></a>2. 개발</h2><h3 id="2-1-Client-개발"><a href="#2-1-Client-개발" class="headerlink" title="2-1. Client 개발"></a>2-1. Client 개발</h3><figure class="highlight java"><figcaption><span>client</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.configuration.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.web.bind.annotation.RequestMethod.POST;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.model.legacy.mypage.CounselorOrderInfo;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.model.legacy.mypage.CounselorOrderParam;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.model.response.ResponseObject;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.WmpHeader;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.mypage.WmpAppType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestHeader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;api-feign-client&quot;</span></span><br><span class="line"><span class="meta">    , url = &quot;$&#123;v-ocs.api-hosts.shipping-api&#125;&quot;</span></span><br><span class="line"><span class="meta">    , fallbackFactory = ApiFeignClientFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApiFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(method = POST</span></span><br><span class="line"><span class="meta">        , value = &quot;/vertical/getCounselorOrder&quot;</span></span><br><span class="line"><span class="meta">        , produces = &quot;application/json&quot;)</span></span><br><span class="line">    <span class="function">ResponseObject&lt;CounselorOrderInfo&gt; <span class="title">getCounselorOrderFeign</span><span class="params">(<span class="meta">@RequestHeader(WmpHeader.WMP_APP_NAME)</span> WmpAppType wmpAppName</span></span></span><br><span class="line"><span class="function"><span class="params">        , <span class="meta">@RequestBody</span> CounselorOrderParam param)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위 코드를 보면 알수있지만, 기존 Spring MVC에서 활용하던 네이밍들을 그대로 가져와서 사용가능하다는 장점이 있다. 그냥 Feign을 사용하면 저 애너테이션들은 사용하지 못하고 Feign에서 정의된 애너테이션으로 사용 해야함. </p>
<h3 id="2-2-FallbackFactory-세팅"><a href="#2-2-FallbackFactory-세팅" class="headerlink" title="2-2. FallbackFactory 세팅"></a>2-2. FallbackFactory 세팅</h3><p>Spring OpenFeign은 fallback관리를 비교적 쉽게 할수있음. </p>
<figure class="highlight java"><figcaption><span>fallback factory</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.configuration.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.model.legacy.mypage.CounselorOrderInfo;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.model.legacy.mypage.CounselorOrderParam;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.model.response.ResponseObject;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.meta.mypage.WmpAppType;</span><br><span class="line"><span class="keyword">import</span> feign.hystrix.FallbackFactory;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiFeignClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title">FallbackFactory</span>&lt;<span class="title">ApiFeignClient</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApiFeignClient <span class="title">create</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiFeignClient() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ResponseObject&lt;CounselorOrderInfo&gt; <span class="title">getCounselorOrderFeign</span><span class="params">(WmpAppType wmpAppName, CounselorOrderParam param)</span> </span>&#123;</span><br><span class="line">                log.error(<span class="string">&quot;error message : &#123;&#125;&quot;</span>, cause.getMessage());</span><br><span class="line">                ResponseObject&lt;CounselorOrderInfo&gt; responseObject = <span class="keyword">new</span> ResponseObject&lt;&gt;();</span><br><span class="line">                responseObject.setData(CounselorOrderInfo.EMPTY);</span><br><span class="line">                <span class="keyword">return</span> responseObject;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>위 코드를 정의한뒤, Client에서 @FeignClient 정의할때 fallbackFactory에 정의해주면 됨.<br>@FeignClient에 그냥 fallback도 있는데, 개인적으로 생각하는 차이점은 fallbackFactory는 Throwable을 받을수있어서 에러의 상세를 알수가 있지만,<br>그냥 fallback은 단순 fallback처리만 지원되는것으로 알고있음. (깊게 공부 안함.)</p>
<h2 id="3-정리"><a href="#3-정리" class="headerlink" title="3. 정리"></a>3. 정리</h2><p>위 와 같이 설정하면 가장 기본적인 Spring OpenFeign 설정 및 개발방법은 끝이다. 너무 간단스하지만, 여기서 개인적인 생각은 기존 Feign은 여러가지 확장성있는 개발이 가능하다. 예를들면 client를 OkHttp로 세팅하거나, Http2Client같은 http2설정도 가능하고, 기타 정말 많은 부분을 확장해서 사용이 가능한걸로 알고있는데, Spring OpenFeign은 그에 반해 기능이 꽤나 한정적인걸로 확인되어진다. 그리고 아직까지는 reactive가 지원되지 않기도해서, 개별적인 라이브러리를 받아서 해야하는것으로 알고있음. 따라서, 단순 httpClient 빠르게 개발하고, hystrix까지 덤으로 같이 사용하고자할때는 Spring OpenFeign만큼 생산성있게 빠르게 개발할수있는건 없는듯하다. 아직 깊게 공부하지는 못했지만, 좀 더 깊게 공부하고 싶다면 아래 링크 사이트로 공부하도록 해보자! </p>
<p>[필수참고 사이트]<br><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-openfeign/reference/html/#reactive-support">Spring OpenFeign 공식 사이트</a><br><a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign/#basics">OpenFeign 사이트</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/07/spring-openfeign-1/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/01/multi-module-1/"
                            aria-label=": multi-module-1"
                        >
                            multi-module-1
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-01T07:39:04+00:00">
	
		    May 01, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/%EB%A9%80%ED%8B%B0%EB%AA%A8%EB%93%88%EC%84%A4%EC%A0%95/">멀티모듈설정</a>, <a class="category-link" href="/categories/%EC%9C%A0%EB%A0%88%EC%B9%B4or%EC%82%BD%EC%A7%88/">유레카or삽질</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="멀티모듈-삽질-일기"><a href="#멀티모듈-삽질-일기" class="headerlink" title="멀티모듈 삽질 일기"></a>멀티모듈 삽질 일기</h1><h2 id="1-프로젝트-초기-구성-삽질"><a href="#1-프로젝트-초기-구성-삽질" class="headerlink" title="1. 프로젝트 초기 구성 삽질"></a>1. 프로젝트 초기 구성 삽질</h2><p>v-ocs 멀티모듈 프로젝트를 당시 v-content 모듈 구성 그대로 따라서 만들어본 경험을 끄적거려본다. 개인적으로 멀티 모듈은 한번 개인적으로 공부할때 구성해본적은 있지만, 이렇게 실무에서 적용할 로직을 기반으로 구성하는건 처음이어서, 이번기회에 좀 익혀봐야하겠다고 생각해서 도전해보게 되었다. </p>
<h3 id="1-1-프로젝트-스펙"><a href="#1-1-프로젝트-스펙" class="headerlink" title="1-1. 프로젝트 스펙"></a>1-1. 프로젝트 스펙</h3><p>우선 프로젝트 스펙은 아래와 같이 설정하였다. </p>
<ul>
<li>JAVA 1.8 (적는 시점부터는 11버전업 예정중에 있음)</li>
<li>Gradle </li>
<li>SpringBoot 2.3.4 / SpringCloud Hoxtom.SR8  </li>
<li>mysql 5.X</li>
<li>Spring Data JPA </li>
<li>multi datasource 구성 (2개 디비이상 연결)</li>
<li>IDE: 인텔리제이</li>
<li>스웨거 사용 </li>
</ul>
<h3 id="1-2-프로젝트-아키텍처"><a href="#1-2-프로젝트-아키텍처" class="headerlink" title="1-2. 프로젝트 아키텍처"></a>1-2. 프로젝트 아키텍처</h3><p><img src="/images/multimodule/m-1.png" alt="프로젝트 아키텍처 청사진"></p>
<h3 id="1-3-멀티모듈-구성-방법-Gradle-기반"><a href="#1-3-멀티모듈-구성-방법-Gradle-기반" class="headerlink" title="1-3. 멀티모듈 구성 방법 (Gradle 기반)"></a>1-3. 멀티모듈 구성 방법 (Gradle 기반)</h3><ol>
<li>java gradle 기반 신규 프로젝트 구성 (이건 어렵지 않지..경우에 따라서 maven으로 세팅해야할수도 있음.)</li>
<li>세팅후, src 폴더를 지워준다. (root 프로젝트이기 때문에 필요없음. 단 build.gradle은 절대로 지우지말자.)</li>
<li>IDE내 root프로젝트 선택후 마우스 우클릭 하고 New-&gt;Module 선택해서 프로젝트 만들어주면 됨. (ex&gt; v-ocs-meta/v-ocs-api/v-ocs-domain/v-ocs-batch…)</li>
<li>root프로젝트의 build.gradle 설정 구성 (맨하단에 추가한 모듈의존성 꼭 확인하자!)<figure class="highlight plain"><figcaption><span>root-build.gradle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ext &#123;</span><br><span class="line">        springBootVersion &#x3D; &#39;2.3.4.RELEASE&#39;</span><br><span class="line">        springCloudVersion &#x3D; &#39;Hoxton.SR8&#39;</span><br><span class="line">        dependencyManagementVersion &#x3D; &#39;1.0.10.RELEASE&#39;</span><br><span class="line">    &#125;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath(&quot;org.springframework.boot:spring-boot-gradle-plugin:$&#123;springBootVersion&#125;&quot;)</span><br><span class="line">        classpath &quot;io.spring.gradle:dependency-management-plugin:$&#123;dependencyManagementVersion&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    group &quot;com.codexdawn.v.ocs&quot;</span><br><span class="line"></span><br><span class="line">    apply plugin: &quot;java&quot;</span><br><span class="line">    apply plugin: &quot;idea&quot;</span><br><span class="line">    apply plugin: &#39;org.springframework.boot&#39;</span><br><span class="line"></span><br><span class="line">    idea &#123;</span><br><span class="line">        module &#123;</span><br><span class="line">            inheritOutputDirs &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">subprojects &#123;</span><br><span class="line">    apply plugin: &#39;java&#39;</span><br><span class="line">    apply plugin: &#39;idea&#39;</span><br><span class="line">    apply plugin: &#39;org.springframework.boot&#39;</span><br><span class="line">    apply plugin: &#39;io.spring.dependency-management&#39;</span><br><span class="line"></span><br><span class="line">    group &#x3D; &#39;com.wmp.v.ocs&#39;</span><br><span class="line"></span><br><span class="line">    version &#x3D; &#39;0.0.1-SNAPSHOT&#39;</span><br><span class="line">    sourceCompatibility &#x3D; &#39;1.8&#39;</span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url &quot;http:&#x2F;&#x2F;nexus.sys.wemakeprice.com&#x2F;content&#x2F;repositories&#x2F;central&quot;</span><br><span class="line">            credentials &#123;</span><br><span class="line">                username &quot;development&quot;</span><br><span class="line">                password &quot;development&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url &quot;http:&#x2F;&#x2F;nexus.sys.wemakeprice.com&#x2F;content&#x2F;repositories&#x2F;thirdparty&quot;</span><br><span class="line">            credentials &#123;</span><br><span class="line">                username &quot;development&quot;</span><br><span class="line">                password &quot;development&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url &quot;http:&#x2F;&#x2F;nexus.sys.wemakeprice.com&#x2F;content&#x2F;repositories&#x2F;releases&quot;</span><br><span class="line">            credentials &#123;</span><br><span class="line">                username &quot;development&quot;</span><br><span class="line">                password &quot;development&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url &quot;http:&#x2F;&#x2F;nexus.sys.wemakeprice.com&#x2F;content&#x2F;repositories&#x2F;snapshots&quot;</span><br><span class="line">            credentials &#123;</span><br><span class="line">                username &quot;development&quot;</span><br><span class="line">                password &quot;development&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url &quot;http:&#x2F;&#x2F;oss.jfrog.org&#x2F;artifactory&#x2F;oss-snapshot-local&quot;</span><br><span class="line">            credentials &#123;</span><br><span class="line">                username &quot;jcenter-snapshots&quot;</span><br><span class="line">                password &quot;jcenter&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    task initSourceFolders &#123;</span><br><span class="line">        sourceSets*.java.srcDirs*.each &#123;</span><br><span class="line">            if (!it.exists()) &#123;</span><br><span class="line">                it.mkdirs()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sourceSets*.resources.srcDirs*.each &#123;</span><br><span class="line">            if (!it.exists()) &#123;</span><br><span class="line">                it.mkdirs()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dependencies &#123;</span><br><span class="line"></span><br><span class="line">        compileOnly &#39;org.projectlombok:lombok&#39;</span><br><span class="line">        annotationProcessor &#39;org.springframework.boot:spring-boot-configuration-processor&#39;</span><br><span class="line">        annotationProcessor &#39;org.projectlombok:lombok&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        testImplementation(&#39;org.springframework.boot:spring-boot-starter-test&#39;) &#123;</span><br><span class="line">            exclude group: &#39;org.junit.vintage&#39;, module: &#39;junit-vintage-engine&#39;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; jackson</span><br><span class="line">        implementation(&#39;com.fasterxml.jackson.core:jackson-databind&#39;)</span><br><span class="line">        implementation(&#39;com.google.code.gson:gson:2.8.0&#39;)</span><br><span class="line">        implementation(&#39;com.google.guava:guava:28.0-jre&#39;)</span><br><span class="line">        implementation(&#39;commons-codec:commons-codec&#39;)</span><br><span class="line">        implementation(&#39;org.apache.commons:commons-lang3:3.9&#39;)</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; jsr validation</span><br><span class="line">        implementation(&#39;javax.validation:validation-api:2.0.1.Final&#39;)</span><br><span class="line"></span><br><span class="line">        testCompile group: &#39;junit&#39;, name: &#39;junit&#39;, version: &#39;4.12&#39;</span><br><span class="line">        testImplementation(&#39;org.easytesting:fest-assert:1.4&#39;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dependencyManagement &#123;</span><br><span class="line">        imports &#123;</span><br><span class="line">            mavenBom &quot;org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">    useJUnitPlatform()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">project(&#39;:v-ocs-api&#39;) &#123;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        compile project(&#39;:v-ocs-domain&#39;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">project(&#39;:v-ocs-batch&#39;) &#123;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        compile project(&#39;:v-ocs-domain&#39;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">project(&#39;:v-ocs-domain&#39;) &#123;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        compile project(path: &#39;:v-ocs-meta&#39;, configuration: &#39;default&#39;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>최종 구성된 멀티 모듈 프로젝트<br><img src="/images/multimodule/m-2.png" alt="최종 세팅된 모습"></p>
<h2 id="2-API-모듈-구성-하기"><a href="#2-API-모듈-구성-하기" class="headerlink" title="2. API 모듈 구성 하기"></a>2. API 모듈 구성 하기</h2><h3 id="2-1-build-gradle-세팅"><a href="#2-1-build-gradle-세팅" class="headerlink" title="2-1. build.gradle 세팅"></a>2-1. build.gradle 세팅</h3><p>API쪽 build.gradle영역은 생각보다 많이 심플하다. 의존되는 라이브러리만 잘 가져오면 된다.<br>여기서 유심히 봐야할건, spring-data-jpa같이 도메인에서 사용되는 라이브러리가 api단에 추가되어있다는것이 특징이라 할수있다.<br>그말인즉슨, BATCH도 아래와 유사하게 세팅해야한다는것이다. </p>
<figure class="highlight plain"><figcaption><span>api-build.gradle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-web&#39;)</span><br><span class="line">    testImplementation(&#39;org.springframework.boot:spring-boot-starter-test&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-validation&#39;)</span><br><span class="line"></span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-actuator&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-security&#39;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; swagger</span><br><span class="line">    implementation(&#39;io.springfox:springfox-boot-starter:3.0.0&#39;)</span><br><span class="line">    compile(&#39;io.springfox:springfox-swagger-ui:3.0.0&#39;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; kafka</span><br><span class="line">    implementation(&#39;org.apache.kafka:kafka-clients:0.10.1.1&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.cloud:spring-cloud-starter-sleuth&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.cloud:spring-cloud-starter-zipkin&#39;)</span><br><span class="line">    implementation(&#39;com.github.danielwegener:logback-kafka-appender:0.1.0&#39;)</span><br><span class="line"></span><br><span class="line">    implementation (&#39;org.springframework.boot:spring-boot-starter-data-jpa&#39;)</span><br><span class="line"></span><br><span class="line">    runtime &#39;org.hibernate:hibernate-entitymanager&#39;</span><br><span class="line">    runtime &#39;mysql:mysql-connector-java&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Application-java-설정"><a href="#2-2-Application-java-설정" class="headerlink" title="2-2. Application.java 설정"></a>2-2. Application.java 설정</h3><figure class="highlight plain"><figcaption><span>Appliocation.java 설정</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package com.wemakeprice.v.ocs.api;</span><br><span class="line"></span><br><span class="line">import com.wemakeprice.v.ocs.domain.VOcsDomain;</span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line">import org.springframework.context.annotation.ComponentScan;</span><br><span class="line">import org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"></span><br><span class="line">@EnableWebMvc</span><br><span class="line">@ComponentScan(basePackageClasses &#x3D; &#123;VOcsApi.class, VOcsDomain.class&#125;)</span><br><span class="line">@SpringBootApplication(exclude &#x3D; &#123;DataSourceAutoConfiguration.class&#125;)</span><br><span class="line">public class VOcsApiApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(VOcsApiApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위 코드의 특징은 ComponentScan이 단순 interface파일로 컴포넌트를 스캔하도록 구성되어있다는것이다. (처음알았다…^^;)<br>VOcsApi.class, VOcsDomain.class 요 두개는 그냥 빈 interface로 구성되어있다. </p>
<figure class="highlight plain"><figcaption><span>VOcsApi/VOcsDomain.class</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package com.wemakeprice.v.ocs.api;</span><br><span class="line"></span><br><span class="line">public interface VOcsApi &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-application-yml-logback-sping-xml-설정"><a href="#2-3-application-yml-logback-sping-xml-설정" class="headerlink" title="2-3. application.yml / logback-sping.xml 설정"></a>2-3. application.yml / logback-sping.xml 설정</h3><figure class="highlight plain"><figcaption><span>application.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: v-ocs-api</span><br><span class="line">  profiles:</span><br><span class="line">    active: local</span><br><span class="line">    include:</span><br><span class="line">        - domain-local</span><br><span class="line"></span><br><span class="line">  sleuth:</span><br><span class="line">    rxjava.schedulers.hook.enabled: false</span><br><span class="line">    enabled: true</span><br><span class="line">    sampler:</span><br><span class="line">      probability: 1.0</span><br><span class="line"></span><br><span class="line">    security:</span><br><span class="line">      user:</span><br><span class="line">        name: wmp</span><br><span class="line">        password: wemake</span><br><span class="line"></span><br><span class="line">    jackson:</span><br><span class="line">      default-property-inclusion: non_null</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  config: classpath:logback-spring.xml</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  max-http-header-size: 32KB</span><br><span class="line">  port: 18080</span><br><span class="line"></span><br><span class="line">management:</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      show-details: always</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      base-path: &#x2F;servicemanager</span><br><span class="line">      exposure:</span><br><span class="line">        include: &quot;*&quot;</span><br><span class="line">		</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>application-local.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  output:</span><br><span class="line">    ansi:</span><br><span class="line">      enabled: always</span><br><span class="line"></span><br><span class="line">  sleuth:</span><br><span class="line">    rxjava.schedulers.hook.enabled: false</span><br><span class="line">    enabled: false</span><br><span class="line">  zipkin:</span><br><span class="line">    enabled: false</span><br><span class="line"></span><br><span class="line">  jpa:</span><br><span class="line">    database-platform: org.hibernate.dialect.MySQL5InnoDBDialect</span><br><span class="line">    open-in-view: false</span><br><span class="line">    properties:</span><br><span class="line">      hibernate:</span><br><span class="line">        format_sql: true</span><br><span class="line">        show_sql: true</span><br><span class="line">        use_sql_comments: true</span><br><span class="line">        id:</span><br><span class="line">          new_generator_mappings: false</span><br><span class="line"></span><br><span class="line">        order_inserts: true</span><br><span class="line">        order_updates: true</span><br><span class="line">        jdbc:</span><br><span class="line">          batch_size: 1000</span><br><span class="line">    generate-ddl: false</span><br><span class="line"></span><br><span class="line">  datasource:</span><br><span class="line">    escrow-master:</span><br><span class="line">      driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">      jdbc-url: jdbc:mysql:&#x2F;&#x2F;1.234.77:3306&#x2F;wmp_escrow?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;connectionCollation&#x3D;utf8_bin&amp;characterSetResults&#x3D;utf8&amp;autoReconnect&#x3D;true&amp;serverTimezone&#x3D;Asia&#x2F;Seoul&amp;useSSL&#x3D;false&amp;zeroDateTimeBehavior&#x3D;convertToNull</span><br><span class="line">      username: app_escrow</span><br><span class="line">      password: 5Z9pjgBw3Pj1RMrVLQYv</span><br><span class="line">      maximum-pool-size: 10</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      connection-timeout: 5000 # ms</span><br><span class="line">      validation-timeout: 5000 # ms</span><br><span class="line">      max-lifetime: 55000 # ms, mysql wait_timeout is 60s. idleTimeout is close to or more than maxLifetime, disabling it.</span><br><span class="line">      transaction-isolation: TRANSACTION_READ_COMMITTED</span><br><span class="line">      pool-name: escrowMaster-db-pool</span><br><span class="line">      data-source-properties:</span><br><span class="line">        cachePrepStmts: true  # dbcp2의 pool-prepared-statements: true와 동일한 설정</span><br><span class="line">        prepStmtCacheSize: 50 # 기존 설정은 무제한이었으나 connection당 생성되므로 너무 크게 섫정하면 OOM이 발생할 수 있다.</span><br><span class="line">        prepStmtCacheSqlLimit: 2048 # sql 문장의 크기제한</span><br><span class="line"></span><br><span class="line">    escrow-slave:</span><br><span class="line">      driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">      jdbc-url: jdbc:mysql:&#x2F;&#x2F;1.234.77:3306&#x2F;wmp_escrow?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;connectionCollation&#x3D;utf8_bin&amp;characterSetResults&#x3D;utf8&amp;autoReconnect&#x3D;true&amp;serverTimezone&#x3D;Asia&#x2F;Seoul&amp;useSSL&#x3D;false&amp;zeroDateTimeBehavior&#x3D;convertToNull</span><br><span class="line">      username: app_escrow</span><br><span class="line">      password: 5Z9pjgBw3Pj1RMrVLQYv</span><br><span class="line">      maximum-pool-size: 10</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      connection-timeout: 5000 # ms</span><br><span class="line">      validation-timeout: 5000 # ms</span><br><span class="line">      max-lifetime: 55000 # ms, mysql wait_timeout is 60s. idleTimeout is close to or more than maxLifetime, disabling it.</span><br><span class="line">      transaction-isolation: TRANSACTION_READ_COMMITTED</span><br><span class="line">      pool-name: escorwSlave-db-pool</span><br><span class="line">      data-source-properties:</span><br><span class="line">        cachePrepStmts: true  # dbcp2의 pool-prepared-statements: true와 동일한 설정</span><br><span class="line">        prepStmtCacheSize: 50 # 기존 설정은 무제한이었으나 connection당 생성되므로 너무 크게 섫정하면 OOM이 발생할 수 있다.</span><br><span class="line">        prepStmtCacheSqlLimit: 2048 # sql 문장의 크기제한</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>logback-spring.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line"></span><br><span class="line">  &lt;include resource&#x3D;&quot;org&#x2F;springframework&#x2F;boot&#x2F;logging&#x2F;logback&#x2F;defaults.xml&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;property name&#x3D;&quot;CONSOLE_PATTERN&quot; value&#x3D;&quot;%clr(%d&#123;yyyy-MM-dd HH:mm:ss.SSS, Asia&#x2F;Seoul&#125;)&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;) [$&#123;java.rmi.server.hostname:-127.0.0.1&#125;] [$&#123;nd.hostname:-localhost&#125;] %clr($&#123;PID:- &#125;)&#123;magenta&#125; %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125; %clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr([%class&#123;5&#125; &gt; %method:%line])&#123;magenta&#125; %clr(:)&#123;faint&#125; %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;&#x2F;&gt;</span><br><span class="line">  &lt;property name&#x3D;&quot;FILE_PATTERN&quot; value&#x3D;&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS, Asia&#x2F;Seoul&#125; $&#123;LOG_LEVEL_PATTERN:-%5p&#125; $&#123;PID:- &#125; --- [%t] %-40.40logger&#123;39&#125; [%class&#123;5&#125; &gt; %method:%line] : %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;&#x2F;&gt;</span><br><span class="line">  &lt;property name&#x3D;&quot;KAFKA_PATTERN&quot; value&#x3D;&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS, Asia&#x2F;Seoul&#125; %X&#123;wmpHeader&#125; $&#123;LOG_LEVEL_PATTERN:-%5p&#125; [$&#123;java.rmi.server.hostname:-127.0.0.1&#125;] [$&#123;nd.hostname:-localhost&#125;] $&#123;PID:- &#125; --- [%t] %-40.40logger&#123;39&#125; [%class&#123;5&#125; &gt; %method:%line] : %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--  &lt;property name&#x3D;&quot;LOG_PATH&quot; value&#x3D;&quot;$&#123;LOG_PATH:-$&#123;user.home&#125;&#x2F;logs&#125;&quot;&#x2F;&gt;--&gt;</span><br><span class="line">  &lt;property name&#x3D;&quot;LOG_PATH&quot; value&#x3D;&quot;$&#123;LOG_PATH:-$&#123;logging.path&#125;&#125;&quot;&#x2F;&gt;</span><br><span class="line">  &lt;property name&#x3D;&quot;LOG_FILE&quot; value&#x3D;&quot;$&#123;LOG_FILE:-spring&#125;&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;appender name&#x3D;&quot;CONSOLE_APPENDER&quot; class&#x3D;&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span><br><span class="line">    &lt;encoder&gt;</span><br><span class="line">      &lt;pattern&gt;$&#123;CONSOLE_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">      &lt;charset&gt;utf8&lt;&#x2F;charset&gt;</span><br><span class="line">    &lt;&#x2F;encoder&gt;</span><br><span class="line">  &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">  &lt;appender name&#x3D;&quot;FILE_APPENDER&quot; class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">    &lt;file&gt;$&#123;LOG_PATH&#125;&#x2F;$&#123;LOG_FILE&#125;.log&lt;&#x2F;file&gt;</span><br><span class="line">    &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">      &lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;&#x2F;old&#x2F;$&#123;LOG_FILE&#125;-%d&#123;yyyyMMdd&#125;.%i.log.gz&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">      &lt;maxHistory&gt;10&lt;&#x2F;maxHistory&gt;</span><br><span class="line">      &lt;maxFileSize&gt;300MB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">      &lt;totalSizeCap&gt;300MB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">    &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">    &lt;encoder&gt;</span><br><span class="line">      &lt;pattern&gt;$&#123;FILE_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">      &lt;charset&gt;utf8&lt;&#x2F;charset&gt;</span><br><span class="line">    &lt;&#x2F;encoder&gt;</span><br><span class="line">  &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">  &lt;appender name&#x3D;&quot;FILE_ERROR_APPENDER&quot; class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">    &lt;file&gt;$&#123;LOG_PATH&#125;&#x2F;$&#123;LOG_FILE&#125;-error.log&lt;&#x2F;file&gt;</span><br><span class="line">    &lt;filter class&#x3D;&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;&gt;</span><br><span class="line">      &lt;level&gt;ERROR&lt;&#x2F;level&gt;</span><br><span class="line">    &lt;&#x2F;filter&gt;</span><br><span class="line">    &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">      &lt;fileNamePattern&gt;$&#123;LOG_PATH&#125;&#x2F;old&#x2F;$&#123;LOG_FILE&#125;-error-%d&#123;yyyyMMdd&#125;.%i.log.gz&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">      &lt;maxHistory&gt;10&lt;&#x2F;maxHistory&gt;</span><br><span class="line">      &lt;maxFileSize&gt;300MB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">      &lt;totalSizeCap&gt;300MB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">    &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">    &lt;encoder&gt;</span><br><span class="line">      &lt;pattern&gt;$&#123;FILE_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">      &lt;charset&gt;utf8&lt;&#x2F;charset&gt;</span><br><span class="line">    &lt;&#x2F;encoder&gt;</span><br><span class="line">  &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 로그 레벨 설정 --&gt;</span><br><span class="line">  &lt;logger name&#x3D;&quot;java.sql&quot; level&#x3D;&quot;INFO&quot; &#x2F;&gt;</span><br><span class="line">  &lt;logger name&#x3D;&quot;org.apache&quot; level&#x3D;&quot;WARN&quot; &#x2F;&gt;</span><br><span class="line">  &lt;logger name&#x3D;&quot;org.hibernate.SQL&quot; level&#x3D;&quot;INFO&quot; &#x2F;&gt;</span><br><span class="line">  &lt;logger name&#x3D;&quot;org.mybatis.spring&quot; level&#x3D;&quot;INFO&quot; &#x2F;&gt;</span><br><span class="line">  &lt;logger name&#x3D;&quot;org.springframework&quot; level&#x3D;&quot;INFO&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- spring profiles 에 따른 로그 레벨 설정 (spring boot 에서만 설정 가능함.) --&gt;</span><br><span class="line">  &lt;springProfile name&#x3D;&quot;local&quot;&gt;</span><br><span class="line">    &lt;logger name&#x3D;&quot;com.wemakeprice&quot; level&#x3D;&quot;INFO&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 정의 되지 않은 logger 들에게 일괄 적용됨 --&gt;</span><br><span class="line">    &lt;root level&#x3D;&quot;INFO&quot;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;CONSOLE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_ERROR_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;root&gt;</span><br><span class="line">  &lt;&#x2F;springProfile&gt;</span><br><span class="line"></span><br><span class="line">  &lt;springProfile name&#x3D;&quot;dev&quot;&gt;</span><br><span class="line">    &lt;logger name&#x3D;&quot;com.wemakeprice&quot; level&#x3D;&quot;DEBUG&quot; &#x2F;&gt;</span><br><span class="line">    &lt;logger name&#x3D;&quot;com.zaxxer.hikari.HikariConfig&quot; level&#x3D;&quot;DEBUG&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- KAFKA 연동 설정 --&gt;</span><br><span class="line">    &lt;appender name&#x3D;&quot;KAFKA_APPENDER&quot; class&#x3D;&quot;com.github.danielwegener.logback.kafka.KafkaAppender&quot;&gt;</span><br><span class="line">      &lt;!-- This is the default encoder that encodes every log message to an utf8-encoded string  --&gt;</span><br><span class="line">      &lt;encoder class&#x3D;&quot;com.github.danielwegener.logback.kafka.encoding.LayoutKafkaMessageEncoder&quot;&gt;</span><br><span class="line">        &lt;layout class&#x3D;&quot;ch.qos.logback.classic.PatternLayout&quot;&gt;</span><br><span class="line">          &lt;pattern&gt;$&#123;KAFKA_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">        &lt;&#x2F;layout&gt;</span><br><span class="line">      &lt;&#x2F;encoder&gt;</span><br><span class="line">      &lt;topic&gt;wmp_api_log&lt;&#x2F;topic&gt;</span><br><span class="line">      &lt;keyingStrategy class&#x3D;&quot;com.github.danielwegener.logback.kafka.keying.RoundRobinKeyingStrategy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;deliveryStrategy class&#x3D;&quot;com.github.danielwegener.logback.kafka.delivery.AsynchronousDeliveryStrategy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;producerConfig&gt;bootstrap.servers&#x3D;nd-log-mq.dev.wemakeprice.com:9092&lt;&#x2F;producerConfig&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- don&#39;t wait for a broker to ack the reception of a batch.  --&gt;</span><br><span class="line">      &lt;producerConfig&gt;acks&#x3D;0&lt;&#x2F;producerConfig&gt;</span><br><span class="line">      &lt;!-- even if the producer buffer runs full, do not block the application but start to drop messages --&gt;</span><br><span class="line">      &lt;producerConfig&gt;max.block.ms&#x3D;0&lt;&#x2F;producerConfig&gt;</span><br><span class="line">    &lt;&#x2F;appender&gt;</span><br><span class="line">    &lt;!-- 정의 되지 않은 logger 들에게 일괄 적용됨 --&gt;</span><br><span class="line">    &lt;root level&#x3D;&quot;INFO&quot;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;CONSOLE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_ERROR_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;!-- KAFKA 연동 설정 --&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;KAFKA_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;root&gt;</span><br><span class="line">  &lt;&#x2F;springProfile&gt;</span><br><span class="line"></span><br><span class="line">  &lt;springProfile name&#x3D;&quot;qa&quot;&gt;</span><br><span class="line">    &lt;logger name&#x3D;&quot;com.wemakeprice&quot; level&#x3D;&quot;INFO&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- KAFKA 연동 설정 --&gt;</span><br><span class="line">    &lt;appender name&#x3D;&quot;KAFKA_APPENDER&quot; class&#x3D;&quot;com.github.danielwegener.logback.kafka.KafkaAppender&quot;&gt;</span><br><span class="line">      &lt;!-- This is the default encoder that encodes every log message to an utf8-encoded string  --&gt;</span><br><span class="line">      &lt;encoder class&#x3D;&quot;com.github.danielwegener.logback.kafka.encoding.LayoutKafkaMessageEncoder&quot;&gt;</span><br><span class="line">        &lt;layout class&#x3D;&quot;ch.qos.logback.classic.PatternLayout&quot;&gt;</span><br><span class="line">          &lt;pattern&gt;$&#123;KAFKA_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">        &lt;&#x2F;layout&gt;</span><br><span class="line">      &lt;&#x2F;encoder&gt;</span><br><span class="line">      &lt;topic&gt;wmp_api_log&lt;&#x2F;topic&gt;</span><br><span class="line">      &lt;keyingStrategy class&#x3D;&quot;com.github.danielwegener.logback.kafka.keying.RoundRobinKeyingStrategy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;deliveryStrategy class&#x3D;&quot;com.github.danielwegener.logback.kafka.delivery.AsynchronousDeliveryStrategy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;producerConfig&gt;bootstrap.servers&#x3D;nd-log-mq.qa.wemakeprice.com:9092&lt;&#x2F;producerConfig&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- don&#39;t wait for a broker to ack the reception of a batch.  --&gt;</span><br><span class="line">      &lt;producerConfig&gt;acks&#x3D;0&lt;&#x2F;producerConfig&gt;</span><br><span class="line">      &lt;!-- even if the producer buffer runs full, do not block the application but start to drop messages --&gt;</span><br><span class="line">      &lt;producerConfig&gt;max.block.ms&#x3D;0&lt;&#x2F;producerConfig&gt;</span><br><span class="line">    &lt;&#x2F;appender&gt;</span><br><span class="line">    &lt;!-- 정의 되지 않은 logger 들에게 일괄 적용됨 --&gt;</span><br><span class="line">    &lt;root level&#x3D;&quot;INFO&quot;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;CONSOLE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_ERROR_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;!-- KAFKA 연동 설정 --&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;KAFKA_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;root&gt;</span><br><span class="line">  &lt;&#x2F;springProfile&gt;</span><br><span class="line"></span><br><span class="line">  &lt;springProfile name&#x3D;&quot;stg&quot;&gt;</span><br><span class="line">    &lt;logger name&#x3D;&quot;com.wemakeprice&quot; level&#x3D;&quot;INFO&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;appender name&#x3D;&quot;KAFKA_APPENDER&quot; class&#x3D;&quot;com.github.danielwegener.logback.kafka.KafkaAppender&quot;&gt;</span><br><span class="line">      &lt;!-- This is the default encoder that encodes every log message to an utf8-encoded string  --&gt;</span><br><span class="line">      &lt;encoder class&#x3D;&quot;com.github.danielwegener.logback.kafka.encoding.LayoutKafkaMessageEncoder&quot;&gt;</span><br><span class="line">        &lt;layout class&#x3D;&quot;ch.qos.logback.classic.PatternLayout&quot;&gt;</span><br><span class="line">          &lt;pattern&gt;$&#123;KAFKA_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">        &lt;&#x2F;layout&gt;</span><br><span class="line">      &lt;&#x2F;encoder&gt;</span><br><span class="line">      &lt;topic&gt;wmp_api_log&lt;&#x2F;topic&gt;</span><br><span class="line">      &lt;keyingStrategy class&#x3D;&quot;com.github.danielwegener.logback.kafka.keying.RoundRobinKeyingStrategy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;deliveryStrategy class&#x3D;&quot;com.github.danielwegener.logback.kafka.delivery.AsynchronousDeliveryStrategy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;producerConfig&gt;bootstrap.servers&#x3D;nd-log-mq.stg.wemakeprice.com:9092&lt;&#x2F;producerConfig&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- don&#39;t wait for a broker to ack the reception of a batch.  --&gt;</span><br><span class="line">      &lt;producerConfig&gt;acks&#x3D;0&lt;&#x2F;producerConfig&gt;</span><br><span class="line">      &lt;!-- even if the producer buffer runs full, do not block the application but start to drop messages --&gt;</span><br><span class="line">      &lt;producerConfig&gt;max.block.ms&#x3D;0&lt;&#x2F;producerConfig&gt;</span><br><span class="line">    &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 정의 되지 않은 logger 들에게 일괄 적용됨 --&gt;</span><br><span class="line">    &lt;root level&#x3D;&quot;ERROR&quot;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;CONSOLE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_ERROR_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;!-- KAFKA 연동 설정 --&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;KAFKA_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;root&gt;</span><br><span class="line">  &lt;&#x2F;springProfile&gt;</span><br><span class="line"></span><br><span class="line">  &lt;springProfile name&#x3D;&quot;prod&quot;&gt;</span><br><span class="line">    &lt;logger name&#x3D;&quot;com.wemakeprice&quot; level&#x3D;&quot;INFO&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;appender name&#x3D;&quot;KAFKA_APPENDER&quot; class&#x3D;&quot;com.github.danielwegener.logback.kafka.KafkaAppender&quot;&gt;</span><br><span class="line">      &lt;!-- This is the default encoder that encodes every log message to an utf8-encoded string  --&gt;</span><br><span class="line">      &lt;encoder class&#x3D;&quot;com.github.danielwegener.logback.kafka.encoding.LayoutKafkaMessageEncoder&quot;&gt;</span><br><span class="line">        &lt;layout class&#x3D;&quot;ch.qos.logback.classic.PatternLayout&quot;&gt;</span><br><span class="line">          &lt;pattern&gt;$&#123;KAFKA_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">        &lt;&#x2F;layout&gt;</span><br><span class="line">      &lt;&#x2F;encoder&gt;</span><br><span class="line">      &lt;topic&gt;wmp_api_log&lt;&#x2F;topic&gt;</span><br><span class="line">      &lt;keyingStrategy class&#x3D;&quot;com.github.danielwegener.logback.kafka.keying.RoundRobinKeyingStrategy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;deliveryStrategy class&#x3D;&quot;com.github.danielwegener.logback.kafka.delivery.AsynchronousDeliveryStrategy&quot; &#x2F;&gt;</span><br><span class="line">      &lt;producerConfig&gt;bootstrap.servers&#x3D;nd-log-mq.wemakeprice.com:9092&lt;&#x2F;producerConfig&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- don&#39;t wait for a broker to ack the reception of a batch.  --&gt;</span><br><span class="line">      &lt;producerConfig&gt;acks&#x3D;0&lt;&#x2F;producerConfig&gt;</span><br><span class="line">      &lt;!-- even if the producer buffer runs full, do not block the application but start to drop messages --&gt;</span><br><span class="line">      &lt;producerConfig&gt;max.block.ms&#x3D;0&lt;&#x2F;producerConfig&gt;</span><br><span class="line">    &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 정의 되지 않은 logger 들에게 일괄 적용됨 --&gt;</span><br><span class="line">    &lt;root level&#x3D;&quot;ERROR&quot;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;CONSOLE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;FILE_ERROR_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">      &lt;!-- KAFKA 연동 설정 --&gt;</span><br><span class="line">      &lt;appender-ref ref&#x3D;&quot;KAFKA_APPENDER&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;root&gt;</span><br><span class="line">  &lt;&#x2F;springProfile&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>한가지 의문점은 현재 application.yml 및 application-local.yml 의 설정은 spring.active.profile이 local로 기본으로 잡혀있는데, 보통 dev/qa/stg/prod환경을 따로따로 파일을 생성할건데, 타 프로젝트에서는 해당 부분을 구분하는 부분이 안보였다. 어떻게 구분해서 가져오는거지..? (알아봐야겠다…)</p>
<h3 id="2-4-SecurityConfig-SwaggerConfig-WebConfig"><a href="#2-4-SecurityConfig-SwaggerConfig-WebConfig" class="headerlink" title="2-4. SecurityConfig / SwaggerConfig / WebConfig"></a>2-4. SecurityConfig / SwaggerConfig / WebConfig</h3><figure class="highlight java"><figcaption><span>SecurityConfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.api.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf().disable();</span><br><span class="line">        http.authorizeRequests().antMatchers(<span class="string">&quot;/**&quot;</span>).permitAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>SwaggerConfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.api.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">api</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">            .groupName(<span class="string">&quot;v-ocs-api&quot;</span>)</span><br><span class="line">            .apiInfo(apiInfo())</span><br><span class="line">            .select()</span><br><span class="line">            .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.wemakeprice.v.ocs.api&quot;</span>))</span><br><span class="line">            .paths(PathSelectors.any())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder().title(<span class="string">&quot;V-Ocs-API&quot;</span>).description(<span class="string">&quot;V-Ocs-API LIST &amp; Document&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>WebConfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.api.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ViewControllerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addRedirectViewController(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;/swagger-ui/index.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>여기까지가 API모듈 구성 부분이다. 최종적으로 세팅하면 아래 이미지 처럼 나오게 된다. </p>
<p><img src="/images/multimodule/m-3.png" alt="api모듈 최종"></p>
<h2 id="3-Domain-모듈-구성"><a href="#3-Domain-모듈-구성" class="headerlink" title="3. Domain 모듈 구성"></a>3. Domain 모듈 구성</h2><p>도메인 모듈은 repository와 같이 실질적으로 data에 접근하는 모든 부분을 넣는 모듈이다. 따라서 JPA와 같이 RDBMS나 NoSQL로 데이터를 가져오는 구간이라고 생각하면 된다. 추가적으로 API나 BATCH모듈과 달리 Domain모듈은 Application.java가 필요하지 않다. 그도 그럴것이 도메인은 API/BATCH모듈내 포함되는 구조기때문에 독립적으로 수행되는 부분이 전혀없다. 위에 설정했듯 VOcsDomain.java(빈 interface)만 만들어주면됨. </p>
<h3 id="3-1-build-gradle"><a href="#3-1-build-gradle" class="headerlink" title="3-1. build.gradle"></a>3-1. build.gradle</h3><figure class="highlight plain"><figcaption><span>domain-build.gradle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">bootJar&#123;</span><br><span class="line">    enabled &#x3D; false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jar &#123;</span><br><span class="line">    enabled &#x3D; true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    ext &#123;</span><br><span class="line">        querydslPluginVersion &#x3D; &#39;1.0.10&#39;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123; url &quot;https:&#x2F;&#x2F;plugins.gradle.org&#x2F;m2&#x2F;&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-web&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-jdbc&#39;)</span><br><span class="line">    implementation(&#39;org.springframework.boot:spring-boot-starter-data-jpa&#39;)</span><br><span class="line">    implementation(&#39;org.apache.httpcomponents:httpclient&#39;)</span><br><span class="line"></span><br><span class="line">    compile(&quot;com.querydsl:querydsl-core&quot;) &#x2F;&#x2F; querydsl</span><br><span class="line">    compile(&quot;com.querydsl:querydsl-jpa&quot;) &#x2F;&#x2F; querydsl</span><br><span class="line">    annotationProcessor &quot;com.querydsl:querydsl-apt:$&#123;dependencyManagement.importedProperties[&#39;querydsl.version&#39;]&#125;:jpa&quot; &#x2F;&#x2F; querydsl JPAAnnotationProcessor 사용 지정</span><br><span class="line"></span><br><span class="line">    annotationProcessor(&quot;jakarta.persistence:jakarta.persistence-api&quot;)</span><br><span class="line">    annotationProcessor(&quot;jakarta.annotation:jakarta.annotation-api&quot;)</span><br><span class="line"></span><br><span class="line">    runtime &#39;org.hibernate:hibernate-entitymanager&#39;</span><br><span class="line">    runtime &#39;mysql:mysql-connector-java&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    compile group: &#39;org.modelmapper&#39;, name: &#39;modelmapper&#39;, version: &#39;2.1.1&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;* querydsl *&#x2F;</span><br><span class="line">def generated&#x3D;&#39;src&#x2F;main&#x2F;generated&#39;</span><br><span class="line">sourceSets &#123;</span><br><span class="line">    main.java.srcDirs +&#x3D; [ generated ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    options.annotationProcessorGeneratedSourcesDirectory &#x3D; file(generated)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clean.doLast &#123;</span><br><span class="line">    file(generated).deleteDir()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-application-domain-yml"><a href="#3-2-application-domain-yml" class="headerlink" title="3-2. application-domain.yml"></a>3-2. application-domain.yml</h3><p>이건 restClient로 연결할 도메인의 주소를 넣은부분이다. </p>
<figure class="highlight plain"><figcaption><span>domain.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v-ocs:</span><br><span class="line">  api-hosts:</span><br><span class="line">    shipping-api: http:&#x2F;&#x2F;s-api-local.codexdawn.com:8080</span><br><span class="line">    front-api: http:&#x2F;&#x2F;front-api-dev.codexdawn.com</span><br></pre></td></tr></table></figure>

<h3 id="3-3-DB-설정-구성"><a href="#3-3-DB-설정-구성" class="headerlink" title="3-3. DB 설정 구성"></a>3-3. DB 설정 구성</h3><h4 id="DBConstant"><a href="#DBConstant" class="headerlink" title="DBConstant"></a>DBConstant</h4><figure class="highlight java"><figcaption><span>DBConstant</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBConstant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Escrow</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">&quot;escrow&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRANSACTION = <span class="string">&quot;escrowTransactionManager&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 다른 DB가 있으면 위와 동일한 내용으로 추가해주면됨.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DBConfig"><a href="#DBConfig" class="headerlink" title="DBConfig"></a>DBConfig</h4><figure class="highlight java"><figcaption><span>DBConfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.google.common.collect.Maps.newHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.configuration.db.DBConstant.Escrow;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.repository.escrow.EscrowRepository;</span><br><span class="line"><span class="keyword">import</span> com.zaxxer.hikari.HikariDataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManagerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.orm.jpa.EntityManagerFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AdviceMode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.LazyConnectionDataSourceProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackageClasses = EscrowRepository.class, entityManagerFactoryRef = &quot;escrowEntityManagerFactory&quot;)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true, mode = AdviceMode.PROXY)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EscrowDBConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.escrow-master&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">escrowMasterDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().type(HikariDataSource.class).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.escrow-slave&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">escrowSlaveDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().type(HikariDataSource.class).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">escrowNamedRoutingDataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;escrowMasterDataSource&quot;)</span> DataSource master, <span class="meta">@Qualifier(&quot;escrowSlaveDataSource&quot;)</span> DataSource slave)</span> </span>&#123;</span><br><span class="line">        NamedRoutingDataSource namedRoutingDataSource = <span class="keyword">new</span> NamedRoutingDataSource();</span><br><span class="line">        Map&lt;Object, Object&gt; datasourceMap = newHashMap();</span><br><span class="line">        datasourceMap.put(<span class="string">&quot;master&quot;</span>,master);</span><br><span class="line">        datasourceMap.put(<span class="string">&quot;slave&quot;</span>,slave);</span><br><span class="line">        namedRoutingDataSource.setTargetDataSources(datasourceMap);</span><br><span class="line">        namedRoutingDataSource.setDefaultTargetDataSource(master);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> namedRoutingDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">escrowDataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;escrowNamedRoutingDataSource&quot;)</span> DataSource namedRoutingDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyConnectionDataSourceProxy(namedRoutingDataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EntityManagerFactoryBuilder <span class="title">escrowEntityManagerFactoryBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntityManagerFactoryBuilder(<span class="keyword">new</span> HibernateJpaVendorAdapter(), <span class="keyword">new</span> HashMap&lt;&gt;(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;escrowEntityManagerFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">escrowEntityManagerFactory</span><span class="params">(<span class="meta">@Qualifier(&quot;escrowEntityManagerFactoryBuilder&quot;)</span> EntityManagerFactoryBuilder builder</span></span></span><br><span class="line"><span class="function"><span class="params">        , <span class="meta">@Qualifier(&quot;escrowDataSource&quot;)</span> DataSource dataSource</span></span></span><br><span class="line"><span class="function"><span class="params">        , Map&lt;String,String&gt; jpaProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.dataSource(dataSource).packages(EscrowRepository.class).persistenceUnit(Escrow.NAME).properties(jpaProperties).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = Escrow.TRANSACTION)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">escrowTransactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;escrowEntityManagerFactory&quot;)</span>EntityManagerFactory entityManagerFactory)</span> </span>&#123;</span><br><span class="line">        JpaTransactionManager jtm = <span class="keyword">new</span> JpaTransactionManager();</span><br><span class="line">        jtm.setEntityManagerFactory(entityManagerFactory);</span><br><span class="line">        <span class="keyword">return</span> jtm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jpaProperties&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,String&gt; <span class="title">jpaProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String,String&gt; properties = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.show_sql&quot;</span>,environment.getProperty(<span class="string">&quot;spring.jpa.properties.hibernate.show_sql&quot;</span>));</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.format_sql&quot;</span>,environment.getProperty(<span class="string">&quot;hibernate.format_sql&quot;</span>));</span><br><span class="line">        properties.put(<span class="string">&quot;hibernate.use_sql_comments&quot;</span>,environment.getProperty(<span class="string">&quot;spring.jpa.properties.hibernate.use_sql_comments&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="NameRoutingDataSource"><a href="#NameRoutingDataSource" class="headerlink" title="NameRoutingDataSource"></a>NameRoutingDataSource</h4><figure class="highlight java"><figcaption><span>NameRoutingDataSource</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.support.TransactionSynchronizationManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TransactionSynchronizationManager.isCurrentTransactionReadOnly()</span><br><span class="line">            ? <span class="string">&quot;slave&quot;</span> : <span class="string">&quot;master&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="QueryDslConfig"><a href="#QueryDslConfig" class="headerlink" title="QueryDslConfig"></a>QueryDslConfig</h4><figure class="highlight java"><figcaption><span>QueryDslConfig</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wemakeprice.v.shipping.domain.configuration.db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.querydsl.jpa.impl.JPAQueryFactory;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.configuration.db.DbConstant.Benefit;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.configuration.db.DbConstant.Deal;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.configuration.db.DbConstant.Review;</span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.shipping.domain.configuration.db.DbConstant.VContent;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManager;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.PersistenceContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryDslConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext(unitName = VContent.NAME)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext(unitName = Deal.NAME)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager dealEntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext(unitName = Review.NAME)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager reviewEntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext(unitName = Benefit.NAME)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager benefitEntityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">jpaQueryFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(entityManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">dealJpaQueryFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(dealEntityManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">reviewJpaQueryFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(reviewEntityManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPAQueryFactory <span class="title">benefitJpaQueryFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JPAQueryFactory(benefitEntityManager);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="VOcsDomainConfiguration"><a href="#VOcsDomainConfiguration" class="headerlink" title="VOcsDomainConfiguration"></a>VOcsDomainConfiguration</h4><figure class="highlight java"><figcaption><span>DBConstant</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.wemakeprice.v.ocs.domain.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wemakeprice.v.ocs.domain.VOcsDomain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaAuditing;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJpaAuditing</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses = VOcsDomain.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VOcsDomainConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/multimodule/m-4.png" alt="Domain 모듈 최종"></p>
<h2 id="4-Meta-모듈-구성"><a href="#4-Meta-모듈-구성" class="headerlink" title="4. Meta 모듈 구성"></a>4. Meta 모듈 구성</h2><p>프로젝트는 java gradle 로 만들어주고 root build.gradle에 프로젝트 의존관계 설정해야함.</p>
<figure class="highlight plain"><figcaption><span>build.gradle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id &#39;maven&#39;</span><br><span class="line">&#125;</span><br><span class="line">version &#x3D; &#39;1.0.0.RELEASE&#39;</span><br><span class="line"></span><br><span class="line">bootJar &#123;</span><br><span class="line">    enabled &#x3D; false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jar &#123;</span><br><span class="line">    &#x2F;&#x2F; manifest 설정</span><br><span class="line">    manifest &#123;</span><br><span class="line">        attributes(&quot;Built-By&quot;: &quot;Gradle&quot;</span><br><span class="line">                , &quot;Implementation-Version&quot;: project.version)</span><br><span class="line">    &#125;</span><br><span class="line">    enabled &#x3D; true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; source.jar 설정</span><br><span class="line">task sourceJar(type: Jar, dependsOn: classes) &#123;</span><br><span class="line">    classifier &quot;source&quot;</span><br><span class="line">    from sourceSets.main.allSource</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">artifacts &#123;</span><br><span class="line">    archives jar</span><br><span class="line">    archives sourceJar</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uploadArchives &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenDeployer &#123;</span><br><span class="line">            repository(url: &#39;http:&#x2F;&#x2F;nexus.sys.wemakeprice.com&#x2F;content&#x2F;repositories&#x2F;releases&#x2F;&#39;) &#123;</span><br><span class="line">                authentication(userName: &#39;cft&#39;, password: &#39;0000&#39;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            snapshotRepository(url: &#39;http:&#x2F;&#x2F;nexus.sys.wemakeprice.com&#x2F;content&#x2F;repositories&#x2F;snapshots&#x2F;&#39;) &#123;</span><br><span class="line">                authentication(userName: &#39;cft&#39;, password: &#39;0000&#39;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/multimodule/m-5.png" alt="Domain 모듈 최종"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/01/multi-module-1/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/04/28/value-type/"
                            aria-label=": value-type"
                        >
                            value-type
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-04-28T13:53:22+00:00">
	
		    Apr 28, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B0%92%ED%83%80%EC%9E%85/">값타입</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="값-타입"><a href="#값-타입" class="headerlink" title="값 타입"></a>값 타입</h1><blockquote><p>JPA 데이터 분류 2가지</p>
<ol>
<li>엔티티 타입</li>
</ol>
<ul>
<li>@Entity로 정의하는 객체 </li>
<li>데이터가 변해도 식별자로 지속해서 추적 가능 </li>
</ul>
<ol start="2">
<li>값 타입 </li>
</ol>
<ul>
<li>int,long,String같은 단순히 값으로 사용하는 자바 기본 타입이나 객체 </li>
<li>식별자가 없으므로 추적 불가능 (숫자 100을 200으로 변경하면 완전히 다른 값으로 대체됨.)</li>
</ul>
<p>기본값 타입 3가지 </p>
<ul>
<li>기본값 타입 (자바 기본타입(int,double), 래퍼 클래스(Integer,Long), String)</li>
<li>임베디드 타입 (복합 값 타입)</li>
<li>컬렉션 값 타입 </li>
</ul>
</blockquote>

<h2 id="1-기본값-타입"><a href="#1-기본값-타입" class="headerlink" title="1. 기본값 타입"></a>1. 기본값 타입</h2><p><img src="/images/jpa/value-1.png" alt="기본값 타입"></p>
<h2 id="2-임베디드-타입-복합값-타입"><a href="#2-임베디드-타입-복합값-타입" class="headerlink" title="2. 임베디드 타입(복합값 타입)"></a>2. 임베디드 타입(복합값 타입)</h2><figure class="highlight java"><figcaption><span>임베디드타입 예제</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;Orders&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;order_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderAmount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;member_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Member member;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Embedded</span></span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;product_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Product product;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//getter,setter 생략</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgConstructor</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String street;</span><br><span class="line">    <span class="keyword">private</span> String zipcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="임베디드-타입-특징"><a href="#임베디드-타입-특징" class="headerlink" title="임베디드 타입 특징"></a>임베디드 타입 특징</h3><ul>
<li>int,String과 같은 값 타입 </li>
<li>주로 기본값 타입을 모아서 만들어서 복합 값 타입이라 부름 </li>
<li>새로운 값 타입을 직접 정의 가능 (응집도 높아짐에 따라 재사용성 증가)</li>
<li>Period.isWork 처럼 해당 값 타입만 사용하는 의미있는 메소드 만들수있음. </li>
<li>임베디드 타입을 포함한 모든 값 타입은 , 값 타입을 소유한 엔티티에 생명주기를 의존함. </li>
</ul>
<h3 id="임베디드-타입과-연관관계"><a href="#임베디드-타입과-연관관계" class="headerlink" title="임베디드 타입과 연관관계"></a>임베디드 타입과 연관관계</h3><p><img src="/images/jpa/value-2.png" alt="임베디드 타입과 연관관계"></p>
<ul>
<li>위 그림 처럼 entity는 여러 임베디드 타입을 가질수있으며, 임베디드타입은 다른 엔티티를 가질수 있음. </li>
</ul>
<h3 id="AttributeOverride-속성-재정의"><a href="#AttributeOverride-속성-재정의" class="headerlink" title="@AttributeOverride: 속성 재정의"></a>@AttributeOverride: 속성 재정의</h3><ul>
<li>한 엔티티에 같은 임베디드 타입을 사용하면? 컬럼명이 중복되서 에러남. </li>
<li>@AttributeOverrides, @AttributeOverride를 사용해서 컬러 명 속성을 재정의 (homeAddress,workAddress)</li>
</ul>
<h3 id="임베디드-타입과-null"><a href="#임베디드-타입과-null" class="headerlink" title="임베디드 타입과 null"></a>임베디드 타입과 null</h3><ul>
<li>임베디드 타입의 값이 null이면 매핑한 컬럼 모두 null로 세팅됨 (member.setAddress(null))</li>
</ul>
<h2 id="3-값-타입과-불변-객체"><a href="#3-값-타입과-불변-객체" class="headerlink" title="3. 값 타입과 불변 객체"></a>3. 값 타입과 불변 객체</h2><blockquote><p>값 타입은 복잡한 객체 세상을 조금이라도 단순화하려고 만든 개념이다. 따라서 값 타입은 단순하고 안전하게 다 룰 수 있어야 한다.</p>
</blockquote>

<h3 id="값-타입-복사"><a href="#값-타입-복사" class="headerlink" title="값 타입 복사"></a>값 타입 복사</h3><p><img src="/images/jpa/value-3.png" alt="값 타입 공유 참조"><br><img src="/images/jpa/value-4.png" alt="값 타입 복사"></p>
<h3 id="객체-타입-한계"><a href="#객체-타입-한계" class="headerlink" title="객체 타입 한계"></a>객체 타입 한계</h3><p><img src="/images/jpa/value-5.png" alt="객체 타입 한계"><br><img src="/images/jpa/value-6.png" alt="객체 타입 한계 예시"></p>
<h3 id="불변객체"><a href="#불변객체" class="headerlink" title="불변객체"></a>불변객체</h3><p><img src="/images/jpa/value-7.png" alt="불변객체"></p>
<h2 id="4-값-타입-비교"><a href="#4-값-타입-비교" class="headerlink" title="4. 값 타입 비교"></a>4. 값 타입 비교</h2><p><img src="/images/jpa/value-8.png" alt="값 타입 비교"></p>
<h2 id="5-값-타입-컬렉션"><a href="#5-값-타입-컬렉션" class="headerlink" title="5. 값 타입 컬렉션"></a>5. 값 타입 컬렉션</h2><ul>
<li>결론부터 이야기하면 <strong>값 타입 컬렉션은 가급적 피하는것이 좋다.</strong>  </li>
<li>값타입 특성상 엔티티 처럼 추적이 불가능하기때문에, 일부 row를 수정하려고 하면, 해당 키값의 포함된 모든 데이터를 지우고 다시 생성한다. </li>
<li>값 타입 컬렉션 대신 값타입을 엔티티로 승격시키고, <strong>cacade + 고아객체(orhanremoval)</strong> 로 주 엔티티에서 관리하도록 만들어서 관리해야함.</li>
<li>값 타입 컬렉션은 정말 단순한 데이터를 저장할때 쓴다. (예를들면 멀티셀렉트박스로 선택한 값들을 단순 저장할때.)</li>
</ul>
<h3 id="값-타입-사용시-주의사항"><a href="#값-타입-사용시-주의사항" class="headerlink" title="값 타입 사용시 주의사항"></a>값 타입 사용시 주의사항</h3><ul>
<li>값 타입은 정말 값 타입이라 판단될 때만 사용</li>
<li>엔티티와 값 타입을 혼동해서 엔티티를 값 타입으로 만들면 안됨</li>
<li>식별자가 필요하고, 지속해서 값을 추적, 변경해야 한다면 그것 은 값 타입이 아닌 엔티티</li>
</ul>
<h3 id="값-타입-컬렉션-소개"><a href="#값-타입-컬렉션-소개" class="headerlink" title="값 타입 컬렉션 소개"></a>값 타입 컬렉션 소개</h3><p><img src="/images/jpa/collection-value-1.png" alt="값 타입 컬렉션 소개1"><br><img src="/images/jpa/collection-value-2.png" alt="값 타입 컬렉션 소개2"></p>
<h3 id="값-타입-컬렉션의-제약사항"><a href="#값-타입-컬렉션의-제약사항" class="headerlink" title="값 타입 컬렉션의 제약사항"></a>값 타입 컬렉션의 제약사항</h3><p><img src="/images/jpa/collection-value-3.png" alt="값 타입 컬렉션의 제약사항"></p>
<h3 id="값-타입-컬렉션의-대안"><a href="#값-타입-컬렉션의-대안" class="headerlink" title="값 타입 컬렉션의 대안"></a>값 타입 컬렉션의 대안</h3><p><img src="/images/jpa/collection-value-4.png" alt="값 타입 컬렉션 대안"></p>
<h3 id="값-타입-정리"><a href="#값-타입-정리" class="headerlink" title="값 타입 정리"></a>값 타입 정리</h3><p><img src="/images/jpa/collection-value-5.png" alt="값 타입 정리"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/04/28/value-type/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/04/21/proxy-relational/"
                            aria-label=": proxy-relational"
                        >
                            proxy-relational
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-04-21T05:40:23+00:00">
	
		    Apr 21, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>, <a class="category-link" href="/categories/%ED%94%84%EB%A1%9D%EC%8B%9C%EC%99%80-%EC%97%B0%EA%B4%80%EA%B4%80%EA%B3%84-%EA%B4%80%EB%A6%AC/">프록시와 연관관계 관리</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="프록시와-연관관계-관리"><a href="#프록시와-연관관계-관리" class="headerlink" title="프록시와 연관관계 관리"></a>프록시와 연관관계 관리</h1><h2 id="1-프록시"><a href="#1-프록시" class="headerlink" title="1. 프록시"></a>1. 프록시</h2><h3 id="1-1-프록시-기초"><a href="#1-1-프록시-기초" class="headerlink" title="1-1. 프록시 기초"></a>1-1. 프록시 기초</h3><p>JPA에서 식별자로 엔티티 하나를 조회할 때는 EntityManager.find()를 사용한다. 이 메소드는 Persistance Context에 엔티티가 없으면 DB를 조회 한다. 이렇게 엔티티를 직접 조회하면 조회한 엔티티를 실제 사용하든 사용하지 않든 DB를 조회하게 된다. 엔티티를 실제 사용하는 시점까지 DB조회를 미루고싶으면 EntityManager.getReference()를 사용하면 된다. getReference로 호출할때 JPA는 DB조회를 하지 않고 실제 엔티티 객제도 생성 하지 않는다. 대신 DB접근을 위임한 프록시 객체를 반환한다. </p>
<p><img src="/images/jpa/proxy-1.png" alt="프록시 구조1"></p>
<p>위와 같이 프록시는 실제 클래스를 상속받아 사용되며, 실제클래스와 겉모양이 같음. 사용하는 입장에서는 진짜 객체인지 가짜객체인지 구분할 필요없이 그냥 사용하면 됨. (이론상)</p>
<p><img src="/images/jpa/proxy-2.png" alt="프록시 구조2"></p>
<p>위와 같이 프록시 객체는 실제 객체에 대한 참조를 보관하며, 프록시 객체의 메소드를 호출하면 프록시 객체는 실제 객체의 메소드를 호출한다. </p>
<h4 id="프록시-객체-초기화"><a href="#프록시-객체-초기화" class="headerlink" title="프록시 객체 초기화"></a>프록시 객체 초기화</h4><p><img src="/images/jpa/proxy-3.png" alt="프록시 객체 초기화"></p>
<h4 id="프록시-특징"><a href="#프록시-특징" class="headerlink" title="프록시 특징"></a>프록시 특징</h4><ul>
<li>프록시 객체는 처음 사용할때 한번만 호출됨</li>
<li>프록시 객체를 초기화한다고 프록시 객체가 실제 엔티티로 바뀌지는 않음.(프록시 객체가 초기화 되면 프록시 객체를 통해 실제 엔티티 접근한다.)</li>
<li>프록시 객체는 원본 엔티티를 상속받은 객체이므로 타입 체크시에 주의해서 사용해야함.(타입체크시 == 대신 instanceof 사용하자)</li>
<li>Persistance Context에 찾는 엔티티가 이미 있으면, DB를 조회할 이유가 없으므로,em.getReference()를 호출하더라도 프록시가 아닌 실제 엔티티를 반환함</li>
<li>초기화는 Persistance Context의 도움을 받아야함 따라서 Persistance Context의 도움을 받을수 없는 준영속 상태의 프록시를 초기화화면 문제가 발생함. (LazyInitializationException발생)</li>
</ul>
<h3 id="1-2-프록시와-식별자"><a href="#1-2-프록시와-식별자" class="headerlink" title="1-2. 프록시와 식별자"></a>1-2. 프록시와 식별자</h3><ul>
<li>엔티티 접근 방식을 @Access(AccessType.PROPERTY) 로 설정한경우 초기화 하지 않음</li>
<li>@Access(AccessType.FIELD)로 설정하면 JPA는 getId메소드가 id만 조회하는 메소드인지 다른 필드까지 활용해서 어떤 일을 하는 메소드인지 알지 못하므로 프록시 객체를 초기화 하게됨.</li>
<li>연관관계를 설정할때는 식별자 값만 사용하므로 프록시를 사용하면 DB접근 횟수를 줄일수있음. </li>
</ul>
<h3 id="1-3-프록시-확인"><a href="#1-3-프록시-확인" class="headerlink" title="1-3. 프록시 확인"></a>1-3. 프록시 확인</h3><ul>
<li>프록시 인스턴스의 초기화 여부 확인 (PersistenceUnitUtil.isLoaded(Object entity))</li>
<li>프록시 클래스 확인 방법 (entity.getClass().getName() 출력(..javasist.. or HibernateProxy…))</li>
<li>프록시 강제 초기화 (org.hibernate.Hibernate.initialize(entity);)</li>
<li>참고: JPA 표준은 강제 초기화 없음 (강제 호출: member.getName())</li>
</ul>
<h2 id="2-즉시로딩-과-지연로딩"><a href="#2-즉시로딩-과-지연로딩" class="headerlink" title="2. 즉시로딩 과 지연로딩"></a>2. 즉시로딩 과 지연로딩</h2><p>지연 로딩(LAZY) : 연관된 엔티티를 프록시로 조회한다. 프록시를 실제 사용할때 초기화 하면서 데이터베이스를 조회한다.<br>즉시 로딩(EAGER) : 연관된 엔티티를 즉시 조회한다. 하이버네이트는 가능하면 SQL조인을 사용해서 한번에 조회한다. </p>
<p><img src="/images/jpa/fetch-1.png" alt="프록시와 즉시로딩 주의"></p>
<blockquote><p>[참고] JPQL에서 JOIN 할시 발생하는 이슈 </p>
<ul>
<li>select m from Member join m.team 이런 쿼리를 날리면 어떻게 될까? N+1 쿼리가 나간다. 중요한건 글로벌 fetch전략과 상관없이 N+1이 나간다는것에 초점이 있다. 이런 부분을 해결하기 위해서는 join fetch를 사용해서 한방에 쿼리가 나갈수 있도록 해야한다.  </li>
</ul>
</blockquote>

<p><img src="/images/jpa/fetch-2.png" alt="실무에서 fetch전략 활용 방법"></p>
<h2 id="3-영속성-전이-CASCADE"><a href="#3-영속성-전이-CASCADE" class="headerlink" title="3. 영속성 전이: CASCADE"></a>3. 영속성 전이: CASCADE</h2><p><img src="/images/jpa/cacade-1.png" alt="cacade 정의"><br><img src="/images/jpa/cacade-2.png" alt="cacade 사용방법"><br><img src="/images/jpa/cacade-3.png" alt="cacade 사용 주의점"></p>
<ul>
<li>CACADE는 보통 ALL/PERSIST 위주로 사용하며,그나마 REMOVE까지는 쓰고 그 외 나머지는 잘 사용안함. </li>
</ul>
<h2 id="4-고아-객체"><a href="#4-고아-객체" class="headerlink" title="4. 고아 객체"></a>4. 고아 객체</h2><p><img src="/images/jpa/orhpan-1.png" alt="고아객체 정의"><br><img src="/images/jpa/orhpan-2.png" alt="고아객체 주의점"><br><img src="/images/jpa/orhpan-3.png" alt="cacade + 고아객체,생명주기"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/04/21/proxy-relational/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/04/19/high-end-mapping/"
                            aria-label=": high-end-mapping"
                        >
                            high-end-mapping
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-04-19T11:09:38+00:00">
	
		    Apr 19, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B3%A0%EA%B8%89-%EB%A7%A4%ED%95%91/">고급 매핑</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="고급매핑"><a href="#고급매핑" class="headerlink" title="고급매핑"></a>고급매핑</h1><blockquote><p>고급매핑에서 배울 내용들 정리 </p>
<ol>
<li>상속관계 매핑 : 객체의 상속관계를 DB에 어떻게 매핑하는지 </li>
<li>@MappedSuperclass : 등록일,수정일 같이 여러 엔티티에서 공통으로 사용하는 매핑정보만 상속받고 싶으면 이 기능을 활용한다. </li>
<li>복합키와 식별관계 매핑 : DB의 식별자가 하나 이상일때 매핑하는 방법. 그리고 DB설계에서 이야기하는 식별관계와 비식별관계에 대해서 다룬다. </li>
<li>조인 테이블 : 테이블은 외래키 하나로 연관관계를 맺을 수 있지만 연관관계를 관리하는 연결 테이블을 두는 방법도 있다. 여기서는 연결 테이블을 매핑하는 방법을 다룬다. </li>
<li>엔티티 하나에 여러 테이블 매핑하기 : 보통 엔티티 하나에 테이블 하나를 매핑하지만 엔티티 하나에 여러 테이블을 매핑하는 방법도 있다.   </li>
</ol>
</blockquote>

<h2 id="1-상속관계-매핑"><a href="#1-상속관계-매핑" class="headerlink" title="1. 상속관계 매핑"></a>1. 상속관계 매핑</h2><h3 id="1-1-조인-전략"><a href="#1-1-조인-전략" class="headerlink" title="1-1. 조인 전략"></a>1-1. 조인 전략</h3><p><img src="/images/jpa/join_inheritence.png" alt="조인전략 예시"></p>
<figure class="highlight java"><figcaption><span>조인전략예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Inheritance(strategy = Inheritence.JOINED)</span></span><br><span class="line"><span class="meta">@DiscriminatorColumn(name = &quot;DTYPE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name = &quot;item_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> price; </span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//...setter/getter생략</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="meta">@DiscriminatorValue(&quot;A&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Album</span> <span class="keyword">extends</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String artist; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="meta">@DiscriminatorValue(&quot;M&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Movie</span> <span class="keyword">extends</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String director; </span><br><span class="line">	<span class="keyword">private</span> String actor; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="장점"><a href="#장점" class="headerlink" title="장점"></a>장점</h4><ul>
<li>테이블이 정규화 됨 </li>
<li>외래키 참조 무결성 제약조건을 활용할수 있다.</li>
<li>저장공간을 효율적으로 사용함 </li>
</ul>
<h4 id="단점"><a href="#단점" class="headerlink" title="단점"></a>단점</h4><ul>
<li>조회할때 조인이 많이 사용되므로 성능이 저하될수 있다. </li>
<li>조회 쿼리가 복잡하다. </li>
<li>데이터를 등록할 insert sql을 두번 실행됨. </li>
</ul>
<h3 id="1-2-단일-테이블-전략"><a href="#1-2-단일-테이블-전략" class="headerlink" title="1-2. 단일 테이블 전략"></a>1-2. 단일 테이블 전략</h3><p><img src="/images/jpa/singletable.png" alt="조인테이블 전략 예시"></p>
<figure class="highlight java"><figcaption><span>단일테이블 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Inheritance(strategy = Inheritence.SINGLE_TABLE)</span></span><br><span class="line"><span class="meta">@DiscriminatorColumn(name = &quot;DTYPE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name = &quot;item_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> price; </span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//...setter/getter생략</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="meta">@DiscriminatorValue(&quot;A&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Album</span> <span class="keyword">extends</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String artist; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="meta">@DiscriminatorValue(&quot;M&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Movie</span> <span class="keyword">extends</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String director; </span><br><span class="line">	<span class="keyword">private</span> String actor; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="장점-1"><a href="#장점-1" class="headerlink" title="장점"></a>장점</h4><ul>
<li>조인이 필요없으므로 일반적으로 조회성능이 빠름.</li>
<li>조회 쿼리가 단순해짐 </li>
</ul>
<h4 id="단점-1"><a href="#단점-1" class="headerlink" title="단점"></a>단점</h4><ul>
<li>자식 엔티티가 매핑한 컬럼은 모두 null을 허용해야한다.</li>
<li>단일 테이블에 모든것을 저장하므로 테이블이 커질수 있다. 상황에 따라서는 조회성능이 오히려 느려질수도 있음. </li>
</ul>
<h4 id="특징"><a href="#특징" class="headerlink" title="특징"></a>특징</h4><ul>
<li>구분 컬럼을 꼭 사용해야함. (@DiscriminatorColumn)</li>
<li>구분 컬럼 지정안하면 엔티티 이름으로 자동 지정됨. </li>
</ul>
<h3 id="1-3-구현-클래스마다-테이블-전략"><a href="#1-3-구현-클래스마다-테이블-전략" class="headerlink" title="1-3. 구현 클래스마다 테이블 전략"></a>1-3. 구현 클래스마다 테이블 전략</h3><p><img src="/images/jpa/table-per-concrete-class.png" alt="구현 클래스마다 테이블 전략"></p>
<figure class="highlight java"><figcaption><span>구현클래스마다 테이블 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Inheritance(strategy = Inheritence.TABLE_PER_CLASS)</span></span><br><span class="line"><span class="meta">@DiscriminatorColumn(name = &quot;DTYPE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name = &quot;item_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> price; </span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//...setter/getter생략</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Album</span> <span class="keyword">extends</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String artist; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Movie</span> <span class="keyword">extends</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String director; </span><br><span class="line">	<span class="keyword">private</span> String actor; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="장점-2"><a href="#장점-2" class="headerlink" title="장점"></a>장점</h4><ul>
<li>서브타입을 구분해서 처리할때 효과적 </li>
<li>not null 제약조건을 사용할수 있음.</li>
</ul>
<h4 id="단점-2"><a href="#단점-2" class="headerlink" title="단점"></a>단점</h4><ul>
<li>여러 자식 테이블을 함께 조회할때 성능이 느림(union사용해야함) </li>
<li>자식 테이블을 통합해서 관리하기 어려움 </li>
</ul>
<h4 id="특징-1"><a href="#특징-1" class="headerlink" title="특징"></a>특징</h4><ul>
<li>구분 컬럼을 사용안함</li>
<li>일반적으로 사용안하길 권장되는 전략 </li>
</ul>
<h2 id="2-MappedSuperclass"><a href="#2-MappedSuperclass" class="headerlink" title="2. @MappedSuperclass"></a>2. @MappedSuperclass</h2><p><img src="/images/jpa/mappedsuperclass.png" alt="@MappedSuperClass"></p>
<figure class="highlight java"><figcaption><span>MappedSuperClass예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MappedSuperClass</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line"></span><br><span class="line">	<span class="comment">//...setter/getter생략</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@AttributeOverrides(</span></span><br><span class="line"><span class="meta">	@AttributeOverride(name = &quot;id&quot;, column= @Column(name = &quot;member_id&quot;)),</span></span><br><span class="line"><span class="meta">	@AttributeOverride(name = &quot;name&quot;, column = @Column(name=&quot;member_name&quot;))</span></span><br><span class="line"><span class="meta">)</span> <span class="comment">// 부모로부터 물려받은 매핑정보를 재정의 위와 같이 재정의 할수 있음. </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String email; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Seller</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String shopName; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="특징-2"><a href="#특징-2" class="headerlink" title="특징"></a>특징</h4><ul>
<li>상속관계 매핑이 아니다. </li>
<li>@MappedSuperClass로 지정된 클래스는 엔티티가 아니므로, em.find 혹은 JPQL 조회 불가능 하다.</li>
<li>부모 클래스를 상속받는 자식클래스에 매핑정보만 제공 </li>
<li>이 클래스를 직접 사용할일이 없기때문에 추상클래스로 만드는걸 권장함 </li>
<li>테이블과 관계없고 단순히 엔티티가 공통으로 사용하는 매핑정보를 모으는 역할 </li>
<li>주로 등록일, 수정일, 등록자, 수정자 같은 전체 엔티티에서 공통으로 적용하는 정보를 모을때 사용 </li>
<li>참고 : @Entity 클래스는 엔티티나 @MappedSuperClass로 지정한 클래스만 사속 가능 </li>
</ul>
<h2 id="3-복합키와-식별관계-매핑"><a href="#3-복합키와-식별관계-매핑" class="headerlink" title="3. 복합키와 식별관계 매핑"></a>3. 복합키와 식별관계 매핑</h2><h3 id="3-1-식별관계-VS-비식별관계"><a href="#3-1-식별관계-VS-비식별관계" class="headerlink" title="3-1. 식별관계 VS 비식별관계"></a>3-1. 식별관계 VS 비식별관계</h3><h4 id="식별관계"><a href="#식별관계" class="headerlink" title="식별관계"></a>식별관계</h4><ul>
<li>식별관계는 부모 테이블의 기본키를 내려받아서 자식테이블의 (기본키+외래키) 로 사용하는 관계 </li>
</ul>
<h4 id="비식별관계"><a href="#비식별관계" class="headerlink" title="비식별관계"></a>비식별관계</h4><ul>
<li>부모테이블의 기본키를 받아서 자식 테이블의 외래키로만 사용하는 관계 </li>
</ul>
<h5 id="3-1-1-복합키-비식별-관계-매핑"><a href="#3-1-1-복합키-비식별-관계-매핑" class="headerlink" title="3-1-1. 복합키 : 비식별 관계 매핑"></a>3-1-1. 복합키 : 비식별 관계 매핑</h5><p>JPA는 복합키 지원을 위해 @IdClass와 @EmbeddedId 2가지 방법을 제공하는데 @IdClass는 관계형데이터베이스에 가까운 방법이고, @EmbeddedId는 좀 더 객체지향에 가까운 방법이다. </p>
<h6 id="IdClass"><a href="#IdClass" class="headerlink" title="@IdClass"></a>@IdClass</h6><figure class="highlight java"><figcaption><span>복합키 IdClass예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@IdClass(ParentId.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> </span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id1&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String id1;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> </span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id2&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String id2;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParentId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="comment">//식별자 클래스의 속성명과 엔티티에서 사용하는 식별자의 속성명이 같아야함!! </span></span><br><span class="line">	<span class="keyword">private</span> String id1;</span><br><span class="line">	<span class="keyword">private</span> String id2; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//기본생성자 필수</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ParentId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ParentId</span><span class="params">(String id1, String id2)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id1 = id1;</span><br><span class="line">		<span class="keyword">this</span>.id2 = id2; </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//equals &amp; hashcode 는 반드시 구현되어야함.</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;...&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//저장</span></span><br><span class="line">Parent p = <span class="keyword">new</span> Parent();</span><br><span class="line">p.setId1(<span class="string">&quot;id1&quot;</span>);</span><br><span class="line">p.setId2(<span class="string">&quot;id2&quot;</span>);</span><br><span class="line">p.setName(<span class="string">&quot;pName&quot;</span>);</span><br><span class="line">em.persist(p);</span><br><span class="line"></span><br><span class="line"><span class="comment">//조회 </span></span><br><span class="line">ParentId pid = <span class="keyword">new</span> ParentId(<span class="string">&quot;id1&quot;</span>,<span class="string">&quot;id2&quot;</span>);</span><br><span class="line">Parent p = em.find(Parent.class,parentId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="keyword">private</span> String id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="meta">@JoinColumns(&#123;</span></span><br><span class="line"><span class="meta">		@JoinColumn(name = &quot;parent_id1&quot;, referenceColumnName = &quot;parent_id1&quot;),</span></span><br><span class="line"><span class="meta">		@JoinColumn(name = &quot;parent_id2&quot;, referenceColumnName = &quot;parent_id2&quot;)</span></span><br><span class="line"><span class="meta">	&#125;)</span></span><br><span class="line">	<span class="keyword">private</span> Parent parent; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="EmbeddedId"><a href="#EmbeddedId" class="headerlink" title="EmbeddedId"></a>EmbeddedId</h6><figure class="highlight java"><figcaption><span>복합키 EmbeddedId 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@IdClass(ParentId.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@EmbeddedId</span> </span><br><span class="line">	<span class="keyword">private</span> ParentId id2;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParentId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="comment">//식별자 클래스의 속성명과 엔티티에서 사용하는 식별자의 속성명이 같아야함!! </span></span><br><span class="line">	<span class="meta">@Column(name = &quot;parent_id1&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String id1;</span><br><span class="line">	<span class="meta">@Column(name = &quot;parent_id2&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String id2; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//기본생성자 필수</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ParentId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ParentId</span><span class="params">(String id1, String id2)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id1 = id1;</span><br><span class="line">		<span class="keyword">this</span>.id2 = id2; </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//equals &amp; hashcode 는 반드시 구현되어야함.</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;...&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//저장</span></span><br><span class="line">Parent p = <span class="keyword">new</span> Parent();</span><br><span class="line">ParentId pid = <span class="keyword">new</span> ParentId(<span class="string">&quot;id1&quot;</span>,<span class="string">&quot;id2&quot;</span>);</span><br><span class="line">p.setId(pid);</span><br><span class="line">p.setName(<span class="string">&quot;pName&quot;</span>);</span><br><span class="line">em.persist(p);</span><br><span class="line"></span><br><span class="line"><span class="comment">//조회 </span></span><br><span class="line">ParentId pid = <span class="keyword">new</span> ParentId(<span class="string">&quot;id1&quot;</span>,<span class="string">&quot;id2&quot;</span>);</span><br><span class="line">Parent p = em.find(Parent.class,parentId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="keyword">private</span> String id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="meta">@JoinColumns(&#123;</span></span><br><span class="line"><span class="meta">		@JoinColumn(name = &quot;parent_id1&quot;, referenceColumnName = &quot;parent_id1&quot;),</span></span><br><span class="line"><span class="meta">		@JoinColumn(name = &quot;parent_id2&quot;, referenceColumnName = &quot;parent_id2&quot;)</span></span><br><span class="line"><span class="meta">	&#125;)</span></span><br><span class="line">	<span class="keyword">private</span> Parent parent; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-1-2-복합키-식별-관계-매핑"><a href="#3-1-2-복합키-식별-관계-매핑" class="headerlink" title="3-1-2. 복합키 : 식별 관계 매핑"></a>3-1-2. 복합키 : 식별 관계 매핑</h5><p>복합키 식별관계 매핑은 부모,자식,손자까지 계속 기본 키를 전달하는 식별관계 이다. 식별 관계에서 자식 테이블은 부모 테이블의 기본 키를 포함해서 복합 키를 구성해야 하므로 @IdClass나 @EmbeddedId를 사용해서 식별자를 매핑해야한다. </p>
<h6 id="IdClass-1"><a href="#IdClass-1" class="headerlink" title="@IdClass"></a>@IdClass</h6><figure class="highlight java"><figcaption><span>복합키: 식별관계 매핑 IdClass 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> ParentId id2;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@IdClass(ChildId.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="meta">@JoinColumn(name = &quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Parent parent; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@Column(name = &quot;child_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String childId; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String parent; <span class="comment">//Child.parent 매핑</span></span><br><span class="line">	<span class="keyword">private</span> String childId; <span class="comment">//Child.childId 매핑</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//equals,hashcode 재정의 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="meta">@IdClass(GrandChildId.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChild</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="meta">@JoinColumns(&#123;</span></span><br><span class="line"><span class="meta">		@JoinColumn(name = &quot;parent_id&quot;),</span></span><br><span class="line"><span class="meta">		@JoinColumn(name = &quot;child_id&quot;)</span></span><br><span class="line"><span class="meta">	&#125;)</span></span><br><span class="line">	<span class="keyword">private</span> Child child;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@Column(name = &quot;GRANDCHILD_ID&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String id; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ChildId child; <span class="comment">//GrandChild.child 매핑</span></span><br><span class="line">	<span class="keyword">private</span> String id; <span class="comment">//GrandChild.id 매핑</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//equals,hashcode재정의 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="EmbeddedId-1"><a href="#EmbeddedId-1" class="headerlink" title="@EmbeddedId"></a>@EmbeddedId</h6><figure class="highlight java"><figcaption><span>복합키: 식별관계 매핑 EmbeddedId 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> ParentId id2;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@IdClass(ChildId.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@EmbeddedId</span></span><br><span class="line">	<span class="keyword">private</span> String childId; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@MapsId(&quot;parentId&quot;)</span></span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="meta">@JoinColumn(name = &quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Parent parent; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String parent; <span class="comment">//MapsId(&quot;parentId&quot;) 매핑</span></span><br><span class="line">	<span class="keyword">private</span> String childId; <span class="comment">//Child.childId 매핑</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//equals,hashcode 재정의 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChild</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@EmbeddedId</span></span><br><span class="line">	<span class="keyword">private</span> GrandChildId id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@MapsId(&quot;childId&quot;)</span></span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="meta">@JoinColumns(&#123;</span></span><br><span class="line"><span class="meta">		@JoinColumn(name = &quot;parent_id&quot;),</span></span><br><span class="line"><span class="meta">		@JoinColumn(name = &quot;child_id&quot;)</span></span><br><span class="line"><span class="meta">	&#125;)</span></span><br><span class="line">	<span class="keyword">private</span> Child child;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChildId</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ChildId child; <span class="comment">//MapsId(&quot;childId&quot;) 매핑</span></span><br><span class="line">	<span class="keyword">private</span> String id; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//equals,hashcode재정의 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-1-3-비식별-관계-매핑-복합키-X"><a href="#3-1-3-비식별-관계-매핑-복합키-X" class="headerlink" title="3-1-3. 비식별 관계 매핑 : 복합키 X"></a>3-1-3. 비식별 관계 매핑 : 복합키 X</h5><figure class="highlight java"><figcaption><span>비식별관계 매핑 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;child_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="meta">@JoinColumn(name = &quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Parent parent; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrandChild</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name =&quot;grandchild_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="meta">@JoinColumn(name=&quot;child_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Child child;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-1-4-일대일-식별관계"><a href="#3-1-4-일대일-식별관계" class="headerlink" title="3-1-4 일대일 식별관계"></a>3-1-4 일대일 식별관계</h5><figure class="highlight java"><figcaption><span>일대일 식별관계</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Board</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span> </span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String title; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@OneToOne(mappedBy = &quot;borad&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> BoardDetail boardDetail; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardDetail</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="keyword">private</span> Long boardId;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@MapsId</span> <span class="comment">//BoardDetail.boardId 매핑 </span></span><br><span class="line">	<span class="meta">@OneToOne</span></span><br><span class="line">	<span class="meta">@JoinColumn(name = &quot;board_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Board board; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String content; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//저장 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Board board = <span class="keyword">new</span> Board(); </span><br><span class="line">	board.setTitle(<span class="string">&quot;제목&quot;</span>);</span><br><span class="line">	em.persist(board); </span><br><span class="line">	</span><br><span class="line">	BoardDetail boardDetail = <span class="keyword">new</span> BoardDetail();</span><br><span class="line">	boardDetail.setContent(<span class="string">&quot;내용&quot;</span>);</span><br><span class="line">	boardDetail.setBoard(board);</span><br><span class="line">	em.persist(boardDetail); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="4-조인-테이블"><a href="#4-조인-테이블" class="headerlink" title="4. 조인 테이블"></a>4. 조인 테이블</h2><h3 id="4-1-1-1-조인-테이블"><a href="#4-1-1-1-조인-테이블" class="headerlink" title="4-1. 1:1 조인 테이블"></a>4-1. 1:1 조인 테이블</h3><figure class="highlight java"><figcaption><span>1:1 조인테이블 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@OneToOne</span></span><br><span class="line">	<span class="meta">@JoinTable(name = &quot;parent_child&quot;)</span>, </span><br><span class="line">	joinColumns(name = <span class="meta">@JoinColumn(name = &quot;parent_id&quot;)</span>,</span><br><span class="line">	inverseJoinColumns(name=<span class="string">&quot;child_id&quot;</span>))</span><br><span class="line">	<span class="keyword">private</span> Child child; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;child_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 양방향 연관관계 매핑 하려면 아래코드작성 </span></span><br><span class="line"><span class="comment">	@OneToOne(mappedBy=&quot;child&quot;)</span></span><br><span class="line"><span class="comment">	private Parent parent; </span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-1-N-조인-테이블"><a href="#4-2-1-N-조인-테이블" class="headerlink" title="4-2. 1:N 조인 테이블"></a>4-2. 1:N 조인 테이블</h3><figure class="highlight java"><figcaption><span>1:N 조인테이블 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@OneToMany</span></span><br><span class="line">	<span class="meta">@JoinTable(name = &quot;parent_child&quot;)</span>, </span><br><span class="line">	joinColumns(name = <span class="meta">@JoinColumn(name = &quot;parent_id&quot;)</span>,</span><br><span class="line">	inverseJoinColumns(name=<span class="string">&quot;child_id&quot;</span>))</span><br><span class="line">	<span class="keyword">private</span> List&lt;Child&gt; child = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;child_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-N-1-조인-테이블"><a href="#4-3-N-1-조인-테이블" class="headerlink" title="4-3. N:1 조인 테이블"></a>4-3. N:1 조인 테이블</h3><figure class="highlight java"><figcaption><span>N:1 조인테이블 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@OneToMany(mappedBy = &quot;parent&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;Child&gt; child = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;child_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne(optional=false)</span></span><br><span class="line">	<span class="meta">@JoinTable(name = &quot;parent_child&quot;)</span>, </span><br><span class="line">	joinColumns(name = <span class="meta">@JoinColumn(name = &quot;child_id&quot;)</span>,</span><br><span class="line">	inverseJoinColumns(name=<span class="string">&quot;parent_id&quot;</span>))</span><br><span class="line">	<span class="keyword">private</span> Parent parent;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-3-N-M-조인-테이블"><a href="#4-3-N-M-조인-테이블" class="headerlink" title="4-3. N:M 조인 테이블"></a>4-3. N:M 조인 테이블</h3><figure class="highlight java"><figcaption><span>N:M 조인테이블 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;parent_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToMany</span></span><br><span class="line">	<span class="meta">@JoinTable(name = &quot;parent_child&quot;)</span>, </span><br><span class="line">	joinColumns(name = <span class="meta">@JoinColumn(name = &quot;parent_id&quot;)</span>,</span><br><span class="line">	inverseJoinColumns(name=<span class="string">&quot;child_id&quot;</span>))</span><br><span class="line">	<span class="keyword">private</span> List&lt;Child&gt; child = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Child클래스</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">	<span class="meta">@Column(name=&quot;child_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	<span class="keyword">private</span> String name; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/04/19/high-end-mapping/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a
                class="btn btn--default btn--small"
                href="/archives/2021/page/2/"
                aria-label="OLDER POSTS"
            >
              <span>OLDER POSTS</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">page 1 of 4</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2021 codexdawn. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">codexdawn</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover-v1.2.0.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-ikbi0v8fyzuu91xv5rmpcrnwb4qinfgborzd5kejmj8wr6ibfra8oaxqshyg.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
