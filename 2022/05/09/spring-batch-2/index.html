
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="codexdawn">
    <title>spring-batch-2 - codexdawn</title>
    <meta name="author" content="codexdawn">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"codexdawn","sameAs":["https://github.com/codexdawn","https://www.facebook.com/beherzt.dev","https://www.linkedin.com/in/sim-jisung-3048872a/","mailto:cloudkaiser@gmail.com"],"image":"https://www.gravatar.com/avatar/d97fd4b94c429915f1cb55eb27e7d4d9"},"articleBody":"스프링 배치 삽질기 2탄 (배치 분기 및 상태관리 해버리기!)배경브랜드 랭킹를 기존에는 한세트만 세팅해서 랭킹을 보여줬지만, 외부의 요청에따라 다양한 가중치를 주고싶다고 요청을 받아서 배치판 AB테스트를 적용해야했다.예를들어 A-D타입까지 각기다른 가중치가 설정되어있다면 (가중치 설정 어드민에서 설정했다고 가정) 배치에서는 4번의 각기 다른 가중치로 계산된 데이터가 적재되어야할것이다.따라서 A-D까지 분기및반복 처리가 요구되어 적용하려고 하였으나, tasklet 방식으로 적용하면 간단하게 로직을 집어넣어주면 되지만, chunk단위 방식으로는 if-else 로직을 직접 넣을수없고,chunk단위 배치만의 분기 처리 방식이 따로 존재하는걸 알게되었고, 거기서부터 내 삽질이 시작되었다. 젠장적는 시점은 개발한지 한참뒤라서 기억이 많이 안난다… 그냥 정리해둬보는걸로… \n적용방법batch내 분기 처리123456789101112131415161718192021222324252627private final JobExecutionDecider brandDecider;private final ExecutionContextPromotionListener promotionListener;@Bean(BRAND_RANK_JOB_NAME)   public Job brandRankJob() &#123;       return jobBuilderFactory.get(BRAND_RANK_JOB_NAME)           .incrementer(new UniqueRunIdIncrementer())           .start(saveStep())           .next(brandDecider)               .on(&quot;COMPLETE&quot;).to(removeStep())               .from(brandDecider)               .on(&quot;CONTINUE&quot;).to(saveStep()).end()           .build();   &#125;@Bean(SAVE_STEP_NAME)   public Step saveStep() &#123;       return stepBuilderFactory.get(SAVE_STEP_NAME)           .&lt;VBrandWSinEntity, BrandRankEntity&gt;chunk(CHUNK_SIZE)           .reader(saveReader())           .processor(brandRankSaveProcessor)           .writer(brandRankSaveWriter)           .listener(promotionListener)           .build();   &#125;\n\n\n분기처리를 하려면 상태를 결정하는 상태설정 클래스를 만들어야한다. 해당 부분은 바로 아래 코드에 명시되어있다. \n기본적인 구조는 on (상태명) /to (해당 상태를 결정하는 action) /from (else if 조건) /end (분기 flow 종료)  \n\nstep간 데이터 공유를 위한 설정123456789101112@Configuration@RequiredArgsConstructorpublic class PromotionListenerConfiguration &#123;    @Bean    public ExecutionContextPromotionListener promotionListener() &#123;        ExecutionContextPromotionListener executionContextPromotionListener = new ExecutionContextPromotionListener();        executionContextPromotionListener.setKeys(new String[]&#123;&quot;status&quot;&#125;);        return executionContextPromotionListener;    &#125;&#125;\n\n\nstep간에 상태를 공유하려면 ExecutionContextPromotionListener 를 설정 해줘야 한다.\n\n상태를결정하도록 설정하기123456789101112131415161718192021222324@Configuration@RequiredArgsConstructorpublic class DeciderConfiguration &#123;    private final WeightProvider weightProvider;    @Bean    public JobExecutionDecider brandDecider() &#123;        return getDecider(BRAND);    &#125;    private JobExecutionDecider getDecider(WeightServiceType serviceType) &#123;        return (jobExecution, stepExecution) -&gt; &#123;            jobExecution = stepExecution.getJobExecution();            ExecutionContext jobContext = jobExecution.getExecutionContext();\t\t\t// 코드 중략 \t\t\t            return new FlowExecutionStatus(&quot;CONTINUE&quot;);        &#125;;    &#125;&#125;\n\n\n위 코드는 A-D의 상태를 관리 한다고 했을때  4번의 상태가 존재하기때문에 4번 배치가 수행되어야한다. stepExecution내에서 Step내 상태를 확인할수있다. (exitStatus)\n최종 리턴결과는 상태를 job에서 처리결과를 FlowExecutionStatus에 담아서 리턴하면, job에서 on절로 체크가 가능하다. \n\n현재 적용된 상태를(step간 공유변수) 가져오는 방법참고\n상태를 관리하는 클래스123456789101112131415161718192021222324252627282930313233public class SuperStepExecution&lt;T&gt; &#123;    private StepExecution stepExecution;    protected void putData(String key, T data) &#123;        if (this.stepExecution == null) &#123;            throw new NullPointerException(&quot;StepExecution is null&quot;);        &#125;        ExecutionContext stepContext = this.stepExecution.getExecutionContext();        stepContext.put(key, data);    &#125;    protected Object getData(String key) &#123;        if (this.stepExecution == null) &#123;            throw new NullPointerException(&quot;StepExecution is null&quot;);        &#125;        JobExecution jobExecution = stepExecution.getJobExecution();        ExecutionContext jobContext = jobExecution.getExecutionContext();        return jobContext.get(key);    &#125;    protected void setStepExecution(StepExecution stepExecution) &#123;        this.stepExecution = stepExecution;    &#125;    protected StepExecution getStepExecution() &#123;        return this.stepExecution;    &#125;&#125;\n\n상태를 꺼내오는 부분123456789101112131415@Service@RequiredArgsConstructor@StepScopepublic class BrandRankSaveProcessor extends SuperStepExecution&lt;String&gt; implements ItemProcessor &lt;VBrandEntity,BrandRankEntity&gt; &#123;\t//코드중략 \tprivate String status;\t@BeforeStep\tpublic void saveStepExecution(StepExecution stepExecution) &#123;\t\tsuper.setStepExecution(stepExecution);\t\tthis.status = (String) super.getData(&quot;status&quot;);\t&#125;\t//코드중략&#125;\n\n\n위와 같이 stepExecution 사용하여 공유 데이터를 저장하고 가져오는것이 가능하다. \n\n기타 적용하면서 알게된 TMI\n브랜드랭킹 적용하면서 외부 API를 통해 데이터를 가져오는 부분이 많았는데, 이부분이 배치처리의 소요시간의 큰 타격을 줫었음. 처리가 다안되고 1번만 수행하고 배치가 뻗었었음. 그래서 기존 1000개씩 가져와서 했던 부분을 100개로 줄이니까 정상적으로 배치가 수행되었었음. \n가급적이면 api call로 데이터를 가져오는것보다 db로 데이터를 가져와서 처리하는 방식을 고려하도록 하자. 그도 그럴것이 한번 처리할때마다 api콜을 계속하기때문에 지연처리가 발생할수밖에 없었을것이다. \n브랜드배치 말고 베스트랭킹 부분을 step간 데이터공유부분의 소스를 공통으로 가져가려고 공통로직화 시켰는데, status가 static 변수라 좋은 엔지니어링방식을 하지못했었음. static으로 상태를 공유하는일은 극도로 조심해야할것이다.static처리했다가 베스트랭킹에서 상태 C까지 처리했더니 브랜드랭킹에서 A부터 시작해야하는데, D부터 시작하는 불상사가 발생함. \n\n","dateCreated":"2022-05-09T02:44:51+00:00","dateModified":"2022-06-08T08:18:31+00:00","datePublished":"2022-05-09T02:44:51+00:00","description":"","headline":"spring-batch-2","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://codexdawn.github.io/2022/05/09/spring-batch-2/"},"publisher":{"@type":"Organization","name":"codexdawn","sameAs":["https://github.com/codexdawn","https://www.facebook.com/beherzt.dev","https://www.linkedin.com/in/sim-jisung-3048872a/","mailto:cloudkaiser@gmail.com"],"image":"https://www.gravatar.com/avatar/d97fd4b94c429915f1cb55eb27e7d4d9","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/d97fd4b94c429915f1cb55eb27e7d4d9"}},"url":"https://codexdawn.github.io/2022/05/09/spring-batch-2/","keywords":"Java,JPA,Spring,Batch, Batch, querydsl"}</script>
    <meta name="description" content="스프링 배치 삽질기 2탄 (배치 분기 및 상태관리 해버리기!)배경브랜드 랭킹를 기존에는 한세트만 세팅해서 랭킹을 보여줬지만, 외부의 요청에따라 다양한 가중치를 주고싶다고 요청을 받아서 배치판 AB테스트를 적용해야했다.예를들어 A-D타입까지 각기다른 가중치가 설정되어있다면 (가중치 설정 어드민에서 설정했다고 가정) 배치에서는 4번의 각기 다른 가중치로 계산된">
<meta property="og:type" content="blog">
<meta property="og:title" content="spring-batch-2">
<meta property="og:url" content="https://codexdawn.github.io/2022/05/09/spring-batch-2/index.html">
<meta property="og:site_name" content="codexdawn">
<meta property="og:description" content="스프링 배치 삽질기 2탄 (배치 분기 및 상태관리 해버리기!)배경브랜드 랭킹를 기존에는 한세트만 세팅해서 랭킹을 보여줬지만, 외부의 요청에따라 다양한 가중치를 주고싶다고 요청을 받아서 배치판 AB테스트를 적용해야했다.예를들어 A-D타입까지 각기다른 가중치가 설정되어있다면 (가중치 설정 어드민에서 설정했다고 가정) 배치에서는 4번의 각기 다른 가중치로 계산된">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-05-09T02:44:51.000Z">
<meta property="article:modified_time" content="2022-06-08T08:18:31.390Z">
<meta property="article:author" content="codexdawn">
<meta property="article:tag" content="Java,JPA,Spring,Batch">
<meta property="article:tag" content="Batch">
<meta property="article:tag" content="querydsl">
<meta name="twitter:card" content="summary">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-3sspfygaapf5d6tbrnqmyrhdcstv0iwwmi4wor2yeip9c44sowy9gbdzyyjm.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            codexdawn
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/codexdawn"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.facebook.com/beherzt.dev"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/sim-jisung-3048872a/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:cloudkaiser@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            spring-batch-2
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2022-05-09T02:44:51+00:00">
	
		    May 09, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Batch/">Batch</a>, <a class="category-link" href="/categories/%EC%9C%A0%EB%A0%88%EC%B9%B4or%EC%82%BD%EC%A7%88/">유레카or삽질</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h1 id="스프링-배치-삽질기-2탄-배치-분기-및-상태관리-해버리기"><a href="#스프링-배치-삽질기-2탄-배치-분기-및-상태관리-해버리기" class="headerlink" title="스프링 배치 삽질기 2탄 (배치 분기 및 상태관리 해버리기!)"></a>스프링 배치 삽질기 2탄 (배치 분기 및 상태관리 해버리기!)</h1><h2 id="배경"><a href="#배경" class="headerlink" title="배경"></a>배경</h2><p>브랜드 랭킹를 기존에는 한세트만 세팅해서 랭킹을 보여줬지만, 외부의 요청에따라 다양한 가중치를 주고싶다고 요청을 받아서 배치판 AB테스트를 적용해야했다.<br>예를들어 A-D타입까지 각기다른 가중치가 설정되어있다면 (가중치 설정 어드민에서 설정했다고 가정) 배치에서는 4번의 각기 다른 가중치로 계산된 데이터가 적재되어야할것이다.<br>따라서 A-D까지 분기및반복 처리가 요구되어 적용하려고 하였으나, tasklet 방식으로 적용하면 간단하게 로직을 집어넣어주면 되지만, chunk단위 방식으로는 if-else 로직을 직접 넣을수없고,<br>chunk단위 배치만의 분기 처리 방식이 따로 존재하는걸 알게되었고, 거기서부터 내 삽질이 시작되었다. 젠장<br>적는 시점은 개발한지 한참뒤라서 기억이 많이 안난다… 그냥 정리해둬보는걸로… </p>
<h2 id="적용방법"><a href="#적용방법" class="headerlink" title="적용방법"></a>적용방법</h2><figure class="highlight java"><figcaption><span>batch내 분기 처리</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> JobExecutionDecider brandDecider;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExecutionContextPromotionListener promotionListener;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(BRAND_RANK_JOB_NAME)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Job <span class="title">brandRankJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> jobBuilderFactory.get(BRAND_RANK_JOB_NAME)</span><br><span class="line">           .incrementer(<span class="keyword">new</span> UniqueRunIdIncrementer())</span><br><span class="line">           .start(saveStep())</span><br><span class="line">           .next(brandDecider)</span><br><span class="line">               .on(<span class="string">&quot;COMPLETE&quot;</span>).to(removeStep())</span><br><span class="line">               .from(brandDecider)</span><br><span class="line">               .on(<span class="string">&quot;CONTINUE&quot;</span>).to(saveStep()).end()</span><br><span class="line">           .build();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(SAVE_STEP_NAME)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Step <span class="title">saveStep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> stepBuilderFactory.get(SAVE_STEP_NAME)</span><br><span class="line">           .&lt;VBrandWSinEntity, BrandRankEntity&gt;chunk(CHUNK_SIZE)</span><br><span class="line">           .reader(saveReader())</span><br><span class="line">           .processor(brandRankSaveProcessor)</span><br><span class="line">           .writer(brandRankSaveWriter)</span><br><span class="line">           .listener(promotionListener)</span><br><span class="line">           .build();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>분기처리를 하려면 상태를 결정하는 상태설정 클래스를 만들어야한다. 해당 부분은 바로 아래 코드에 명시되어있다. </li>
<li>기본적인 구조는 on (상태명) /to (해당 상태를 결정하는 action) /from (else if 조건) /end (분기 flow 종료)  </li>
</ul>
<figure class="highlight java"><figcaption><span>step간 데이터 공유를 위한 설정</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PromotionListenerConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ExecutionContextPromotionListener <span class="title">promotionListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ExecutionContextPromotionListener executionContextPromotionListener = <span class="keyword">new</span> ExecutionContextPromotionListener();</span><br><span class="line">        executionContextPromotionListener.setKeys(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;status&quot;</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> executionContextPromotionListener;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>step간에 상태를 공유하려면 ExecutionContextPromotionListener 를 설정 해줘야 한다.</li>
</ul>
<figure class="highlight java"><figcaption><span>상태를결정하도록 설정하기</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeciderConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeightProvider weightProvider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobExecutionDecider <span class="title">brandDecider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getDecider(BRAND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JobExecutionDecider <span class="title">getDecider</span><span class="params">(WeightServiceType serviceType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (jobExecution, stepExecution) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            jobExecution = stepExecution.getJobExecution();</span><br><span class="line">            ExecutionContext jobContext = jobExecution.getExecutionContext();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 코드 중략 </span></span><br><span class="line">			</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FlowExecutionStatus(<span class="string">&quot;CONTINUE&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>위 코드는 A-D의 상태를 관리 한다고 했을때  4번의 상태가 존재하기때문에 4번 배치가 수행되어야한다. stepExecution내에서 Step내 상태를 확인할수있다. (exitStatus)</li>
<li>최종 리턴결과는 상태를 job에서 처리결과를 FlowExecutionStatus에 담아서 리턴하면, job에서 on절로 체크가 가능하다. </li>
</ul>
<h3 id="현재-적용된-상태를-step간-공유변수-가져오는-방법"><a href="#현재-적용된-상태를-step간-공유변수-가져오는-방법" class="headerlink" title="현재 적용된 상태를(step간 공유변수) 가져오는 방법"></a>현재 적용된 상태를(step간 공유변수) 가져오는 방법</h3><p><a target="_blank" rel="noopener" href="https://wckhg89.github.io/archivers/springbatch1">참고</a></p>
<figure class="highlight java"><figcaption><span>상태를 관리하는 클래스</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuperStepExecution</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> StepExecution stepExecution;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">putData</span><span class="params">(String key, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.stepExecution == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;StepExecution is null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ExecutionContext stepContext = <span class="keyword">this</span>.stepExecution.getExecutionContext();</span><br><span class="line">        stepContext.put(key, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">getData</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.stepExecution == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;StepExecution is null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        JobExecution jobExecution = stepExecution.getJobExecution();</span><br><span class="line">        ExecutionContext jobContext = jobExecution.getExecutionContext();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jobContext.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setStepExecution</span><span class="params">(StepExecution stepExecution)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stepExecution = stepExecution;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> StepExecution <span class="title">getStepExecution</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.stepExecution;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>상태를 꺼내오는 부분</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@StepScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrandRankSaveProcessor</span> <span class="keyword">extends</span> <span class="title">SuperStepExecution</span>&lt;<span class="title">String</span>&gt; <span class="keyword">implements</span> <span class="title">ItemProcessor</span> &lt;<span class="title">VBrandEntity</span>,<span class="title">BrandRankEntity</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">//코드중략 </span></span><br><span class="line">	<span class="keyword">private</span> String status;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@BeforeStep</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveStepExecution</span><span class="params">(StepExecution stepExecution)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.setStepExecution(stepExecution);</span><br><span class="line">		<span class="keyword">this</span>.status = (String) <span class="keyword">super</span>.getData(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//코드중략</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>위와 같이 stepExecution 사용하여 공유 데이터를 저장하고 가져오는것이 가능하다. </li>
</ul>
<h2 id="기타-적용하면서-알게된-TMI"><a href="#기타-적용하면서-알게된-TMI" class="headerlink" title="기타 적용하면서 알게된 TMI"></a>기타 적용하면서 알게된 TMI</h2><ul>
<li>브랜드랭킹 적용하면서 외부 API를 통해 데이터를 가져오는 부분이 많았는데, 이부분이 배치처리의 소요시간의 큰 타격을 줫었음. 처리가 다안되고 1번만 수행하고 배치가 뻗었었음. 그래서 기존 1000개씩 가져와서 했던 부분을 100개로 줄이니까 정상적으로 배치가 수행되었었음. </li>
<li>가급적이면 api call로 데이터를 가져오는것보다 db로 데이터를 가져와서 처리하는 방식을 고려하도록 하자. 그도 그럴것이 한번 처리할때마다 api콜을 계속하기때문에 지연처리가 발생할수밖에 없었을것이다. </li>
<li>브랜드배치 말고 베스트랭킹 부분을 step간 데이터공유부분의 소스를 공통으로 가져가려고 공통로직화 시켰는데, status가 static 변수라 좋은 엔지니어링방식을 하지못했었음. static으로 상태를 공유하는일은 극도로 조심해야할것이다.<br>static처리했다가 베스트랭킹에서 상태 C까지 처리했더니 브랜드랭킹에서 A부터 시작해야하는데, D부터 시작하는 불상사가 발생함. </li>
</ul>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Batch/" rel="tag">Batch</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Java-JPA-Spring-Batch/" rel="tag">Java,JPA,Spring,Batch</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/querydsl/" rel="tag">querydsl</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/05/09/holder-pattern/"
                    data-tooltip="holder-pattern"
                    aria-label="PREVIOUS: holder-pattern"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/02/05/java-effective-25/"
                    data-tooltip="java-effective-25"
                    aria-label="NEXT: java-effective-25"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2022 codexdawn. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/05/09/holder-pattern/"
                    data-tooltip="holder-pattern"
                    aria-label="PREVIOUS: holder-pattern"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/02/05/java-effective-25/"
                    data-tooltip="java-effective-25"
                    aria-label="NEXT: java-effective-25"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://codexdawn.github.io/2022/05/09/spring-batch-2/"
                        aria-label="Share on Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">codexdawn</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover-v1.2.0.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-ikbi0v8fyzuu91xv5rmpcrnwb4qinfgborzd5kejmj8wr6ibfra8oaxqshyg.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
