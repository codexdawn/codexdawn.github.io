
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="codexdawn">
    <title>Category: Study - codexdawn</title>
    <meta name="author" content="codexdawn">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="codexdawn">
<meta property="og:url" content="https://codexdawn.github.io/categories/Study/page/2/index.html">
<meta property="og:site_name" content="codexdawn">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="codexdawn">
<meta name="twitter:card" content="summary">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-3sspfygaapf5d6tbrnqmyrhdcstv0iwwmi4wor2yeip9c44sowy9gbdzyyjm.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            codexdawn
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/codexdawn"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.facebook.com/beherzt.dev"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/sim-jisung-3048872a/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:cloudkaiser@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/06/12/jpa-performance-optimazation/"
                            aria-label=": jpa-performance-optimazation"
                        >
                            jpa-performance-optimazation
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-06-12T06:44:47+00:00">
	
		    Jun 12, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B3%A0%EA%B8%89%EC%A3%BC%EC%A0%9C%EC%99%80-%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94/">고급주제와 성능최적화</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="고급주제와-성능최적화"><a href="#고급주제와-성능최적화" class="headerlink" title="고급주제와 성능최적화"></a>고급주제와 성능최적화</h1><h2 id="1-예외-처리"><a href="#1-예외-처리" class="headerlink" title="1. 예외 처리"></a>1. 예외 처리</h2><ul>
<li><p>JPA 표준 예외들은 javax.persistence.PersistenceException의 자식 클래스이다. 그리고 이 예외 클래스는 RuntimeExeption의 자식이다. 따라서 JPA예외는 모두 언체크 예외에 속함. </p>
</li>
<li><p>JPA표준예외는 크게 2가지로 나뉨 </p>
<ul>
<li>트랜잭션 롤백을 표시하는 예외 </li>
<li>트랜잭션 롤백을 표시하지 않는 예외 </li>
</ul>
</li>
<li><p>트랜잭션을 표시하는 예외는 심각한 예외이때문에 복구해선안됨. 이 예외가 발생하면 트랜잭션을 강제로 커밋해도 트랜잭션 커밋되지 않고 대신에 javax.persistence.RollbackException 예외가 발생함. </p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.objectdb.com/api/java/jpa/exceptions">참고-objectdb-jpa exception정리</a></p>
<h3 id="트랜잭션-롤백시-주의사항"><a href="#트랜잭션-롤백시-주의사항" class="headerlink" title="트랜잭션 롤백시 주의사항"></a>트랜잭션 롤백시 주의사항</h3><ul>
<li>트랜잭션을 롤백하는건 db의 반영사항만 롤백하는것이지 숮어한 자바 객체까지 원상태로 복구 안해줌. (영속성 컨텍스트의 1차캐시에 그대로 남아있음.)</li>
<li>이 롤백된 영속성 컨텍스트를 그대로 사용하는건 굉장히 위험함. 따라서 이부분은 EntityManager.clear()를 호출해서 영속성 컨텍스트를 초기화 해야함. </li>
<li>스프링 프레임워크는 위 2가지 문제를 예방하기위해 영속성 컨텍스트 범위에 따라 다른방법을 사용함.<ul>
<li>기본전략 : 트랜잭션당 영속성 컨텍스트 전략 <ul>
<li>문제가 발생하면 트랜잭션 AOP종료시점에 트랜잭션을 롤백하면서 영속성 컨텍스트도 함께 종료시킴 </li>
</ul>
</li>
<li>OSIV처럼 트랜잭션을 범위를 넓게 사용하는 경우 <ul>
<li>위 경우는 문제가 발생한 경우 다른 트랜잭션에서 문제가 되는 영속성 컨텍스트를 참조하는 경우 문제가 발생한다. </li>
<li>그래서 스프링에서는 문제 발생시 EntityManager.clear()를 자동호출하여 다른 트랜잭션이 문제가 되는 영속성 컨텍스트에 접근하지못하도록 막는다. </li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-엔티티-비교"><a href="#2-엔티티-비교" class="headerlink" title="2. 엔티티 비교"></a>2. 엔티티 비교</h2><ul>
<li>영속성 컨텍스트 내부에는 1차캐시가 있는데, 1차캐시는 영속성 컨텍스트와 생명주기를 같이함. </li>
<li>영속성 컨텍스트를 통해 데이터를 저장하거나, 조회하면 1차 캐시에 엔티티가 저장됨. (1차캐시 덕분에 변경감지기능 과 db접근하지않고 1차캐시로 데이터 조회 바로 가능함)</li>
<li>같은 영속성 컨텍스트로 반환받은 엔티티는 항상 같은 엔티티 인스턴스를 반환함(단순 동등성이 아니라, 주소까지 같은 인스턴스임) </li>
</ul>
<h2 id="3-프록시-심화-주제"><a href="#3-프록시-심화-주제" class="headerlink" title="3. 프록시 심화 주제"></a>3. 프록시 심화 주제</h2><h3 id="em-getReference-호출-후-em-find-호출"><a href="#em-getReference-호출-후-em-find-호출" class="headerlink" title="em.getReference 호출 후 em.find 호출"></a>em.getReference 호출 후 em.find 호출</h3><ul>
<li>em.getReference를 호출하고 em.find를 호출하면 같은 엔티티로 보장됨.</li>
<li>그리고 처음 getReference로 프록시를 호출하고나서, em.find로 원본 엔티티를 조회해도 em.find로 가져온 엔티티는 처음 getReference로 호출한 프록시 객체 주소로 반환하게 됨. </li>
</ul>
<h3 id="em-find-호출후-em-getReference-호출"><a href="#em-find-호출후-em-getReference-호출" class="headerlink" title="em.find 호출후 em.getReference 호출"></a>em.find 호출후 em.getReference 호출</h3><ul>
<li>역시나 같은 엔티티 보장됨.</li>
<li>em.find로 호출했기때문에, 원본 엔티티를 리턴한다. 그리고 em.getReference를 호출하면 프록시 객체를 리턴할것 같지만, 원본 엔티티를 리턴하게됨. </li>
<li>이렇게 처음 호출한 엔티티를 그대로 리턴하는 이유는 엔티티 동일성 보장을 위한 장치라고 생각하면 될듯하다. </li>
</ul>
<h3 id="프록시-타입-비교"><a href="#프록시-타입-비교" class="headerlink" title="프록시 타입 비교"></a>프록시 타입 비교</h3><ul>
<li>instanceof로 무조건 비교해야함. (==비교 안됨.)</li>
</ul>
<h3 id="프록시-동등성-비교"><a href="#프록시-동등성-비교" class="headerlink" title="프록시 동등성 비교"></a>프록시 동등성 비교</h3><ul>
<li>equals 재정의해서 비교하면 됨. </li>
</ul>
<h2 id="4-성능-최적화"><a href="#4-성능-최적화" class="headerlink" title="4. 성능 최적화"></a>4. 성능 최적화</h2><h3 id="N-1-문제"><a href="#N-1-문제" class="headerlink" title="N+1 문제"></a>N+1 문제</h3><figure class="highlight java"><figcaption><span>Member-Order</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GenerateValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@OneToMany(mappedBy = &quot;member&quot;, fetch = FetchType.EAGER)</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;Order&gt; orders = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;Orders&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GenerateValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="keyword">private</span> Member member;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위 코드는 주문-회원간 엔티티로 주문정보는 1:N,N:1 양방향 연관관계 매핑된 엔티티들이다. 특이점은 글로벌 페치전략을 즉시로딩으로 걸었다. </p>
<h4 id="즉시로딩과-N-1"><a href="#즉시로딩과-N-1" class="headerlink" title="즉시로딩과 N+1"></a>즉시로딩과 N+1</h4><p>위 코드를 em.find로 조회하면 어떤 쿼리가 나갈까?<br>select M.<em>, O.</em> FROM MEMBER M OUTER JOIN ORDERS O ON M.ID = O.MEMBER_ID<br>즉시로딩이기때문에 위와같이 한방쿼리로 나간다. 하지만 문제는 JPQL로 조회했을때다.<br>List<Member> members = em.createQuery(“select m from Member m”, Member.class).getResultList();<br>위 JPQL을 수행하면 즉시로딩과 지연로딩 전혀 신경쓰지않고, JPQL만 사용해서 SQL을 생성한다. 따라서 아래와 같은 쿼리가 나가게된다.<br>SELECT * FROM MEMBER<br>SQL의 실행결과로 회원 엔티티 정보를 애플리케이션에 로딩한다. 그런데말입니다. 회원 엔티티와 연관된 주문 컬렉션이 즉시 로딩으로 설정되어있으므로, JPA는 주문 컬렉션을 즉시로딩하려고 아래 SQL을 추가로 실행한다.<br>SELECT * FROM ORDERS WHERE MEMBER_ID = ?<br>이렇게 회원의 숫자에 따라서 N의 쿼리가 추가로 나가게되는데, 이부분을 N+1이슈라고 한다. </Member></p>
<h4 id="지연로딩과-N-1"><a href="#지연로딩과-N-1" class="headerlink" title="지연로딩과 N+1"></a>지연로딩과 N+1</h4><p>그렇다면 위 코드를 즉시로딩 대신 지연로딩으로 사용하면 N+1문제에서 해결할수있을까? 결론부터 말하면 NOPE! JPQL로 수행하면 원하는대로 쿼리는 하나만 출력될것이다. 하지만 주문 컬렉션을 실제로 사용했을때 프록시 객체에서 디비초기화를 요청하게 되기때문에, 역시나 회원 엔티티 숫자만큼 요청하게된다. </p>
<h4 id="페치-조인-사용-으로-N-1해결"><a href="#페치-조인-사용-으로-N-1해결" class="headerlink" title="페치 조인 사용 으로 N+1해결"></a>페치 조인 사용 으로 N+1해결</h4><ul>
<li>fetch join으로 한방쿼리 만들어서 출력가능.</li>
<li>위 예제기준으로는 1:N 조인을 했으므로 중복된 결과가 나올수있기때문에 JPQL의 DISTINCT를 사용해서 중복제거해야함. </li>
</ul>
<h4 id="하이버네이트-BatchSize"><a href="#하이버네이트-BatchSize" class="headerlink" title="하이버네이트 @BatchSize"></a>하이버네이트 @BatchSize</h4><ul>
<li>발생되는 컬렉션 객체위에 @BatchSize 를 설정하거나</li>
<li>application.yml에서 default_batch_size 를 설정해서 글로벌하게 설정할수 있음. </li>
</ul>
<h4 id="하이버네이트-Fetch-FetchMode-SUBSELECT"><a href="#하이버네이트-Fetch-FetchMode-SUBSELECT" class="headerlink" title="하이버네이트 @Fetch(FetchMode.SUBSELECT)"></a>하이버네이트 @Fetch(FetchMode.SUBSELECT)</h4><ul>
<li>BatchSize를걸었던것 처럼 컬렉션객체위에 선언하면 서브쿼리가 생성되서 사이즈만큼 where절 서브쿼리로 한방쿼리로 수행될수있음. </li>
</ul>
<h4 id="N-1정리"><a href="#N-1정리" class="headerlink" title="N+1정리"></a>N+1정리</h4><ul>
<li>즉시로딩은 가급적 사용하지말자!(즉시로딩은 성능 최적화가 어렵다.)</li>
<li>지연로딩으로 다 발라버리고, 성능 최적화가 필요한곳에 fetch join사용하자</li>
</ul>
<h3 id="읽기전용-쿼리의-성능-최적화"><a href="#읽기전용-쿼리의-성능-최적화" class="headerlink" title="읽기전용 쿼리의 성능 최적화"></a>읽기전용 쿼리의 성능 최적화</h3><p>엔티티가 영속성 컨텍스트에 관리되면 1차캐시부터 변경감지까지 얻을수있는 장점이 많지만, 영속성 컨텍스트는 변경감지를 위해 스냅샷 인스턴스를 보관하므로 더 많은 메모리를 사용한다는 단점이 있다.</p>
<h4 id="스칼라-타입으로-조회-커스텀-프로젝션-설정"><a href="#스칼라-타입으로-조회-커스텀-프로젝션-설정" class="headerlink" title="스칼라 타입으로 조회 (커스텀 프로젝션 설정)"></a>스칼라 타입으로 조회 (커스텀 프로젝션 설정)</h4><ul>
<li>가장 확실한 방법임 (엔티티가 아닌 스칼라 타입으로 필드 조회 )</li>
<li>스칼라 타입은 영속성 컨텍스트가 결과를 관리하지 않음.</li>
</ul>
<h4 id="읽기전용-쿼리-힌트-사용"><a href="#읽기전용-쿼리-힌트-사용" class="headerlink" title="읽기전용 쿼리 힌트 사용"></a>읽기전용 쿼리 힌트 사용</h4><ul>
<li>query.setHint(“org.hibernate.readOnly”, true);</li>
<li>위 설정을 하면 읽기전용이기때문에 스냅샷에서 저장안함. (스냅샷이 없기때문에 변경감지같은 기능 못사용함.)</li>
</ul>
<h4 id="읽기전용-트랜잭션-사용"><a href="#읽기전용-트랜잭션-사용" class="headerlink" title="읽기전용 트랜잭션 사용"></a>읽기전용 트랜잭션 사용</h4><ul>
<li>@Transactional(readOnly = true)</li>
<li>위 옵션을 주면 스프링에서 entityManager 플러시 모드를 manual로 설정함. (강제로 flush를 호출하지않는한 플러시 발생안함.)</li>
<li>트랜잭션을 설사 커밋해도 플러시 안함 (등록,삭제,갱신등 안됨)</li>
<li>플러시할때 일어나는 스냅샷 비교같은 무거운 로직들을 수행안해서 성능이 향상됨. </li>
<li>트랜잭션을 시작했기때문에 트랜잭션시작, 로직수행,트랜잭션 커밋의 과정은 이뤄지지만, 단지 영속성 컨텍스트 플러시를 안할뿐이다. </li>
</ul>
<h4 id="트랜잭션-밖에서-읽기"><a href="#트랜잭션-밖에서-읽기" class="headerlink" title="트랜잭션 밖에서 읽기"></a>트랜잭션 밖에서 읽기</h4><ul>
<li>@Transactional(propagation= Propagation.NOT_SUPPORTED) </li>
<li>위 설정은 트랜잭션을 사용하지 않는것이다. 따라서 자연스럽게 커밋할일이없어짐. JPQL쿼리도 트랜잭션 없이 실행하면 플러시를 호출 안함.</li>
</ul>
<p>읽기 전용 데이터를 조회할때, 메모리 최적화하려면 스칼라 타입(커스텀 프로젝션)으로 조회등 위 내용대로 설정하면 됨.<br>(보통 읽기전용트랜잭션 + 읽기전용쿼리힌트 로 성능최적화를 많이 함.)</p>
<h3 id="배치처리"><a href="#배치처리" class="headerlink" title="배치처리"></a>배치처리</h3><p>배치 처리처럼 수천 수백만건의 데이터를 처리해야하는것이라면, 영속성 컨텍스트에 무자비하게 쌓이기때문에 메모리부족 현상이 발생할수있음. 2차캐시 사용한다면 2차캐시에 보관되지않도록 해야햠.</p>
<h4 id="JPA-등록배치"><a href="#JPA-등록배치" class="headerlink" title="JPA 등록배치"></a>JPA 등록배치</h4><ul>
<li>주기적으로 em.flush(), em.clear() 호출 (if(i % 100 == 0))</li>
</ul>
<h4 id="JPA-페이징-배치-처리"><a href="#JPA-페이징-배치-처리" class="headerlink" title="JPA 페이징 배치 처리"></a>JPA 페이징 배치 처리</h4><ul>
<li>페이징으로 100건씩 쿼리 조회하면서 em.flush,em.clear호출  </li>
</ul>
<h4 id="하이버네이트-Scroll사용"><a href="#하이버네이트-Scroll사용" class="headerlink" title="하이버네이트 Scroll사용"></a>하이버네이트 Scroll사용</h4><ul>
<li>하이버네이트는 scroll로 jdbc 커서를 지원함. (JPA는 커서 지원안함)</li>
<li>Session session = em.unwrap(Session.class); 을 사용해야함. </li>
<li>2차캐시 기능은 꺼야함(setCacheMode(CacheMode.IGNORE))</li>
</ul>
<h4 id="하이버네이트-무상태-세션-사용"><a href="#하이버네이트-무상태-세션-사용" class="headerlink" title="하이버네이트 무상태 세션 사용"></a>하이버네이트 무상태 세션 사용</h4><ul>
<li>영속성 컨텍스트 생성안함. 2차캐시도 사용안함</li>
<li>엔티티를 수정하려면 무상태 세션이 제공하는 update()메소드를 직접 호출해야함. </li>
</ul>
<h3 id="SQL-쿼리-힌트"><a href="#SQL-쿼리-힌트" class="headerlink" title="SQL 쿼리 힌트"></a>SQL 쿼리 힌트</h3><ul>
<li>JPA는 데이터베이스 SQL힌트기능이 없음 (하이버네이트를 직업 사용해야함.)</li>
<li>addQueryHint(“FULL (MEMBER)”) 이런식으로 힌트 추가 (하이버네이트 세션에서)</li>
</ul>
<h3 id="트랜잭션을-지원하는-쓰기지연-과-성능-최적화"><a href="#트랜잭션을-지원하는-쓰기지연-과-성능-최적화" class="headerlink" title="트랜잭션을 지원하는 쓰기지연 과 성능 최적화"></a>트랜잭션을 지원하는 쓰기지연 과 성능 최적화</h3><ul>
<li>hibernate.jdbc.batch_size 속성 사용 </li>
<li>위 설정으로 배치처리를하면 사이즈만큼 모아서 처리함. </li>
<li>하지만 같은 SQL일때만 유효하다. 중간에 다른 쿼리가 끼면 SQL배치를 다시 시작하게됨. </li>
</ul>
<h3 id="트랜잭션을-지원하는-쓰기지연과-애플리케이션-확장성"><a href="#트랜잭션을-지원하는-쓰기지연과-애플리케이션-확장성" class="headerlink" title="트랜잭션을 지원하는 쓰기지연과 애플리케이션 확장성"></a>트랜잭션을 지원하는 쓰기지연과 애플리케이션 확장성</h3><ul>
<li>트랜잭션을 지원하는 쓰기지연과 변경감지 기능으로 개발 편의성 장점을 얻었지만 진짜 찐장점은 데이터베이스 테이블 row에 lock이 걸리는 시간을 최소화 한다.</li>
<li>flush 하기 전까지는 등록,삭제,수정같은 트랜잭션이 발생안하기때문에 락이 안걸림. </li>
<li>트랜잭션 격리수준에 따라 다르지만 보통 많이 사용하는 커밋된 읽기 (Read Commited) 격리수준이나 그 이상에서는 데이터베이스에 현재 수정중인 데이터를 수정하려는 다른 트랜잭션은 락이 풀릴때까지 대기한다. </li>
<li>jpa는 커밋을 해야 플러시를 호출하고 데이터베이스에 수정 쿼리를 보낸다. 쿼리를 보내고 트랜잭션을 커밋하므로 결과적으로 디비에 락이 걸리는 시간을 최소화함. </li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/06/12/jpa-performance-optimazation/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/06/10/jpa-collection-etc/"
                            aria-label=": jpa-collection-etc"
                        >
                            jpa-collection-etc
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-06-10T08:41:35+00:00">
	
		    Jun 10, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>, <a class="category-link" href="/categories/%EC%BB%AC%EB%A0%89%EC%85%98%EA%B3%BC-%EB%B6%80%EA%B0%80%EA%B8%B0%EB%8A%A5/">컬렉션과 부가기능</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="컬렉션과-부가기능"><a href="#컬렉션과-부가기능" class="headerlink" title="컬렉션과 부가기능"></a>컬렉션과 부가기능</h1><h2 id="1-컬렉션"><a href="#1-컬렉션" class="headerlink" title="1. 컬렉션"></a>1. 컬렉션</h2><p>JPA에서 컬렉션을 사용할때 2가지</p>
<ol>
<li>@OneToMany, @ManyToMany 를 사용해서 일대다 나 다대다 엔티티 관계를 매핑할때 </li>
<li>@ElementCollection을 사용해서 값 타입을 하나 이상 보관 할때 </li>
</ol>
<p>자바 컬렉션 인터페이스 특징</p>
<ol>
<li>Collection : 자바가 제공하는 최상위 컬렉션. 하이버네이트는 중복을 허용하고 순서를 보장하지 않는다고 가정</li>
<li>Set: 중복을 허용하지 않고,순서 보장안됨.</li>
<li>List: 순서가 있는 컬렉션. 순서를 보장하지만 중복 허용됨.</li>
<li>Map: Key,Value구조로 되어있는 특수한 컬렉션이다. (Map은 잘 활용안됨.)</li>
</ol>
<h3 id="Collection-List"><a href="#Collection-List" class="headerlink" title="Collection,List"></a>Collection,List</h3><p>Collection,List는 엔티티를 추가할때 중복된 엔티티가 있는지 비교하지않고, 단순히 저장만하면 된다. 따라서 엔티티를 추가해도 지연 로딩된 컬렉션을 초기화 하지 않는다. </p>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><p>Set은 엔티티를 추가할때 중복된 엔티티가 있는지 비교해야 한다. 따라서 엔티티를 추가할때 지연로딩된 컬렉션을 초기화한다.<br>(Set사용시, equals,hashcode 재정의 무조건 반드시 해야함!!! )</p>
<h3 id="OrderBy"><a href="#OrderBy" class="headerlink" title="@OrderBy"></a>@OrderBy</h3><p>@OrderBy는 모든 컬렉션에 사용가능 </p>
<figure class="highlight java"><figcaption><span>@OrderBy 예제</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Team</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GenerateValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@OneToMany(mappedBy=&quot;team&quot;)</span></span><br><span class="line">	<span class="meta">@OrderBy(&quot;username desc, id asc&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Set&lt;Member&gt; members = <span class="keyword">new</span> HashSet&lt;&gt;(); </span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GenerateValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Column(name = &quot;member_name&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String username;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="keyword">private</span> Team team; </span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Team findTeam = em.find(Team.class, team.getId()); </span><br><span class="line">findTeam.getMembers().size(); <span class="comment">//초기화 </span></span><br><span class="line"><span class="comment">//위 코드의 나갈쿼리는  아래와 같다. (정렬붙은것 확인됨)</span></span><br><span class="line"><span class="comment">//SELECT M.* FROM MEMBER M WHERE M.TEAM = ? ORDER BY M.MEMBER_NAME DESC, M.ID ASC </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-Converter"><a href="#2-Converter" class="headerlink" title="2. @Converter"></a>2. @Converter</h2><figure class="highlight java"><figcaption><span>@Converter</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GenerateValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String username; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Convert(converter = BooleanToYnConverter.class)</span> </span><br><span class="line">	<span class="comment">//글로벌 설정으로 하면 위 애너테이션 지워됨. </span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> vip; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Converter</span></span><br><span class="line"><span class="comment">//@Converter(autoApply = true) 요렇게 하면 글로벌 설정으로 설정됨. </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanToYnConverter</span> <span class="keyword">implements</span> <span class="title">AttributeConverter</span>&lt;<span class="title">Boolean</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">convertToDatabaseColumn</span><span class="params">(Boolean attribute)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (attribute != <span class="keyword">null</span> &amp;&amp; attribute) ? <span class="string">&quot;Y&quot;</span> : <span class="string">&quot;N&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">convertToEntityAttribute</span><span class="params">(Strig dbData)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Y&quot;</span>.equals(dbData); </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-엔티티-그래프"><a href="#3-엔티티-그래프" class="headerlink" title="3. 엔티티 그래프"></a>3. 엔티티 그래프</h2><p>엔티티를 조회할때 연관된 엔티티를 함께 조회 하려면 글로벌페치전략을 Eager로 설정하거나, Lazy로딩해서 fetch조인 사용하기도한다. 하지만 페치조인을 사용하면 JPQL을 중복해서 작성하는 경우가 많다. </p>
<ul>
<li>select o from Orders o where o.status = ?  </li>
<li>selet o from Order o join fetch o.member where o.status = ?</li>
<li>select o from Orders join fetch o.orderItems where o.status = ?<br>위와같이 상황에 따라 각기 다른 쿼리를 직접 개발해야함. </li>
</ul>
<p>엔티티그래프를 사용하면 엔티티를 조회하는 시점에 함께 조회할 연관된엔티티를 선택할수있다. 그래서 아래쿼리만 작성하면 연관된 엔티티도 같이 끌고옴.</p>
<ul>
<li>select o from Orders o where o.status = ?  </li>
</ul>
<p>엔티티그래프 기능은 엔티티 조회시점에 연관된 엔티티 들을 함께 조회하는 기능이다.  </p>
<figure class="highlight java"><figcaption><span>엔티티그래프 사용방법</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NamedEntityGraph(name = &quot;Order.withMember&quot;, attributeNodes = &#123;</span></span><br><span class="line"><span class="meta">	@NamedAttributeNode(&quot;member&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Orders</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GenerateValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne(fetch=LAZY, optional=false)</span></span><br><span class="line">	<span class="meta">@JoinColumn(name = &quot;member_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Member member; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//em.find 사용 </span></span><br><span class="line">EntityGraph g = em.getEntityGraph(<span class="string">&quot;Order.withMember&quot;</span>);</span><br><span class="line"></span><br><span class="line">Map hints = <span class="keyword">new</span> HashMap();</span><br><span class="line">hints.put(<span class="string">&quot;javax.persistence.fetchgraph&quot;</span>, g);</span><br><span class="line"></span><br><span class="line">Order order = em.find(Order.class, orderId, hints); </span><br></pre></td></tr></table></figure>

<h3 id="subgraph"><a href="#subgraph" class="headerlink" title="subgraph"></a>subgraph</h3><figure class="highlight java"><figcaption><span>서브그래프 사용방법</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NamedEntityGraph(name = &quot;Order.withAll&quot;, attributeNodes = &#123;</span></span><br><span class="line"><span class="meta">	@NamedAttributeNode(&quot;member&quot;),</span></span><br><span class="line"><span class="meta">	@NamedAttributeNode(value=&quot;orderItems&quot;, subgraph = &quot;orderItems&quot;)</span></span><br><span class="line"><span class="meta">&#125;, </span></span><br><span class="line"><span class="meta">subgraphs = @NamedSubgraph(name= &quot;orderItems&quot;, attributeNodes = &#123;</span></span><br><span class="line"><span class="meta">	@NamedAttributeNode(&quot;item&quot;)</span></span><br><span class="line"><span class="meta">&#125;))</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Orders</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GenerateValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne(fetch=LAZY, optional=false)</span></span><br><span class="line">	<span class="meta">@JoinColumn(name = &quot;member_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Member member; </span><br><span class="line">	</span><br><span class="line">	<span class="meta">@OneToMany(mappedBy=&quot;order&quot;, cascade = CascadeType.ALL)</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;OrderItem&gt; orderItems = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderItem</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Id</span> <span class="meta">@GenerateValue</span></span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ManyToOne(fetch = LAZY)</span></span><br><span class="line">	<span class="meta">@JoinColumn(name = &quot;item_id&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Item item; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//em.find 사용 </span></span><br><span class="line">EntityGraph g = em.getEntityGraph(<span class="string">&quot;Order.withAll&quot;</span>);</span><br><span class="line"></span><br><span class="line">Map hints = <span class="keyword">new</span> HashMap();</span><br><span class="line">hints.put(<span class="string">&quot;javax.persistence.fetchgraph&quot;</span>, g);</span><br><span class="line"></span><br><span class="line">Order order = em.find(Order.class, orderId, hints);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//jpql 사용 </span></span><br><span class="line">List&lt;Orders&gt; result = em.createQuery(<span class="string">&quot;select o from Orders o where o.id = :orderId&quot;</span>, Orders.class)</span><br><span class="line">						.setParameter(<span class="string">&quot;orderId&quot;</span>, orderId)</span><br><span class="line">						.setHint(<span class="string">&quot;javax.persistence.fetchgraph&quot;</span>, em.getEntityGraph(<span class="string">&quot;Order.withAll&quot;</span>))</span><br><span class="line">						.getResultList(); </span><br></pre></td></tr></table></figure>

<h4 id="엔티티그래프-사용시-참고"><a href="#엔티티그래프-사용시-참고" class="headerlink" title="엔티티그래프 사용시 참고!!"></a>엔티티그래프 사용시 참고!!</h4><p>em.find를 사용하면 연관관계 매핑시 optional=true로 걸면 inner Join으로 필수관계가 자동으로 매핑되지만, JPQL에서 엔티티그래프를 사용하면 항상 외부조인으로 잡힌다. 따라서 내부조인을 사용하고 싶으면 아래와 같이 내부조인을 명시시켜줘야함.<br>select o from Orders o join fetch o.member where o.id = :orderId</p>
<h3 id="엔티티그래프-정리"><a href="#엔티티그래프-정리" class="headerlink" title="엔티티그래프 정리"></a>엔티티그래프 정리</h3><ol>
<li>ROOT에서 시작 <ul>
<li>엔티티그래프는  항상 조회하는 엔티티의 ROOT에서 시작해야함. Order엔티티를 조회하는데 Member부터 시작하는 엔티티그래프를 사용하면 안됨.</li>
</ul>
</li>
<li>이미 로딩된 엔티티<ul>
<li>다음처럼 영속성 컨텍스트에 이미 로딩되어있으면 엔티티그래프 적용안됨.<br>Orders order1 = em.find(Orders.class, orderId); //이미 조회<br>hints.put(“javax.persistence.fetchgraph”, em.getEntityGraph(“Order.withMember”));<br>Orders order2 = em.find(Orders.class, orderId, hints); //이미 로딩되었기 때문에 엔티티그래프 적용X </li>
</ul>
</li>
<li>fetchgraph vs loadgraph <ul>
<li>fetchgraph는 선택한 엔티티속성만 가져옴 </li>
<li>loadgraph는 글로벌 페치전략이 EAGER전략으로 설정된 연관관계도 포함해서 함께 조회한다고함. </li>
</ul>
</li>
</ol>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/06/10/jpa-collection-etc/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/06/05/jpa-webapp-persistence/"
                            aria-label=": jpa-webapp-persistence"
                        >
                            jpa-webapp-persistence
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-06-05T11:27:18+00:00">
	
		    Jun 05, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EC%9B%B9-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98%EA%B3%BC-%EC%98%81%EC%86%8D%EC%84%B1-%EA%B4%80%EB%A6%AC/">웹 애플리케이션과 영속성 관리</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="웹-애플리케이션과-영속성-관리"><a href="#웹-애플리케이션과-영속성-관리" class="headerlink" title="웹 애플리케이션과 영속성 관리"></a>웹 애플리케이션과 영속성 관리</h1><h2 id="1-트랜잭션-범위의-영속성-컨텍스트"><a href="#1-트랜잭션-범위의-영속성-컨텍스트" class="headerlink" title="1. 트랜잭션 범위의 영속성 컨텍스트"></a>1. 트랜잭션 범위의 영속성 컨텍스트</h2><h3 id="1-1-스프링-컨테이너의-기본-전략"><a href="#1-1-스프링-컨테이너의-기본-전략" class="headerlink" title="1-1. 스프링 컨테이너의 기본 전략"></a>1-1. 스프링 컨테이너의 기본 전략</h3><p>스프링 컨테이너는 <strong>트랜잭션 범위의 영속성 컨텍스트</strong> 전략을 기본으로 사용한다. 보통 스프링에서 비즈니스 로직을 시작하는 서비스 계층에 @Transactional 어노테이션을 선언해서 트랜잭션을 시작한다. 이 어노테이션이 선언되면 Spring의 트랜잭션 AOP가 먼저 동작한다.</p>
<blockquote><p>스프링 트랜잭션 생명주기 (@Transactional선언된 메서드 일 경우)</p>
<ol>
<li>스프링 트랜잭션 AOP는 대상 메소드를 호출하기 직전에 트랜잭션을 시작</li>
<li>대상 메소드가 종료되면 트랜잭션을 커밋하면서 종료한다.<ul>
<li>이때 트랜잭션을 커밋하면서 JPA는 먼저 영속성 컨텍스트를 플러시 해서 변경내용을 DB에 반영하고 DB 트랜잭션을 컷밋한다. </li>
<li>따라서, 영속성 컨텍스트의 변경내용이 DB에 정상반영된다. 만약 예외 발생하면 트랜잭션 롤백하고 종료되고, 플러시 호출은 안됨. </li>
</ul>
</li>
</ol>
</blockquote>

<figure class="highlight java"><figcaption><span>transactional lifecycle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloService</span>() </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PersistenceContext</span> <span class="comment">//엔티티매니저 주입 </span></span><br><span class="line">	EntiryManager em; <span class="comment">//?왜했지? </span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span> Repository1 repo1; </span><br><span class="line">	<span class="meta">@Autowired</span> Repository2 repo2; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">//트랜잭션 시작 </span></span><br><span class="line">	<span class="meta">@Transactional</span> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logic</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		repo1.hello(); </span><br><span class="line"></span><br><span class="line">		<span class="comment">//member는 영속상태다. </span></span><br><span class="line">		Member member = repo2.findMember();</span><br><span class="line">		<span class="keyword">return</span> member; </span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//트랜잭션 종료</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Repository1</span> </span>&#123;</span><br><span class="line">	<span class="meta">@PersistenceContext</span></span><br><span class="line">	EntityManager em; </span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		em.xxx(); <span class="comment">//A. 영속성 컨텍스트 접근 </span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Repository2</span> </span>&#123;</span><br><span class="line">	<span class="meta">@PersistenceContext</span></span><br><span class="line">	EntityManager em; </span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Member <span class="title">findMember</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> em.find(Member.class, <span class="string">&quot;m1&quot;</span>); <span class="comment">//B. 영속성 컨텍스트 접근 </span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>위 코드의 트랜잭션 생명주기는 어떻까?</p>
<ol>
<li>HelloService.logic 메서드에 @Transactional이 선언되었으므로, 스프링 트랜잭션 AOP에 의해 트랜잭션 시작 </li>
<li>repo2.findMember를 통해 조회한 Member엔티티는 트랜잭션 범위에 있으므로 영속성 컨텍스트 관리를 받는다. 따라서 영속상태임.</li>
<li>@Transactional 선언한 메서드가 정상 종료되면 트랜잭션을 커밋하는데, 이때 영속성 컨텍스트를 종료한다. 영속성 컨텍스트가 사라졋으므로 조회한 엔티티(member)는 이제부터 준영속 상태가 된다.</li>
<li>서비스 메서드가 끝나면서 트랜잭션과 영속성 컨텍스트가 종료되었다. 따라서 컨트롤러에 반환된 member엔티티는 준영속상태로 관리된다. </li>
</ol>
<h3 id="트랜잭션이-같으면-같은-영속성-컨텍스트를-사용한다"><a href="#트랜잭션이-같으면-같은-영속성-컨텍스트를-사용한다" class="headerlink" title="트랜잭션이 같으면 같은 영속성 컨텍스트를 사용한다."></a>트랜잭션이 같으면 같은 영속성 컨텍스트를 사용한다.</h3><p>위 코드의 2개의 repository 로 접근한 A,B는 같은 트랜잭션에서 수행됨에따라, A,B는 비록 다른 엔티티매니저 이지만, 같은 영속성 컨텍스트를 사용하게 된다.</p>
<h3 id="트랜잭션이-다르면-다른-영속성-컨텍스트를-사용한다"><a href="#트랜잭션이-다르면-다른-영속성-컨텍스트를-사용한다" class="headerlink" title="트랜잭션이 다르면 다른 영속성 컨텍스트를 사용한다."></a>트랜잭션이 다르면 다른 영속성 컨텍스트를 사용한다.</h3><p>위 코드에서 여러 스레드에서 동시에 요청이와서 같은 엔티티 매니저를 사용해도 트랜잭션에 따라 접근하는 영속성 컨텍스트가 다르다. 좀 더 들어가면 스프링 컨테이너는 스레드마다 각각 다른 트랜잭션을 할당한다. 따라서 같은 엔티티 매니저를 호출해도 접근하는 영속성 컨텍스트가 다르므로 멀티스레드 환경에서 안전하다. </p>
<h2 id="2-준영속-상태와-지연로딩"><a href="#2-준영속-상태와-지연로딩" class="headerlink" title="2. 준영속 상태와 지연로딩"></a>2. 준영속 상태와 지연로딩</h2><h3 id="준영속-상태와-지연로딩"><a href="#준영속-상태와-지연로딩" class="headerlink" title="준영속 상태와 지연로딩"></a>준영속 상태와 지연로딩</h3><p>준영속 상태의 가장 골치아픈 문제는 지연로딩 기능이 동작하지 않는다. 예를들어 뷰를 렌더링할때 연관된 엔티티도 함께 사용해야 하는데 연관된 엔티티를 지연 로딩으로 설정해서 프록시 객체로 조회했다고 가장하자. 아직 초기화 하지 않은 프록시객체를 사용하려고 초기화를 시도함. 하지만 준영속 상태에서는 영속성 컨텍스트가 없으므로 지연로딩을 할수 없다. 이때 지연로딩을 시도하면 문제가 발생함. (LazyInitializationException 예외 발생)</p>
<h4 id="준영속-상태의-지연로딩-문제를-해결하는-방법-2가지"><a href="#준영속-상태의-지연로딩-문제를-해결하는-방법-2가지" class="headerlink" title="준영속 상태의 지연로딩 문제를 해결하는 방법 2가지"></a>준영속 상태의 지연로딩 문제를 해결하는 방법 2가지</h4><ol>
<li>뷰가 필요한 엔티티를 미리 로딩해두는 방법 <ul>
<li>글로벌 패치 전략 수정 </li>
<li>JPQL fetch join </li>
<li>강제로 초기화 </li>
</ul>
</li>
<li>OSIV를 사용해서 엔티티를 항상 영속상태로 유지하는 방법 </li>
</ol>
<h4 id="1-글로벌-페치-전략-수정"><a href="#1-글로벌-페치-전략-수정" class="headerlink" title="1. 글로벌 페치 전략 수정"></a>1. 글로벌 페치 전략 수정</h4><p>글로벌 페치 전략을 Lazy로딩 상태에서 Eager로 수정하면 쿼리를 조인해서 한꺼번에 가져오게된다.<br>하지만 즉시로딩을 전략을 사용하게되면 치명적인 단점 2가지가 존재한다.</p>
<blockquote><p>글로벌 페치 전략에 즉시로딩을 사용시 단점 </p>
<ol>
<li>사용하지 않는 엔티티를 로딩한다. <ul>
<li>말그대로 의도와 다르게 하나의 엔티티만 사용하고싶은데, 즉시로딩 전략상 조인된 테이블을 한꺼번에 가져와야하기때문에 </li>
</ul>
</li>
<li>N+1 문제 유발 <ul>
<li>JPA가 JPQL을 분석해서 SQL을 생성할때는 글로벌 페치 전략을 참고하지 않고 오직 JPQL 자체만 사용한다. </li>
<li>select o from Order o -&gt; JPQL을 수행하면 실제로 select * from Order만 나가는게 아니라 Member테이블의 정보도 같이 조회 해야한다. 즉시로딩으로 정보를 가져와야하기때문에</li>
</ul>
</li>
</ol>
</blockquote>

<h4 id="2-JPQL-fetch-join-사용"><a href="#2-JPQL-fetch-join-사용" class="headerlink" title="2. JPQL fetch join 사용"></a>2. JPQL fetch join 사용</h4><p>fetch join하게되면 한방쿼리로 만들어줘서, 미리 로딩시키는 효과를 볼수있음. (N+1문제도 자연스럽게 해결됨.)</p>
<h4 id="3-강제로-초기화"><a href="#3-강제로-초기화" class="headerlink" title="3. 강제로 초기화"></a>3. 강제로 초기화</h4><p>서비스 로직에서 orderRepository.findOrder(id) 호출후 order.getMember().getName()까지 호출해서 프록시 객체를 강제로 초기화 시켜둔다.<br>이런 강제로 초기화 작업을 해주기 위해서는 프록시 초기화를 담당하는 계층이 필요하다. 그 계층이 FACADE계층이다. </p>
<blockquote><p>FACADE 계층의 역할과 특징 </p>
<ul>
<li>프리젠테이션 계층과 도메인 모델 계층간의 논리적 의존성 분리를 해줌.</li>
<li>프리젠테이션 꼐층에서 필요한 프록시 객체를 초기화 한다.</li>
<li>서비스 계층을 호출해서 비즈니스 로직을 실행한다.</li>
<li>리포지토리를 직접 호출해서 뷰가 요구하는 엔티티를 찾는다. </li>
</ul>
<p>FACADE 계층 사용시 주의점 </p>
<ul>
<li>프록시를 초기화하라면 영속성컨텍스트가 필요하므로 FACADE에서 @Transactional이 선언되어야함. (서비스도 호출하고 리포지토리도 호출하기 때문)</li>
</ul>
</blockquote>

<p>하지만 위 3가지 방법으로 지연로딩에서 VIEW에서 호출하기 전에 데이터를 미리 담아두는 방법을 사용해도, 결국 준영속 상태에서 초기화 이슈에 대한 예외발생은 발생할수밖에없음. 이런 부분을 해결하기 위해서는 OSIV를 적용해야함.  </p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/06/05/jpa-webapp-persistence/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/20/java8-chaptor3/"
                            aria-label=": java8-chaptor3"
                        >
                            java8-chaptor3
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-20T14:08:15+00:00">
	
		    May 20, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Java8InAction/">Java8InAction</a>, <a class="category-link" href="/categories/Study/">Study</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Chaptor3-람다-표현식"><a href="#Chaptor3-람다-표현식" class="headerlink" title="Chaptor3. 람다 표현식"></a>Chaptor3. 람다 표현식</h1><h2 id="3-1-람다란"><a href="#3-1-람다란" class="headerlink" title="3-1. 람다란?"></a>3-1. 람다란?</h2><p>람다는 메서드로 전달할수 있는 익명함수를 단순화 한것 </p>
<h3 id="람다의-특징"><a href="#람다의-특징" class="headerlink" title="람다의 특징"></a>람다의 특징</h3><ul>
<li>익명 : 보통의 메서드와 달리 익명이라표현 </li>
<li>함수 : 람다는 메서드처럼 특정 클래스에 종속되지 않으므로 <strong>함수</strong> 라고 부름. 단, 메서드와 동일하게 파라미터, 바디, 반환형식 간으한 예외 리스트를 포함함.</li>
<li>전달 : 람다 표현식을 메서드 인수로 전달하거나 변수로 저장할수 있음. </li>
<li>간결성 : 익명 클래스처럼 많은 자질 구레한 코드를 구현할 필요가 없음. </li>
</ul>
<h2 id="3-2-함수형-인터페이스"><a href="#3-2-함수형-인터페이스" class="headerlink" title="3-2. 함수형 인터페이스"></a>3-2. 함수형 인터페이스</h2><p>함수형 인터페이스는 정확히 하나의 추상 메서드를 지정하는 인터페이스다! </p>
<figure class="highlight java"><figcaption><span>함수형인터페이스들</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Predicate</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(T t)</span></span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">compare</span><span class="params">(T o1, T o2)</span></span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ActionListener</span> <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function">V <span class="title">call</span><span class="params">()</span></span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PrivilegedAction</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function">T <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-람다-활용"><a href="#3-3-람다-활용" class="headerlink" title="3-3. 람다 활용"></a>3-3. 람다 활용</h2><figure class="highlight java"><figcaption><span>processFile메서드를 람다로 변환 과정</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">processFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;	</span><br><span class="line">	<span class="keyword">try</span>(BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">&quot;data.txt&quot;</span>))) &#123;</span><br><span class="line">		<span class="keyword">return</span> br.readLine();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1단계-동작-파라미터화를-기억하라"><a href="#1단계-동작-파라미터화를-기억하라" class="headerlink" title="1단계: 동작 파라미터화를 기억하라!"></a>1단계: 동작 파라미터화를 기억하라!</h3><p>위 코드는 파일에서 한번에 한줄만 읽을수 있음. 한번에 두줄을 읽거나 가장 자주 사용되는 단어를 반환하려면 어떻게 해야할까?<br>결론은 동작파라미터화를 사용하는것이다. 아래 코드처럼 작성이 되어야할것이다. </p>
<figure class="highlight java"><figcaption><span>processFile메서드를 람다로 변환 과정-동작파라미터화1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String result = processFile((BufferedReader br) -&gt; br.readLine() + br.readLine()); </span><br></pre></td></tr></table></figure>

<h3 id="2단계-함수형-인터페이스를-이용해서-동작-전달"><a href="#2단계-함수형-인터페이스를-이용해서-동작-전달" class="headerlink" title="2단계: 함수형 인터페이스를 이용해서 동작 전달!"></a>2단계: 함수형 인터페이스를 이용해서 동작 전달!</h3><figure class="highlight java"><figcaption><span>processFile메서드를 람다로 변환 과정-동작파라미터화2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BufferedReaderProcessor</span> </span>&#123;</span><br><span class="line">	<span class="function">String <span class="title">process</span><span class="params">(BufferedReader b)</span> <span class="keyword">throws</span> IOException</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">processFile</span><span class="params">(BufferedReaderProcessor p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3단계-동작실행"><a href="#3단계-동작실행" class="headerlink" title="3단계: 동작실행!"></a>3단계: 동작실행!</h3><figure class="highlight java"><figcaption><span>processFile메서드를 람다로 변환 과정-동작파라미터화3</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">processFile</span><span class="params">(BufferedReaderProcessor p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">try</span>(BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">&quot;data.txt&quot;</span>))) &#123;</span><br><span class="line">		<span class="keyword">return</span> p.process(br);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4단계-람다-전달"><a href="#4단계-람다-전달" class="headerlink" title="4단계: 람다 전달!"></a>4단계: 람다 전달!</h3><figure class="highlight java"><figcaption><span>processFile메서드를 람다로 변환 과정-동작파라미터화4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String oneLine = processFile((BufferedReader br) -&gt; br.readLine());</span><br><span class="line">String twoLine = processFile((BufferedReader br) -&gt; br.readLine() + br.readLine());</span><br></pre></td></tr></table></figure>

<h2 id="3-4-함수형-인터페이스-사용"><a href="#3-4-함수형-인터페이스-사용" class="headerlink" title="3-4. 함수형 인터페이스 사용"></a>3-4. 함수형 인터페이스 사용</h2><h3 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h3><figure class="highlight java"><figcaption><span>Predicate사용</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Predicate</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(T t)</span></span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">filter</span><span class="params">(List&lt;T&gt; list, Predicate&lt;T&gt; p)</span> </span>&#123;</span><br><span class="line">	List&lt;T&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	<span class="keyword">for</span>(T s: list) &#123;</span><br><span class="line">		<span class="keyword">if</span>(p.test(s)) &#123;</span><br><span class="line">			results.add(s);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> results; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Predicate&lt;String&gt; nonEmptyStringPredicate = (String s) -&gt; !s.isEmpty();</span><br><span class="line">List&lt;String&gt; nonEmpty = filter(listOfStrings, noneEmptyStringPredicate); </span><br></pre></td></tr></table></figure>

<h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><figure class="highlight java"><figcaption><span>Consumer사용</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Consumer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">accept</span><span class="params">(T t)</span></span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">forEach</span><span class="params">(List&lt;T&gt; list, Consumer&lt;T&gt; c)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(T i: list) &#123;</span><br><span class="line">		c.accept(i); 		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach(Arrays.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>), (Integer i) -&gt; System.out.println(i));</span><br></pre></td></tr></table></figure>

<h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><figure class="highlight java"><figcaption><span>Function사용</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Function</span>&lt;<span class="title">T</span>,<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function">R <span class="title">apply</span><span class="params">(T t)</span></span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T,R&gt; <span class="function">List&lt;R&gt; <span class="title">map</span><span class="params">(List&lt;T&gt; list, Function&lt;T,R&gt; f)</span> </span>&#123;</span><br><span class="line">	List&lt;R&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">	<span class="keyword">for</span>(T s: list) &#123;</span><br><span class="line">		 result.add(f.apply(s));		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; stringLength = map(Arrays.asList(<span class="string">&quot;lambdas&quot;</span>,<span class="string">&quot;in&quot;</span>,<span class="string">&quot;action&quot;</span>),((String s) -&gt; s.length()));</span><br></pre></td></tr></table></figure>

<h4 id="기본형-특화"><a href="#기본형-특화" class="headerlink" title="기본형 특화"></a>기본형 특화</h4><p>자바의 모든형식은 참조형과 기본형으로 나눌수있음. </p>
<blockquote>
<p>참조형 : Byte, Integer, Object..<br>기본형 : int,double,long,char..<br>기본형을 참조형으로 변환하는 부분을 박싱(boxing)이라고 하고, 참조형을 기본형으로 변호나하는 동작을 언박싱(unboxing)이라고함. 자바에서는 이런 박싱/언박싱을 자동으로 해주는데, 이를 오토박싱이라함.<br>하지만 이런 변환과정은 비용이 소모됨. 박싱한 값은 기본형으로 감싸는 래퍼며 힙에 저장됨. 따라서 박싱한 값은 메모리를 더 소비하며 기본형을 가져올때도 메모리를 탐색하는 과정이 필요함. </p>
</blockquote>
<p>자바8에서는 이런 박싱/언박싱 되는 부분을 위해서 함수형인터페이스로 아예 제공하고있음.<br>예를들면 int파라미터를 받는 부분을 boolean으로 변환시켜주는 Predicate는 IntPredicate이런식으로 아예 기본클래스로 제공하고있음.<br>더 자세한 부분은 아래 참고 </p>
<p><img src="/images/java8/java-2.png" alt="오토박싱지원되는 함수형인터페이스"></p>
<p><img src="/images/java8/java-3.png" alt="람다와 함수형인터페이스 관계 예제"></p>
<blockquote><p>예외,람다,함수형 인터페이스 관계<br>함수형 인터페이스는 확인된 예외를 던지는 동작을 허용하지 않는다. 즉, 예외를 던지는 람다 표현식을 만드려면 확인된 예외를 선언하는 함수형 인터페이스를 직접 정의하거나 람다를 try/catch블록으로 감싸야함</p>
<p>@FunctionalInterface<br>public interface BufferedReaderProcessor {<br>    String process(BufferedReader b) throws IOException;<br>}<br>BufferedReaderProcessor p = (BufferedReader br) -&gt; br.readLine();</p>
<p>위와같이 지난 예제에서 동작파라미터화를 통해 BufferedReaderProcessor를 만들어서 예외처리까지 가능하도록 만들었었다. 하지만 이부분은 함수형 인터페이스의 Function&lt;T,R&gt;의 형태를 사용하고 있기 때문에 아래와같이 더 간단한 람다표현식으로 변경시켜서 명시적으로 확인된 예외를 체크할수있다. </p>
<p>Function&lt;BufferedReader, String&gt; f =<br>  (BufferedReader b) -&gt; {<br>    try {<br>      return b.readLine();<br>    }<br>    catch(IOException e) {<br>      throw new RuntimeException(e);<br>    }<br>  };</p>
</blockquote>

<h2 id="3-5-형식-검사-형식-추론-제약"><a href="#3-5-형식-검사-형식-추론-제약" class="headerlink" title="3-5. 형식 검사, 형식 추론, 제약"></a>3-5. 형식 검사, 형식 추론, 제약</h2><h3 id="지역-변수-사용"><a href="#지역-변수-사용" class="headerlink" title="지역 변수 사용"></a>지역 변수 사용</h3><p>람다 표현식에는 익명함수가 하는 것처럼 자유 변수(파라미터로 넘겨진 변수가 아닌 외부에서 정의된 변수)를 활용 할수 있다. 이와 같은 동작을 람다 캡처링이라고 부른다. 람다는 인스턴스 변수와 정적 변수를 캡처(자신의 바디에서 참조할수 있도록) 할수 있다. 하지만 지역 변수는 명시적으로 final로 선언되어 있어야 하거나 실질적으로 final 로 선언된 변수와 똑같이 사용되어야 한다. </p>
<h4 id="지역변수의-제약"><a href="#지역변수의-제약" class="headerlink" title="지역변수의 제약"></a>지역변수의 제약</h4><p>지역 변수에 왜 이런 제약이 필요할까?</p>
<ul>
<li>인스턴스 변수 와 지역변수는 태생적으로 다름. 인스턴수 변수는 힙에 저장되지만, 지역변수는 스택에 쌓임 </li>
<li>만약 람다에서 지역 변수에 바로 접근 할수 있다는 가정하에 람다가 스레드에서 실행된다면, 변수를 할당한 스레드가 사라져서 변수 할당이 해제되었는데도 람다를 실행하는 스레드에서는 해당변수에 접근하려 할 수 있다. </li>
<li>위 와 같은 이유로 자바는 원래 변수에 접근을 허용하는것이 아니라, 자유 지역 변수의 복사본을 제공한다. 따라서 복사본의 값이 바뀌지 않아야 하므로 지역변수에는 한 번만 값을 할당해야 한다는 제약이 생긴것이다. </li>
</ul>
<blockquote><p>클로저????<br>원칙적으로 클로저란 함수의 비지역 변수를 자유롭게 참조할수있는 함수의 인스턴스를 가르킨다. 클로저는 클로저 외부에 정의된 변수의값에 접근하고, 갑을 바꿀수 있다. 다만 람다와 익명 클래스는 람다가 정의된 메서드의 지역변수의 값은 바꿀수없다. 람다가 정의된 메서드의 지역변수값은 final 변수여야한다. 위에 설명하였지만 지역 변수값은 스택에 쌓이기때문에 자신을 정의한 스레드와 생존을 같이 해야 하며, 따라서 지역변수는 final이어야한다. 가변 지역 변수를 새로운 스레드에서 캡처할수있다면 안전하지 않은 동작을 수행할 가능성이 생긴다.(인스턴스 변수는 스레드가 공유하는 힙에 존재하므로 특별한 제약이 없다.)</p>
</blockquote>

<h2 id="3-6-메서드-레퍼런스"><a href="#3-6-메서드-레퍼런스" class="headerlink" title="3-6. 메서드 레퍼런스"></a>3-6. 메서드 레퍼런스</h2><h3 id="메서드-레퍼런스를-만드는-방법"><a href="#메서드-레퍼런스를-만드는-방법" class="headerlink" title="메서드 레퍼런스를 만드는 방법"></a>메서드 레퍼런스를 만드는 방법</h3><ol>
<li>정적 메서드 레퍼런스 <ul>
<li>Integer::parInt </li>
</ul>
</li>
<li>다양한 형식의 인스턴스 메서드 레퍼런스<ul>
<li>String::length</li>
</ul>
</li>
<li>기존 객체의 인스턴스 메서드 레퍼런스 <ul>
<li>Transaction a1 = new Transaction(); void getValue() {}; a1::getValue </li>
</ul>
</li>
</ol>
<h4 id="생성자-레퍼런스"><a href="#생성자-레퍼런스" class="headerlink" title="생성자 레퍼런스"></a>생성자 레퍼런스</h4><figure class="highlight java"><figcaption><span>생성자레퍼런스 예시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Supplier&lt;Apple&gt; c1 = Apple::<span class="keyword">new</span>; <span class="comment">//디폴트 생성자</span></span><br><span class="line">Apple a1 = c1.get();</span><br><span class="line"></span><br><span class="line"><span class="comment">//위 예제는 아래와 같음 </span></span><br><span class="line">Supplier&lt;Apple&gt; c1 = () -&gt; <span class="keyword">new</span> Apple();</span><br><span class="line">Apple a1 = c1.get(); </span><br><span class="line"></span><br><span class="line">Function&lt;Integer, Apple&gt; c2 = Apple::<span class="keyword">new</span>; <span class="comment">//Apple(Integer weight) 생성자 함수 </span></span><br><span class="line">Apple a2 = c2.get(<span class="number">110</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//위 예제는 아래와 같음 </span></span><br><span class="line">Function&lt;Integer, Apple&gt; c2 = (Integer weight) -&gt; <span class="keyword">new</span> Apple(weight);</span><br><span class="line">Apple a2 = c2.get(<span class="number">110</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//map과 같은 메서드를 이용해서 Apple생성자로 전달 가능 </span></span><br><span class="line">List&lt;Integer&gt; weights = Arrays.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);</span><br><span class="line">List&lt;Apple&gt; apples = map(weights, Apple::<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">map</span><span class="params">(List&lt;Integer&gt; list, Function&lt;Integer, Apple&gt; f)</span> </span>&#123;</span><br><span class="line">	List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	<span class="keyword">for</span>(Integer e : list) &#123;</span><br><span class="line">		result.add(f.apply(e));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-7-람다-표현식을-조합할수-있는-유용한-메서드"><a href="#3-7-람다-표현식을-조합할수-있는-유용한-메서드" class="headerlink" title="3-7. 람다 표현식을 조합할수 있는 유용한 메서드"></a>3-7. 람다 표현식을 조합할수 있는 유용한 메서드</h2><h3 id="Comparator-조합"><a href="#Comparator-조합" class="headerlink" title="Comparator 조합"></a>Comparator 조합</h3><figure class="highlight java"><figcaption><span>Comparator 조합</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Comparator&lt;Apple&gt; c = Comparator.comparing(Apple::getWeight);</span><br><span class="line"><span class="comment">//역정렬 가능 </span></span><br><span class="line">inventory.sort(comparing(Apple::getWeight).reversed());</span><br><span class="line"></span><br><span class="line">inventory.sort(comparing(Apple::getWeight)</span><br><span class="line">						.reversed() <span class="comment">//무게를 내림차순으로 정렬</span></span><br><span class="line">						.thenComparing(Apple::getCountry)); <span class="comment">// 두 사과의 무게가 같음 국가별로 정렬 (2차 정렬)</span></span><br></pre></td></tr></table></figure>

<h3 id="Predicate-조합"><a href="#Predicate-조합" class="headerlink" title="Predicate 조합"></a>Predicate 조합</h3><figure class="highlight java"><figcaption><span>Predicate 조합</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Predicate&lt;Apple&gt; redAndHeavyAppleOrGreen = redApple.and(a -&gt; a.getWeight() &gt; <span class="number">150</span>)</span><br><span class="line">												   .or(a -&gt; <span class="string">&quot;green&quot;</span>.equals(a.getColor()));</span><br></pre></td></tr></table></figure>

<h3 id="Function-조합"><a href="#Function-조합" class="headerlink" title="Function 조합"></a>Function 조합</h3><figure class="highlight java"><figcaption><span>Predicate 조합</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//andThen</span></span><br><span class="line">Function&lt;Integer,Integer&gt; f = x -&gt; x + <span class="number">1</span>; </span><br><span class="line">Function&lt;Integer,Integer&gt; g = x -&gt; x * <span class="number">2</span>;</span><br><span class="line">Function&lt;Integer,Integer&gt; h = f.andThen(g);</span><br><span class="line"><span class="keyword">int</span> result = h.apply(<span class="number">1</span>); <span class="comment">//4반환 f먼저 계산하고 g계산 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//compose </span></span><br><span class="line">Function&lt;Integer,Integer&gt; f = x -&gt; x + <span class="number">1</span>; </span><br><span class="line">Function&lt;Integer,Integer&gt; g = x -&gt; x * <span class="number">2</span>;</span><br><span class="line">Function&lt;Integer,Integer&gt; h = f.compose(g);</span><br><span class="line"><span class="keyword">int</span> result = h.apply(<span class="number">1</span>); <span class="comment">//3반환 g먼저 계산하고 f계산</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Letter</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">addHeader</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;From Raoul, Mario and Alan: &quot;</span> + text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">addFooter</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> text + <span class="string">&quot; Kind regards&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">checkSpelling</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> text.replaceAll(<span class="string">&quot;labda&quot;</span>, <span class="string">&quot;lambda&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//header추가 -&gt; 스펠링체크 -&gt; footer추가 순으로 파이프라이닝을 만들수있음. (메서드체이닝)</span></span><br><span class="line">Function&lt;String, String&gt; addHeader = Letter::addHeader;</span><br><span class="line">Function&lt;String, String&gt; transformationPipeline</span><br><span class="line">  = addHeader.andThen(Letter::checkSpelling)</span><br><span class="line">             .andThen(Letter::addFooter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//스펠링체크는 제낄수있음.			 </span></span><br><span class="line">Function&lt;String, String&gt; addHeader = Letter::addHeader;</span><br><span class="line">Function&lt;String, String&gt; transformationPipeline</span><br><span class="line">  = addHeader.andThen(Letter::addFooter);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/20/java8-chaptor3/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/20/jpa-obj-query-3/"
                            aria-label=": jpa-obj-query-3"
                        >
                            jpa-obj-query-3
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-20T10:59:56+00:00">
	
		    May 20, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5%EC%BF%BC%EB%A6%AC%EC%96%B8%EC%96%B4/">객체지향쿼리언어</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="객체지향-쿼리-언어3"><a href="#객체지향-쿼리-언어3" class="headerlink" title="객체지향 쿼리 언어3"></a>객체지향 쿼리 언어3</h1><h2 id="1-Persistance-Context와-JPQL"><a href="#1-Persistance-Context와-JPQL" class="headerlink" title="1. Persistance Context와 JPQL"></a>1. Persistance Context와 JPQL</h2><h3 id="1-1-쿼리후-영속상태인-것과-아닌것"><a href="#1-1-쿼리후-영속상태인-것과-아닌것" class="headerlink" title="1-1. 쿼리후 영속상태인 것과 아닌것"></a>1-1. 쿼리후 영속상태인 것과 아닌것</h3><figure class="highlight java"><figcaption><span>영속상태구분</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select m form Member m <span class="comment">//엔티티조회 (영속성 관리됨)</span></span><br><span class="line">select o.address from Order o <span class="comment">//임베디드타입 조회 (영속성 관리 안됨)</span></span><br><span class="line">select m.id, m.username from Member m <span class="comment">//단순 필드조회 (영속성 관리 안됨)</span></span><br></pre></td></tr></table></figure>

<p>위 예제를 통해 알수있듯이, 조회한 엔티티만 영속성 컨텍스트에 관리가 됨. </p>
<h3 id="1-2-JPQL로-조회한-엔티티와-영속성-컨텍스트"><a href="#1-2-JPQL로-조회한-엔티티와-영속성-컨텍스트" class="headerlink" title="1-2. JPQL로 조회한 엔티티와 영속성 컨텍스트"></a>1-2. JPQL로 조회한 엔티티와 영속성 컨텍스트</h3><figure class="highlight java"><figcaption><span>영속상태구분</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">em.find(Member.class,<span class="string">&quot;m1&quot;</span>); <span class="comment">//회원1 조회 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//엔티티 쿼리 조회 결과가 회원1, 회원2</span></span><br><span class="line">List&lt;Member&gt; resultList = em.createQuery(<span class="string">&quot;select m from Member m&quot;</span>, Member.class).getResultList(); </span><br></pre></td></tr></table></figure>

<p>em.find로 회원1을 조회했는데, JPQL로 전체를 가져오는 List를 호출하였다. 그럼 위 조회 과정은 어떻게 될까?</p>
<blockquote><p>em.find 호출뒤, List 조회 했을경우 </p>
<ol>
<li>JPQL을 사용해서 조회 요청</li>
<li>JPQL은 SQL로 변환되어 DB에 조회 </li>
<li>조회한 결과와 영속성 컨텍스트를 비교 (em.find로 조회된값 : m1 ,조회한값 :m1,m2)</li>
<li>식별자 기준으로 m1은 이미 영속성관리에 있으므로 버리고, 기존에 영속성관리에 있던 m1이 반환대상이됨.</li>
<li>식별자 기준으로 m2는 영속성 컨텍스트에 없으므로, 영속성컨텍스트에 추가 </li>
<li>쿼리 결과인 m1,m2를 반환한다. 여기서 m1은 쿼리결과가 아니라 영속성 컨텍스트에 있던 엔티티임을 잊지말자! </li>
</ol>
</blockquote>

<p>여기서 알수있는 2가지 사실이있다.</p>
<ol>
<li>JPQL로 조회한 엔티티는 영속상태다. </li>
<li>영속성 컨텍스트에 이미 존재하는 엔티티가 있으면 기존 엔티티를 반환한다. </li>
</ol>
<p>영속성 컨텍스트는 영속상태인 엔티티의 동일성을 보장한다. em.find이든 JPQL로 조회하든 영속성 컨텍스트가 같으면 동일한 엔티티를 반환함. </p>
<h3 id="1-3-find-VS-JPQL"><a href="#1-3-find-VS-JPQL" class="headerlink" title="1-3. find() VS JPQL"></a>1-3. find() VS JPQL</h3><h4 id="find"><a href="#find" class="headerlink" title="find()"></a>find()</h4><ul>
<li>find 메서드는 엔티티를 영속성 컨텍스트에 먼저 찾고 없으면 DB에서 찾는다. 따라서 해당 엔티티가 영속성 컨텍스트에 존재하면 메모리에서 바로 찾으므로 성능상 이점이 있다. (그래서 1차캐시라 부름)</li>
</ul>
<h4 id="JPQL"><a href="#JPQL" class="headerlink" title="JPQL"></a>JPQL</h4><ul>
<li>JPQL은 항상 디비를 조회한다.</li>
<li>JPQL로 조회한 엔티티는 영속상태다. (왜냐 DB 조회후,영속성컨텍스트에 집어넣기때문 )</li>
<li>영속성 컨텍스트에 이미 존재하는 엔티티가있으면 기존 엔티티를 반환함. </li>
</ul>
<h2 id="2-JPQL과-flush모드"><a href="#2-JPQL과-flush모드" class="headerlink" title="2. JPQL과 flush모드"></a>2. JPQL과 flush모드</h2><h3 id="2-1-쿼리와-플러시-모드"><a href="#2-1-쿼리와-플러시-모드" class="headerlink" title="2-1. 쿼리와 플러시 모드"></a>2-1. 쿼리와 플러시 모드</h3><ul>
<li>JPQL은 영속성 컨텍스트 고려하지 않고, DB를 먼저 조회함. 따라서 JPQL을 실행하기전에 영속성 컨텍스트의 내용을 DB에 반영해야함. 그렇지 않으면 상이한결과가 발생할수있음. </li>
<li>FlushMode는 두가지있음. AUTO,COMMIT 이다.<ul>
<li>AUTO : FlushMode를 따로 지정하지 않으면 기본값임. AUTO는 JPQL가 수행되면 자동 FLUSH시켜버림. </li>
<li>COMMIT : COMMIT모드면 말그대로 커밋시점에 FLUSH가 됨. 따라서 JPQL쿼리가 수행되도, FLUSH되지않음. </li>
</ul>
</li>
<li>FlushMode.COMMIT은 왜 씀? <ul>
<li>flush가 너무 빈번하게 일어나는 상황에서 이모드를 사용하면 쿼리시 발생하는 플러시 횟수를 줄여서 성능 최적화 가능함. </li>
</ul>
</li>
<li>JPA를 사용하지않고, JDBC를 직접 사용해서 SQL을 실행할때도 플러시모드는 고민해야함. JPA를 통하지않고 JDBC로 직접 실행하면 JPA는 JDBC가 실행한 쿼리를 인식할 방법이 없음. 따라서 별도 JDBC호출은 플러시 모드를 AUTO로설정해도 무의미함. 이때는 JDBC로 쿼리를 실행하기전에 em.flush를 호출해서 영속성 컨텍스트의 내용을 디비에 동기화 하는게 안점함. </li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/20/jpa-obj-query-3/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/08/java8-chaptor2/"
                            aria-label=": java8-chaptor2"
                        >
                            java8-chaptor2
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-08T08:18:24+00:00">
	
		    May 08, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Java8InAction/">Java8InAction</a>, <a class="category-link" href="/categories/Study/">Study</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="Chapter-2-동작파라미터화-코드-전달하기"><a href="#Chapter-2-동작파라미터화-코드-전달하기" class="headerlink" title="Chapter 2. 동작파라미터화 코드 전달하기"></a>Chapter 2. 동작파라미터화 코드 전달하기</h1><h2 id="목차"><a href="#목차" class="headerlink" title="목차"></a>목차</h2><p><a href="#1.%EB%B3%80%ED%99%94%ED%95%98%EB%8A%94-%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD%EC%97%90-%EB%8C%80%EC%9D%91">1.변화하는 요구사항에 대응</a><br><a href="#2.%EB%8F%99%EC%9E%91%ED%8C%8C%EB%9D%BC%EB%AF%B8%ED%84%B0%ED%99%94">2.동작파라미터화</a><br><a href="#3.%EC%9D%B5%EB%AA%85%ED%81%B4%EB%9E%98%EC%8A%A4">3.익명클래스</a><br><a href="#4.%EB%9E%8C%EB%8B%A4-%ED%91%9C%ED%98%84%EC%8B%9D-%EB%AF%B8%EB%A6%AC%EB%B3%B4%EA%B8%B0">4.람다 표현식 미리보기</a><br><a href="#5.%EC%8B%A4%EC%A0%84%EC%98%88%EC%A0%9C:-Comparator,Runnable,GUI">5.실전예제: Comparator,Runnable,GUI</a></p>
<hr>
<h2 id="1-변화하는-요구사항에-대응"><a href="#1-변화하는-요구사항에-대응" class="headerlink" title="1.변화하는 요구사항에 대응"></a>1.변화하는 요구사항에 대응</h2><ul>
<li>우리가 어떤 상황에서 일을 하든 소비자 요구사항은 항상 바뀐다. 변화하는 요구사항은 소프트웨어 엔지니어링에서 피할수 없는 문제다. </li>
<li>동작 파라미터화(behavior parameterization) 을 활용하면 자주 바뀌는 요구사항에 효과적으로 대응 할수 있다. </li>
<li>동작 파라미터란? 아직은 어떻게 실행할 것인지 결정하지 않은 코드 블록을 의미함. 이 코드 블록은 나중에 프로그램에서 호출한다. 즉, 코드블록의 실행은 나중으로 미뤄진다. </li>
</ul>
<h3 id="1-1-첫번째시도-녹색사과-필터링"><a href="#1-1-첫번째시도-녹색사과-필터링" class="headerlink" title="1-1. 첫번째시도:녹색사과 필터링"></a>1-1. 첫번째시도:녹색사과 필터링</h3><figure class="highlight java"><figcaption><span>filterGreenApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Color</span> </span>&#123; RED, GREEN &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterGreenApples</span><span class="params">(List&lt;Apple&gt; inventory)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();                          <span class="number">1.</span>사과 누적리스트</span><br><span class="line">    <span class="keyword">for</span>(Apple apple: inventory)&#123;</span><br><span class="line">        <span class="keyword">if</span>( GREEN.equals(apple.getColor() ) &#123;                        <span class="number">2.</span>녹색사과 필터 </span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-두번째시도-색을-파라미터화"><a href="#1-2-두번째시도-색을-파라미터화" class="headerlink" title="1-2. 두번째시도:색을 파라미터화"></a>1-2. 두번째시도:색을 파라미터화</h4><figure class="highlight java"><figcaption><span>filterGreenApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApplesByColor</span><span class="params">(List&lt;Apple&gt; inventory,</span></span></span><br><span class="line"><span class="function"><span class="params">Color color)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Apple apple: inventory) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( apple.getColor().equals(color) ) &#123;</span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;Apple&gt; greenApples = filterApplesByColor(inventory, GREEN);</span><br><span class="line">List&lt;Apple&gt; redApples = filterApplesByColor(inventory, RED);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 농부의 다양한 요구사항을 들어보니 색과 마찬가지로 앞으로 무게의 기준도 얼마든지 바뀔수있다는걸 알게됫음.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApplesByWeight</span><span class="params">(List&lt;Apple&gt; inventory,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> weight)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    For (Apple apple: inventory)&#123;</span><br><span class="line">        <span class="keyword">if</span> ( apple.getWeight() &gt; weight ) &#123;</span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>주로 내가 현업에서 개발하던 스타일이며 자주 보던 스타일이다. 코드 자체가 저렇게 필터링 되는 조건만 달라지고 나머지는 거의 동일한 로직으로 처리되는 로직들을 종종 볼수있었다. 그렇다보니 최악의 코드이며 가장 더러운 방식까지 내려가던일도 진짜 가끔있었다. 세번째 시도를 한번 보자.</p>
<h4 id="1-3-세번째-시도-가능한-모든-속성으로-필터링"><a href="#1-3-세번째-시도-가능한-모든-속성으로-필터링" class="headerlink" title="1-3. 세번째 시도: 가능한 모든 속성으로 필터링"></a>1-3. 세번째 시도: 가능한 모든 속성으로 필터링</h4><figure class="highlight java"><figcaption><span>filterApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApples</span><span class="params">(List&lt;Apple&gt; inventory, Color color,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">int</span> weight, <span class="keyword">boolean</span> flag)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Apple apple: inventory) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (flag &amp;&amp; apple.getColor().equals(color)) ||</span><br><span class="line">             (!flag &amp;&amp; apple.getWeight() &gt; weight) )&#123;          <span class="number">1.</span> 정말 더럽다. 코드가..-_-; flag의 용도는 대체 뭐임? </span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위 코드를 보자하니, 정말 답이없다. 우선 flag의 용도는 뭘까? 하나의 공통 코드로 만들어보려다가 오히려 똥 만들어놨다. 부끄럽지만 나도 저렇게 짜려고 했던적이 있던것 같다. 이제부터 동작 파라미터화를 하는 방법에 대해서 확인해보자! </p>
<hr>
<h2 id="2-동작파라미터화"><a href="#2-동작파라미터화" class="headerlink" title="2.동작파라미터화"></a>2.동작파라미터화</h2><h3 id="2-1-네번째시도-추상적조건으로-필터링"><a href="#2-1-네번째시도-추상적조건으로-필터링" class="headerlink" title="2-1. 네번째시도: 추상적조건으로 필터링"></a>2-1. 네번째시도: 추상적조건으로 필터링</h3><figure class="highlight java"><figcaption><span>predicate</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplePredicate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">test</span> <span class="params">(Apple apple)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppleHeavyWeightPredicate</span> <span class="keyword">implements</span> <span class="title">ApplePredicate</span> </span>&#123;   <span class="number">1.</span> 무게 <span class="number">150</span>이상</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple apple)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> apple.getWeight() &gt; <span class="number">150</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppleGreenColorPredicate</span> <span class="keyword">implements</span> <span class="title">ApplePredicate</span> </span>&#123;    <span class="number">2.</span> 녹색사과만 </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple apple)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> GREEN.equals(apple.getColor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppleRedAndHeavyPredicate</span> <span class="keyword">implements</span> <span class="title">ApplePredicate</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple apple)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> RED.equals(apple.getColor())</span><br><span class="line">                       &amp;&amp; apple.getWeight() &gt; <span class="number">150</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApples</span><span class="params">(List&lt;Apple&gt; inventory,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       ApplePredicate p)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Apple apple: inventory) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p.test(apple)) &#123;                       <span class="number">1.</span> predicate객체로 사과 검사 조건 캡슐화</span><br><span class="line">            result.add(apple);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">List&lt;Apple&gt; redAndHeavyApples =</span><br><span class="line">    filterApples(inventory, <span class="keyword">new</span> AppleRedAndHeavyPredicate());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/java8/java-1.png" alt="사과를 선택하는 다양한 전략"></p>
<p>위 그림처럼 전략패턴을 활용해서 사과의 필터조건을 결정하도록 개발하게되었다. 이렇게되면 각 구체 클래스에서 정의한 조건을 ApplePredicate 에 파라미터화 시키면 된다. 확실히 더러웠던 3번째시도 보다는 아주 스마트하고 깔끔해졌다. 역시 이래서 디자인패턴을 활용해야하나 보다. </p>
<hr>
<h2 id="3-익명클래스"><a href="#3-익명클래스" class="headerlink" title="3.익명클래스"></a>3.익명클래스</h2><ul>
<li>익명 클래스는 자바의 지역클래스(블록 내부에 설정된 클래스)와 비슷한개념이다.</li>
<li>익명 클래스를 이용하면 클래스 선언과 인스턴스화를 동시에 할 수 있다.</li>
</ul>
<h3 id="3-1-다섯번째-시도-익명클래스-사용"><a href="#3-1-다섯번째-시도-익명클래스-사용" class="headerlink" title="3-1. 다섯번째 시도: 익명클래스 사용"></a>3-1. 다섯번째 시도: 익명클래스 사용</h3><figure class="highlight java"><figcaption><span>filterApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">List&lt;Apple&gt; redApples = filterApples(inventory, <span class="keyword">new</span> ApplePredicate() &#123;     <span class="number">1.</span>메서드를 파라미터화 시켰음. </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple apple)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RED.equals(apple.getColor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>위 처럼 메서드를 파라미터화 시켜서 익명클래스를 적용은 시켰지만 여전히 빨간사과를 필터링하는 조건이 이외에 코드들이 너무 장황하다. 이런 익명클래스는 람다식을 통해 코드량을 단축시킬수있다. </p>
<hr>
<h2 id="4-람다-표현식-미리보기"><a href="#4-람다-표현식-미리보기" class="headerlink" title="4.람다 표현식 미리보기"></a>4.람다 표현식 미리보기</h2><h3 id="4-1-여섯번째-시도-람다-표현식-사용"><a href="#4-1-여섯번째-시도-람다-표현식-사용" class="headerlink" title="4-1. 여섯번째 시도: 람다 표현식 사용"></a>4-1. 여섯번째 시도: 람다 표현식 사용</h3><figure class="highlight java"><figcaption><span>filterApples</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">List&lt;Apple&gt; result =</span><br><span class="line">  filterApples(inventory, (Apple apple) -&gt; RED.equals(apple.getColor()));</span><br></pre></td></tr></table></figure>

<p>이렇게 람다 표현식을 사용하면 코드를 더 심플하게 작성이 가능하다. </p>
<h3 id="4-2-일곱번째-시도-리스트형식-추상화"><a href="#4-2-일곱번째-시도-리스트형식-추상화" class="headerlink" title="4-2. 일곱번째 시도: 리스트형식 추상화"></a>4-2. 일곱번째 시도: 리스트형식 추상화</h3><figure class="highlight java"><figcaption><span>filterApples:generic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Predicate</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(T t)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">filter</span><span class="params">(List&lt;T&gt; list, Predicate&lt;T&gt; p)</span> </span>&#123;     <span class="number">1</span></span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(T e: list) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p.test(e)) &#123;</span><br><span class="line">            result.add(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>앞으로 이렇게 추상화 시켜서, 공통 모듈로 만드는 습관이 필요하다. 모든 개발할때 저런 추상화를 늘 고려해서 개발하는 경지에 이르렀으면 좋겠다. </p>
<hr>
<h2 id="5-실전예제-Comparator-Runnable-GUI"><a href="#5-실전예제-Comparator-Runnable-GUI" class="headerlink" title="5.실전예제: Comparator,Runnable,GUI"></a>5.실전예제: Comparator,Runnable,GUI</h2><h3 id="5-1-Comparator로-정렬하기"><a href="#5-1-Comparator로-정렬하기" class="headerlink" title="5-1. Comparator로 정렬하기"></a>5-1. Comparator로 정렬하기</h3><figure class="highlight java"><figcaption><span>Comparator정렬</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">inventory.sort(<span class="keyword">new</span> Comparator&lt;Apple&gt;() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Apple a1, Apple a2)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> a1.getWeight().compareTo(a2.getWeight());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inventory.sort(</span><br><span class="line">  (Apple a1, Apple a2) -&gt; a1.getWeight().compareTo(a2.getWeight()));</span><br><span class="line">  </span><br></pre></td></tr></table></figure>


<h3 id="5-2-Runnable"><a href="#5-2-Runnable" class="headerlink" title="5-2. Runnable"></a>5-2. Runnable</h3><figure class="highlight java"><figcaption><span>Runnable</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">// java.lang.Runnable 인터페이스</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//익명클래스 표현</span></span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//람다식표현</span></span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">&quot;Hello world&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// java.util.concurrent.Callable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">V <span class="title">call</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">Future&lt;String&gt; threadName = executorService.submit(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Future&lt;String&gt; threadName = executorService.submit(</span><br><span class="line">                     () -&gt; Thread.currentThread().getName());</span><br></pre></td></tr></table></figure>


<h3 id="5-3-GUI-이벤트-처리하기"><a href="#5-3-GUI-이벤트-처리하기" class="headerlink" title="5-3. GUI 이벤트 처리하기"></a>5-3. GUI 이벤트 처리하기</h3><figure class="highlight java"><figcaption><span>GUI</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">Button button = <span class="keyword">new</span> Button(<span class="string">&quot;Send&quot;</span>);</span><br><span class="line">button.setOnAction(<span class="keyword">new</span> EventHandler&lt;ActionEvent&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(ActionEvent event)</span> </span>&#123;</span><br><span class="line">        label.setText(<span class="string">&quot;Sent!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">button.setOnAction((ActionEvent event) -&gt; label.setText(<span class="string">&quot;Sent!!&quot;</span>));</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/08/java8-chaptor2/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/08/jpa-obj-query-2/"
                            aria-label=": jpa-obj-query-2"
                        >
                            jpa-obj-query-2
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-08T02:54:28+00:00">
	
		    May 08, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5%EC%BF%BC%EB%A6%AC%EC%96%B8%EC%96%B4/">객체지향쿼리언어</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="객체지향-쿼리-언어2"><a href="#객체지향-쿼리-언어2" class="headerlink" title="객체지향 쿼리 언어2"></a>객체지향 쿼리 언어2</h1><h2 id="1-경로표현식"><a href="#1-경로표현식" class="headerlink" title="1. 경로표현식"></a>1. 경로표현식</h2><h3 id="1-1-경로표현식이란"><a href="#1-1-경로표현식이란" class="headerlink" title="1-1. 경로표현식이란?"></a>1-1. 경로표현식이란?</h3><ul>
<li>. 찍어서 객체그래프를 탐색하는 것 </li>
</ul>
<h3 id="1-2-경로표현식-특징"><a href="#1-2-경로표현식-특징" class="headerlink" title="1-2. 경로표현식 특징"></a>1-2. 경로표현식 특징</h3><ul>
<li>상태 필드(state field): 경로 탐색의 끝, 탐색X</li>
<li>단일 값 연관 경로: 묵시적 내부 조인(inner join) 발생, 탐색O<ul>
<li>@ManyToOne, @OneToOne, 대상이 엔티티(ex: m.team)</li>
</ul>
</li>
<li>컬렉션 값 연관 경로: 묵시적 내부 조인 발생, 탐색X<ul>
<li>FROM 절에서 명시적 조인을 통해 별칭을 얻으면 별칭을 통 해 탐색 가능</li>
<li>@OneToMany, @ManyToMany, 대상이 컬렉션(ex: m.orders)</li>
</ul>
</li>
</ul>
<h3 id="1-3-경로탐색을-사용한-묵시적-조인-시-주의사항"><a href="#1-3-경로탐색을-사용한-묵시적-조인-시-주의사항" class="headerlink" title="1-3. 경로탐색을 사용한 묵시적 조인 시 주의사항"></a>1-3. 경로탐색을 사용한 묵시적 조인 시 주의사항</h3><ul>
<li>항상 내부조인 걸림 </li>
<li>걸렉션은 경로 탐색이 안된다. (사이즈만 받을수있음) 따라서 컬렉션은 반드시 명시적 조인으로 별칭을 얻어서 경로탐색하도록 해야함<ul>
<li>select m.username from Team t join t.members m</li>
</ul>
</li>
<li>경로탐색은 주로 SELECT/WHERE 절에서만 하는데, 묵시적조인을 사용하면 SQL에서 FROM(JOIN) 절에 영향을 줌 </li>
</ul>
<h3 id="1-4-실무자의-조언"><a href="#1-4-실무자의-조언" class="headerlink" title="1-4. 실무자의 조언"></a>1-4. 실무자의 조언</h3><ul>
<li>가급적 묵시적 조인 하지말고 명시적 조인만 사용하도록 하자 (쿼리 튜닝 및 알아보기 힘듦)</li>
<li>조인은 sql튜닝에 가장 중요한 포인트(기승전 SQL)</li>
<li>묵시적 조인은 조인이 일어나는 상황을 한눈에 파악하기 어려움 </li>
</ul>
<h2 id="2-페치-조인-fetch-join"><a href="#2-페치-조인-fetch-join" class="headerlink" title="2. 페치 조인 (fetch join)"></a>2. 페치 조인 (fetch join)</h2><h3 id="2-1-페치-조인의-특징"><a href="#2-1-페치-조인의-특징" class="headerlink" title="2-1. 페치 조인의 특징"></a>2-1. 페치 조인의 특징</h3><ul>
<li>SQL join종류 아님 (sql 명령어 아님)</li>
<li>JPQL 성능 최적화를 위해 제공하는 기능 </li>
<li>연관된 엔티티나 컬렉션을 SQL 한번에 함께 조회 가능 (한방쿼리)</li>
<li>join fetch 명령어 사용 </li>
<li>페치 조인 ::= [ LEFT [OUTER] | INNER ] JOIN FETCH 조인경로</li>
</ul>
<h3 id="2-2-엔티티-페치-조인"><a href="#2-2-엔티티-페치-조인" class="headerlink" title="2-2. 엔티티 페치 조인"></a>2-2. 엔티티 페치 조인</h3><ul>
<li>ManyToOne, OneToOne 관계에서 조회할때 이슈라고 생각해도됨. </li>
<li>회원-팀 예시 기준으로 회원을 조회하면서 연관된 팀도 함께 조회 (SQL 한방 쿼리)</li>
<li>SQL을 보면 회원 뿐만 아니라 팀(T.*)도 함께 SELECT</li>
<li>[JPQL]<ul>
<li>select m from Member m join fetch m.team</li>
</ul>
</li>
<li>[SQL]<ul>
<li>SELECT M.<em>, T.</em> FROM MEMBER M INNER JOIN TEAM T ON M.TEAM_ID=T.ID</li>
</ul>
</li>
</ul>
<p><img src="/images/jpa/jpql-11.png" alt="엔티티페치조인 예시"><br><img src="/images/jpa/jpql-12.png" alt="엔티티페치코드 예시"></p>
<p>[Q1] 그냥 Member 엔티티를 쿼리를 날리고, 비즈니스코드에서 Team정보를 조회하면?</p>
<figure class="highlight java"><figcaption><span>엔티티조회</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; members =entityManager.createQuery(<span class="string">&quot;select m from Member m&quot;</span>, Member.class).getResultList();</span><br><span class="line"><span class="keyword">for</span> (Member member1 : members2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;member1.getUserName() = &quot;</span> + member1.getUserName() </span><br><span class="line">				+ <span class="string">&quot;/ teamName : &quot;</span> + member1.getTeam().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>–&gt; 위 처럼 비즈니스로직에서 Team정보를 호출하면 proxy상태이기때문에, 초기화처리로 각 멤버당 팀 정보를 디비를 통해 조회 해오게된다. 하지만 1차캐시에 등록된 그니까 영속성 관리가 되면 1차캐시 정보로 가져오게됨. </p>
<figure class="highlight plain"><figcaption><span>엔티티조회결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        m </span><br><span class="line">    from</span><br><span class="line">        Member m *&#x2F; select</span><br><span class="line">            member0_.member_id as member_i1_0_,</span><br><span class="line">            member0_.age as age2_0_,</span><br><span class="line">            member0_.team_id as team_id4_0_,</span><br><span class="line">            member0_.userName as userName3_0_ </span><br><span class="line">        from</span><br><span class="line">            Member member0_</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        team0_.team_id as team_id1_3_0_,</span><br><span class="line">        team0_.name as name2_3_0_ </span><br><span class="line">    from</span><br><span class="line">        Team team0_ </span><br><span class="line">    where</span><br><span class="line">        team0_.team_id&#x3D;?</span><br><span class="line">member1.getUserName() &#x3D; m1&#x2F; teamName : Team1</span><br><span class="line">member1.getUserName() &#x3D; m2&#x2F; teamName : Team1 &#x2F;&#x2F;여기서는 1차캐시로 조회된 정보 가져옴 </span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        team0_.team_id as team_id1_3_0_,</span><br><span class="line">        team0_.name as name2_3_0_ </span><br><span class="line">    from</span><br><span class="line">        Team team0_ </span><br><span class="line">    where</span><br><span class="line">        team0_.team_id&#x3D;?</span><br><span class="line">member1.getUserName() &#x3D; m3&#x2F; teamName : Team2</span><br></pre></td></tr></table></figure>

<p>[Q2] 위 쿼리에서 Team엔티티를 조인해서 조회하면 어떻게 될까? </p>
<figure class="highlight java"><figcaption><span>단순 조인시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; members =entityManager.createQuery(<span class="string">&quot;select m from Member m join m.team&quot;</span>, Member.class).getResultList();</span><br><span class="line"><span class="keyword">for</span> (Member member1 : members2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;member1.getUserName() = &quot;</span> + member1.getUserName() </span><br><span class="line">				+ <span class="string">&quot;/ teamName : &quot;</span> + member1.getTeam().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>–&gt; 단순 조인만 했지만 프로젝션 상에서 팀정보가 없다.<br>어쨋든 위 상황에서는 프로젝션상에서 Team엔티티 정보가 없기때문에 Q1 상황과 동일한 결과로 나오게됨.<br>(참고) 글로벌 페치 전략을 아무리 EAGER로 강제해도 동일한 결과 나올수밖에 없음. 프록시 이슈는 동일하게 나올수밖에없더라.<br>(추론) 만약에 저기서 조회를 가능하게 하려면 프로젝션상에서 t를 받고, 프로젝션에 맞는 신규DTO를 만들어서 객체로 반환하면 해결되지않을까 싶음. </p>
<figure class="highlight plain"><figcaption><span>단순 조인시 결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        m </span><br><span class="line">    from</span><br><span class="line">        Member m </span><br><span class="line">    join</span><br><span class="line">        m.team *&#x2F; select</span><br><span class="line">            member0_.member_id as member_i1_0_,</span><br><span class="line">            member0_.age as age2_0_,</span><br><span class="line">            member0_.team_id as team_id4_0_,</span><br><span class="line">            member0_.userName as userName3_0_ </span><br><span class="line">        from</span><br><span class="line">            Member member0_ </span><br><span class="line">        inner join &#x2F;&#x2F;조인만 됫지 프로젝션상에서는 Team정보가 없다..-_-; </span><br><span class="line">            Team team1_ </span><br><span class="line">                on member0_.team_id&#x3D;team1_.team_id</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        team0_.team_id as team_id1_3_0_,</span><br><span class="line">        team0_.name as name2_3_0_ </span><br><span class="line">    from</span><br><span class="line">        Team team0_ </span><br><span class="line">    where</span><br><span class="line">        team0_.team_id&#x3D;?</span><br><span class="line">member1.getUserName() &#x3D; m1&#x2F; teamName : Team1</span><br><span class="line">member1.getUserName() &#x3D; m2&#x2F; teamName : Team1</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        team0_.team_id as team_id1_3_0_,</span><br><span class="line">        team0_.name as name2_3_0_ </span><br><span class="line">    from</span><br><span class="line">        Team team0_ </span><br><span class="line">    where</span><br><span class="line">        team0_.team_id&#x3D;?</span><br><span class="line">member1.getUserName() &#x3D; m3&#x2F; teamName : Team2</span><br></pre></td></tr></table></figure>

<p>[Q3] 그럼 저렇게 N+1이 나면 어떻게 해결해야함?<br>–&gt; fetch join 하면 됨. </p>
<figure class="highlight java"><figcaption><span>조인페치시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; members =entityManager.createQuery(<span class="string">&quot;select m from Member m join fetch m.team&quot;</span>, Member.class).getResultList();</span><br><span class="line"><span class="keyword">for</span> (Member member1 : members2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;member1.getUserName() = &quot;</span> + member1.getUserName() </span><br><span class="line">				+ <span class="string">&quot;/ teamName : &quot;</span> + member1.getTeam().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>단순 조인시 결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        m </span><br><span class="line">    from</span><br><span class="line">        Member m </span><br><span class="line">    join</span><br><span class="line">        fetch m.team *&#x2F; select</span><br><span class="line">            member0_.member_id as member_i1_0_0_,</span><br><span class="line">            team1_.team_id as team_id1_3_1_,</span><br><span class="line">            member0_.age as age2_0_0_,</span><br><span class="line">            member0_.team_id as team_id4_0_0_,</span><br><span class="line">            member0_.userName as userName3_0_0_,</span><br><span class="line">            team1_.name as name2_3_1_ </span><br><span class="line">        from</span><br><span class="line">            Member member0_ </span><br><span class="line">        inner join</span><br><span class="line">            Team team1_ </span><br><span class="line">                on member0_.team_id&#x3D;team1_.team_id</span><br><span class="line">member1.getUserName() &#x3D; m1&#x2F; teamName : Team1</span><br><span class="line">member1.getUserName() &#x3D; m2&#x2F; teamName : Team1</span><br><span class="line">member1.getUserName() &#x3D; m3&#x2F; teamName : Team2</span><br></pre></td></tr></table></figure>

<h3 id="2-3-컬렉션-페치-조인"><a href="#2-3-컬렉션-페치-조인" class="headerlink" title="2-3. 컬렉션 페치 조인"></a>2-3. 컬렉션 페치 조인</h3><ul>
<li>일대다,다대다 관계, 컬렉션 페치 조인 </li>
<li>[JPQL]<ul>
<li>select t from Team t join fetch t.members where t.name = ‘팀A’</li>
</ul>
</li>
<li>[SQL]<ul>
<li>SELECT T.<em>, M.</em> FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID WHERE T.NAME = ‘팀A’</li>
</ul>
</li>
</ul>
<p><img src="/images/jpa/jpql-13.png" alt="컬렉션페치조인 예시"><br><img src="/images/jpa/jpql-14.png" alt="컬렉션페치코드 예시"></p>
<h3 id="컬렉션-페치-조인-혹은-그냥-조인을-걸었는데-중복-발생"><a href="#컬렉션-페치-조인-혹은-그냥-조인을-걸었는데-중복-발생" class="headerlink" title="컬렉션 페치 조인 혹은 그냥 조인을 걸었는데 중복 발생?"></a>컬렉션 페치 조인 혹은 그냥 조인을 걸었는데 중복 발생?</h3><p>OneToMany특성상 쿼리 뻥튀기가 되었기때문에 중복 row발생된것임. 이걸 해결할라면 jpql의 distinct를 걸어주면 해결됨. </p>
<h4 id="JPQL에서의-distinct"><a href="#JPQL에서의-distinct" class="headerlink" title="JPQL에서의 distinct"></a>JPQL에서의 distinct</h4><ul>
<li>SQL의 distinct 처리를 명령함  </li>
<li>JPQL에서는 distinct 2가지 기능 제공 <ol>
<li>SQL distinct 를 추가시킴. </li>
<li>애플리케이션에서 엔티티 중복을 제거시킴. </li>
</ol>
</li>
</ul>
<p>[Q1] Member 컬렉션을 조인하면 어떻게 될까?</p>
<figure class="highlight java"><figcaption><span>컬렉션조인시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select t from Team t join t.members&quot;</span>, Team.class)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션조인결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        t </span><br><span class="line">    from</span><br><span class="line">        Team t </span><br><span class="line">    join</span><br><span class="line">        t.members *&#x2F; select</span><br><span class="line">            team0_.team_id as team_id1_3_,</span><br><span class="line">            team0_.name as name2_3_ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ </span><br><span class="line">        inner join</span><br><span class="line">            Member members1_ </span><br><span class="line">                on team0_.team_id&#x3D;members1_.team_id</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        members0_.team_id as team_id4_0_0_,</span><br><span class="line">        members0_.member_id as member_i1_0_0_,</span><br><span class="line">        members0_.member_id as member_i1_0_1_,</span><br><span class="line">        members0_.age as age2_0_1_,</span><br><span class="line">        members0_.team_id as team_id4_0_1_,</span><br><span class="line">        members0_.userName as userName3_0_1_ </span><br><span class="line">    from</span><br><span class="line">        Member members0_ </span><br><span class="line">    where</span><br><span class="line">        members0_.team_id&#x3D;?</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2 &#x2F;&#x2F;컬렉션 조인시 요렇게 중복된 결과가 나오는걸 확인할수있음. 이럴때는 distinct를 걸어서 중복제거해야함. </span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">Hibernate: </span><br><span class="line">    select</span><br><span class="line">        members0_.team_id as team_id4_0_0_,</span><br><span class="line">        members0_.member_id as member_i1_0_0_,</span><br><span class="line">        members0_.member_id as member_i1_0_1_,</span><br><span class="line">        members0_.age as age2_0_1_,</span><br><span class="line">        members0_.team_id as team_id4_0_1_,</span><br><span class="line">        members0_.userName as userName3_0_1_ </span><br><span class="line">    from</span><br><span class="line">        Member members0_ </span><br><span class="line">    where</span><br><span class="line">        members0_.team_id&#x3D;?</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br></pre></td></tr></table></figure>

<p>[Q2] 컬렉션 조인을 페치하면 어떻게 될까?<br>–&gt; 쿼리는 fetch가 되서 한방쿼리가 되었지만, distinct처리 안해서 중복 엔티티 row발생함. </p>
<figure class="highlight java"><figcaption><span>컬렉션조인시</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select t from Team t join fetch t.members&quot;</span>, Team.class)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션조인결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        t </span><br><span class="line">    from</span><br><span class="line">        Team t </span><br><span class="line">    join</span><br><span class="line">        fetch t.members *&#x2F; select</span><br><span class="line">            team0_.team_id as team_id1_3_0_,</span><br><span class="line">            members1_.member_id as member_i1_0_1_,</span><br><span class="line">            team0_.name as name2_3_0_,</span><br><span class="line">            members1_.age as age2_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_1_,</span><br><span class="line">            members1_.userName as userName3_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_0__,</span><br><span class="line">            members1_.member_id as member_i1_0_0__ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ </span><br><span class="line">        inner join</span><br><span class="line">            Member members1_ </span><br><span class="line">                on team0_.team_id&#x3D;members1_.team_id</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2 &#x2F;&#x2F;fetch를하면 쿼리는 줄지만 distinct를 처리하지 않았기때문에 여전히 중복 발생 </span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br></pre></td></tr></table></figure>

<p>[Q3] 위 쿼리에서 distinct를 걸면 해결되나?<br>–&gt; 해결됨</p>
<figure class="highlight java"><figcaption><span>컬렉션페치조인 distinct처리</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select distinct t from Team t join fetch t.members&quot;</span>, Team.class)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션페치조인 distinct처리결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        distinct t </span><br><span class="line">    from</span><br><span class="line">        Team t </span><br><span class="line">    join</span><br><span class="line">        fetch t.members *&#x2F; select</span><br><span class="line">            distinct team0_.team_id as team_id1_3_0_,</span><br><span class="line">            members1_.member_id as member_i1_0_1_,</span><br><span class="line">            team0_.name as name2_3_0_,</span><br><span class="line">            members1_.age as age2_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_1_,</span><br><span class="line">            members1_.userName as userName3_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_0__,</span><br><span class="line">            members1_.member_id as member_i1_0_0__ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ </span><br><span class="line">        inner join</span><br><span class="line">            Member members1_ </span><br><span class="line">                on team0_.team_id&#x3D;members1_.team_id</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br></pre></td></tr></table></figure>

<p>[Q4] 컬렉션 페치 조인해서 페이징 적용하면 어떻게되나?<br>–&gt; 페이징 로직이 미적용되고, 메모리에 해당 엔티티들의 모든 row가 다 적재됨. (메모리 부하 발생 성능 다운됨.)</p>
<figure class="highlight java"><figcaption><span>컬렉션페치조인 페이징처리시도</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select distinct t from Team t join fetch t.members&quot;</span>, Team.class)</span><br><span class="line">                .setFirstResult(<span class="number">0</span>)</span><br><span class="line">                .setMaxResults(<span class="number">2</span>)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션페치조인 페이징적용결과</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        distinct t </span><br><span class="line">    from</span><br><span class="line">        Team t </span><br><span class="line">    join</span><br><span class="line">        fetch t.members *&#x2F; select</span><br><span class="line">            distinct team0_.team_id as team_id1_3_0_,</span><br><span class="line">            members1_.member_id as member_i1_0_1_,</span><br><span class="line">            team0_.name as name2_3_0_,</span><br><span class="line">            members1_.age as age2_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_1_,</span><br><span class="line">            members1_.userName as userName3_0_1_,</span><br><span class="line">            members1_.team_id as team_id4_0_0__,</span><br><span class="line">            members1_.member_id as member_i1_0_0__ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ </span><br><span class="line">        inner join</span><br><span class="line">            Member members1_ </span><br><span class="line">                on team0_.team_id&#x3D;members1_.team_id &#x2F;&#x2F;페이징 처리 로직 미적용됨. </span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;메모리 다 적재됫다고 경고떳음</span><br><span class="line">5월 08, 2021 3:11:40 오후 org.hibernate.hql.internal.ast.QueryTranslatorImpl list</span><br><span class="line">WARN: HHH000104: firstResult&#x2F;maxResults specified with collection fetch; applying in memory!</span><br><span class="line">5월 08, 2021 3:11:40 오후 org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl$PoolState stop</span><br><span class="line">INFO: HHH10001008: Cleaning up connection pool [jdbc:h2:tcp:&#x2F;&#x2F;localhost&#x2F;~&#x2F;jpqlshop]</span><br></pre></td></tr></table></figure>

<p>–&gt; 페이징을 강제로 해결하려면 페치조인 걸었던것 제거하고 Team.members에 @BatchSize를 걸던지, 혹은 글로벌 설정에서 persistence.xml혹은 application.yml등에서 batchsize를 설정해야함. 보통 글로벌 설정으로 설정하고 시작한다고함. </p>
<figure class="highlight java"><figcaption><span>컬렉션페치조인 페이징처리 batchsize적용상태</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/////// Team.java /////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@BatchSize(size = 100)</span></span><br><span class="line"><span class="meta">@OneToMany(mappedBy = &quot;team&quot;)</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Member&gt; members = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">///////// 구분 /////////////</span></span><br><span class="line"></span><br><span class="line">List&lt;Team&gt; teams2 = entityManager.createQuery(<span class="string">&quot;select distinct t from Team t&quot;</span>, Team.class)</span><br><span class="line">                .setFirstResult(<span class="number">0</span>)</span><br><span class="line">                .setMaxResults(<span class="number">2</span>)</span><br><span class="line">                .getResultList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Team team1 : teams2) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;team1.getName() = &quot;</span> + team1.getName() + <span class="string">&quot;/ members : &quot;</span>+ team1.getMembers().size());</span><br><span class="line">    <span class="keyword">for</span> (Member member1 : team1.getMembers()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt; member1.getUserName()  = &quot;</span> + member1.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>컬렉션페치조인 페이징적용결과-batchsize적용했을때</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* select</span><br><span class="line">        distinct t </span><br><span class="line">    from</span><br><span class="line">        Team t *&#x2F; select</span><br><span class="line">            distinct team0_.team_id as team_id1_3_,</span><br><span class="line">            team0_.name as name2_3_ </span><br><span class="line">        from</span><br><span class="line">            Team team0_ limit ?</span><br><span class="line">Hibernate: </span><br><span class="line">    &#x2F;* load one-to-many entity.Team.members *&#x2F; select</span><br><span class="line">        members0_.team_id as team_id4_0_1_,</span><br><span class="line">        members0_.member_id as member_i1_0_1_,</span><br><span class="line">        members0_.member_id as member_i1_0_0_,</span><br><span class="line">        members0_.age as age2_0_0_,</span><br><span class="line">        members0_.team_id as team_id4_0_0_,</span><br><span class="line">        members0_.userName as userName3_0_0_ </span><br><span class="line">    from</span><br><span class="line">        Member members0_ </span><br><span class="line">    where</span><br><span class="line">        members0_.team_id in (</span><br><span class="line">            ?, ?</span><br><span class="line">        )</span><br><span class="line">team1.getName() &#x3D; Team1&#x2F; members : 2</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m2</span><br><span class="line">team1.getName() &#x3D; Team2&#x2F; members : 1</span><br><span class="line">--&gt; member1.getUserName()  &#x3D; m3</span><br></pre></td></tr></table></figure>

<h3 id="2-4-페치조인과-일반조인의-차이"><a href="#2-4-페치조인과-일반조인의-차이" class="headerlink" title="2-4. 페치조인과 일반조인의 차이"></a>2-4. 페치조인과 일반조인의 차이</h3><h4 id="일반-조인"><a href="#일반-조인" class="headerlink" title="일반 조인"></a>일반 조인</h4><ul>
<li>일반조인 실행시 연관된 엔티티를 함께 조회 안함 </li>
<li>[JPQL]<ul>
<li>select t from Team t join t.members m where t.name = ‘팀A’</li>
</ul>
</li>
<li>[SQL]<ul>
<li>SELECT T.* FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID  WHERE T.NAME = ‘팀A’</li>
</ul>
</li>
<li>JPQL은 결과를 반환할때 연관관계 고려안함</li>
<li>단지 select절에 지정한 엔티티만 조회한다.</li>
<li>따라서 Team엔티티만 조회할뿐, Member정보는 조회 안함</li>
</ul>
<h4 id="페치-조인"><a href="#페치-조인" class="headerlink" title="페치 조인"></a>페치 조인</h4><ul>
<li>페치 조인을 사용할때만 연관된 엔티티도 함께 조회 (즉시로딩됨)</li>
<li>페치 조인은 객체 그래프를 SQL한번에 조회하는 개념 </li>
<li>페치 조인은 연관된 엔티티를 함께 조회함</li>
<li>[JPQL]<ul>
<li>select t from Team t join fetch t.members where t.name = ‘팀A’</li>
</ul>
</li>
<li>[SQL]<ul>
<li>SELECT T.<em>, M.</em> FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID WHERE T.NAME = ‘팀A’</li>
</ul>
</li>
</ul>
<h3 id="2-5-페치-조인의-특징-과-한계"><a href="#2-5-페치-조인의-특징-과-한계" class="headerlink" title="2-5. 페치 조인의 특징 과 한계"></a>2-5. 페치 조인의 특징 과 한계</h3><ul>
<li>페치 조인 대상에서는 별칭을 줄수없다. (하이버네이트는 가능하지만 가급적 사용하지 말자)</li>
<li>둘 이상의 컬렉션은 페치 조인 할수 없다. (1:N:M의 관계로 가져오기때문에 관련된 모든 정보를 끌고오기때문에)</li>
<li>컬렉션을 페치조인하면 페이징 API를 사용할수 없다. <ul>
<li>1:1, N:1 같은 단일 값 연관 필드들은 페치 조인해도 페이징 가능 </li>
<li>1:N, N:M 같은 컬렉션은 강제로 페이징처리를 하면 페이징로직이 무시되고 해당 엔티티에 있는 모든 정보를 다 끌고옴. (하이버네이트에서 경고 로그 남기고 모든 row를 메모리에 올리는 불상사가 벌어짐.)</li>
<li>컬렉션은 그럼 페이징을 못하는가? 컬렉션 상태에서는 아니고 fetch join한 부분을 지우고 @BatchSize혹은 글로벌설정에서 batchsize를 설정하고 조회하면 페이징 처리는 가능 하지만 N+1을 완벽하게 해소되지 않은 상태지만 성능에는 큰 도움이됨. </li>
</ul>
</li>
<li>연관된 엔티티들을 SQL한번으로 조회 -&gt; 성능 최적화 </li>
<li>엔티티에 직접 적용하는 글로벌 로딩 전략보다 우선함 </li>
<li>실무에서는 글로벌 로딩전략은 모두 지연로딩으로 걸어두자</li>
<li>최적화 필요한곳만 페치 조인 적용 </li>
<li>페치조인을 사용해서 연관된 엔티티를 쿼리시점에 조회해서 지연로딩이 발생하지 않는데, 이때 준영속상태에서도 객체그래프를 탐색할수있다. 왜냐 1차캐시에 올라갔기때문에 </li>
</ul>
<h3 id="2-6-페치조인-정리"><a href="#2-6-페치조인-정리" class="headerlink" title="2-6. 페치조인 정리"></a>2-6. 페치조인 정리</h3><ul>
<li>모든것을 페치 조인으로 해결이 안될때가 있음. </li>
<li>페치 조인은 객체 그래프를 유지할때 사용하면 효과적 </li>
<li>여러 테이블을 조인해서 엔티티가 가진 모양이 아닌 전혀 다른 결과를 내야하면, 페치조인보다 일반 조인을 사용하고 필요한 데이터들만 프로젝션해서 DTO로 반환하는 것이 효과적</li>
</ul>
<h2 id="3-다형성-쿼리"><a href="#3-다형성-쿼리" class="headerlink" title="3. 다형성 쿼리"></a>3. 다형성 쿼리</h2><h3 id="3-1-TYPE"><a href="#3-1-TYPE" class="headerlink" title="3-1. TYPE"></a>3-1. TYPE</h3><ul>
<li>조회 대상을 특정 자식으로 한정 </li>
<li>예) 위 예제중 Item중에 Book, Movie를 조회해라</li>
<li>[JPQL]<ul>
<li>select i from Item i where type(i) IN (Book, Movie)</li>
</ul>
</li>
<li>[SQL]<ul>
<li>select i from i where i.DTYPE in (‘B’, ‘M’)</li>
</ul>
</li>
</ul>
<h3 id="3-2-TREAT-JPA-2-1"><a href="#3-2-TREAT-JPA-2-1" class="headerlink" title="3-2. TREAT (JPA 2.1)"></a>3-2. TREAT (JPA 2.1)</h3><ul>
<li>자바의 타입 캐스팅과 유사</li>
<li>상속 구조에서 부모타입을 특정 자식 타입으로 다룰때 사용 </li>
<li>FROM, WHERE, SELECT(하이버네이트 지원) 사용</li>
<li>예) 부모인 Item과 자식 Book이 있다.</li>
<li>[JPQL]<ul>
<li>select i from Item i where treat(i as Book).auther = ‘kim’</li>
</ul>
</li>
<li>[SQL]<ul>
<li>select i.* from Item i where i.DTYPE = ‘B’ and i.auther = ‘kim’</li>
</ul>
</li>
</ul>
<h2 id="4-엔티티-직접-사용"><a href="#4-엔티티-직접-사용" class="headerlink" title="4. 엔티티 직접 사용"></a>4. 엔티티 직접 사용</h2><p><img src="/images/jpa/jpql-15.png" alt="엔티티직접사용 예시"></p>
<ul>
<li>JPQL에서 엔티티를 직접 사용하면 SQL에서 해당 엔티티의 기 본 키 값을 사용</li>
<li>[JPQL]<ul>
<li>select count(m.id) from Member m //엔티티의 아이디를 사용</li>
<li>select count(m) from Member m //엔티티를 직접 사용</li>
</ul>
</li>
<li>[SQL] (JPQL 둘다 같은 다음 SQL 실행)<ul>
<li>select count(m.id) as cnt from Member m</li>
</ul>
</li>
</ul>
<p><img src="/images/jpa/jpql-16.png" alt="엔티티직접사용 기본키예시"><br><img src="/images/jpa/jpql-17.png" alt="엔티티직접사용 외래키예시"></p>
<h2 id="5-Named-쿼리"><a href="#5-Named-쿼리" class="headerlink" title="5. Named 쿼리"></a>5. Named 쿼리</h2><h3 id="5-1-Named쿼리-정적-쿼리"><a href="#5-1-Named쿼리-정적-쿼리" class="headerlink" title="5-1. Named쿼리 - 정적 쿼리"></a>5-1. Named쿼리 - 정적 쿼리</h3><ul>
<li>미리 정의해서 이름을 부여해두고 사용하는 JPQL</li>
<li>정적 쿼리</li>
<li>어노테이션, XML지원</li>
<li>애플리케이션 로딩 시점에 초기화 후 재사용 </li>
<li>애플리케이션 로딩 시점에 쿼리를 검증해줌 </li>
</ul>
<h3 id="5-2-Named쿼리-어노테이션-사용-방법"><a href="#5-2-Named쿼리-어노테이션-사용-방법" class="headerlink" title="5-2. Named쿼리 - 어노테이션 사용 방법"></a>5-2. Named쿼리 - 어노테이션 사용 방법</h3><p><img src="/images/jpa/jpql-18.png" alt="Named쿼리 어노테이션예시"></p>
<h3 id="5-3-Named쿼리-XML-사용방법"><a href="#5-3-Named쿼리-XML-사용방법" class="headerlink" title="5-3. Named쿼리 - XML 사용방법"></a>5-3. Named쿼리 - XML 사용방법</h3><p><img src="/images/jpa/jpql-19.png" alt="Named쿼리 XML예시"></p>
<h3 id="5-4-Named쿼리-환경에-따른-설정"><a href="#5-4-Named쿼리-환경에-따른-설정" class="headerlink" title="5-4. Named쿼리 환경에 따른 설정"></a>5-4. Named쿼리 환경에 따른 설정</h3><ul>
<li>XML이 항상 우선권을 가짐 </li>
<li>애플리케이션 운영 환경에 따라 다른 XML을 배포할수있다. </li>
</ul>
<h2 id="6-JPQL-벌크연산"><a href="#6-JPQL-벌크연산" class="headerlink" title="6. JPQL - 벌크연산"></a>6. JPQL - 벌크연산</h2><p><img src="/images/jpa/jpql-20.png" alt="벌크연산"><br><img src="/images/jpa/jpql-21.png" alt="벌크연산 예시"></p>
<h3 id="6-1-벌크연산시-주의"><a href="#6-1-벌크연산시-주의" class="headerlink" title="6-1. 벌크연산시 주의"></a>6-1. 벌크연산시 주의</h3><ul>
<li>벌크 연산은 영속성 컨텍스트를 무시하고 DB에 직접 쿼리 (JPQL로 사용하니 당연한 부분)<ul>
<li>벌크 연산을 먼저 실행 </li>
<li>벌크 연산 수행 후 영속성 컨텍스트 초기화 </li>
</ul>
</li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/08/jpa-obj-query-2/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/05/07/jpa-obj-query-1/"
                            aria-label=": jpa-obj-query-1"
                        >
                            jpa-obj-query-1
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-05-07T11:42:32+00:00">
	
		    May 07, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5%EC%BF%BC%EB%A6%AC%EC%96%B8%EC%96%B4/">객체지향쿼리언어</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="객체지향-쿼리-언어"><a href="#객체지향-쿼리-언어" class="headerlink" title="객체지향 쿼리 언어"></a>객체지향 쿼리 언어</h1><p>JPA는 다양한 쿼리 방법을 지원한다. JPQL,JPA Criteria, QueryDSL, 네이티브 SQL, JDBC API/MyBatis등과 같은 외부라이브러리 사용등<br>하지만 결론적으로 실무에서 자주 사용할것은, JPQL/QueryDSL 일것이다. 따라서 JPQL/QueryDSL 위주로 정리하도록 한다. </p>
<h2 id="1-JPQL"><a href="#1-JPQL" class="headerlink" title="1. JPQL"></a>1. JPQL</h2><h3 id="1-1-JPQL-특징"><a href="#1-1-JPQL-특징" class="headerlink" title="1-1. JPQL 특징"></a>1-1. JPQL 특징</h3><ul>
<li>JPQL은 객체지향 쿼리 언어이다. 따라서 테이블을 대상으로 쿼리하는것이 아니라, <strong>엔티티 객체를 대상</strong> 으로 쿼리한다.</li>
<li>JPQL은 SQL을 추상화해서 특정 데이터베이스 SQL에 의존하지 않는다. (여러 DB방언 지원 및 ANSI표준까지 지원)</li>
<li>JPQL의 종착지는 SQL이다. SQL로 결국 변환됨.</li>
</ul>
<p><img src="/images/jpa/jpql-1.png" alt="실습 샘플 모델"></p>
<h3 id="1-2-JPQL-기본-문법"><a href="#1-2-JPQL-기본-문법" class="headerlink" title="1-2. JPQL 기본 문법"></a>1-2. JPQL 기본 문법</h3><p><img src="/images/jpa/jpql-2.png" alt="JPQL기본문법 구조1"></p>
<ul>
<li>엔티티와 속성은 대소문자 구분함. </li>
<li>jpql 키워드는 대소문자 구분안함.</li>
<li>반드시 엔티티 이름으로 사용해야함. (테이블이름 안됨)</li>
<li>별칭은 필수! </li>
</ul>
<p><img src="/images/jpa/jpql-3.png" alt="JPQL기본문법 구조2"><br><img src="/images/jpa/jpql-4.png" alt="JPQL기본문법 구조3"></p>
<figure class="highlight java"><figcaption><span>jpql-basic-1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; members = entityManager.createQuery(<span class="string">&quot;select m from Member m&quot;</span>, Member.class)</span><br><span class="line">               .getResultList();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>jpql-basic-2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; paramResult = entityManager.createQuery(<span class="string">&quot;select m from Member m where m.userName = :userName&quot;</span>, Member.class)</span><br><span class="line">               .setParameter(<span class="string">&quot;userName&quot;</span>,<span class="string">&quot;m2&quot;</span>)</span><br><span class="line">               .getResultList();</span><br></pre></td></tr></table></figure>

<p>[주의] 아래와 같이 쿼리 짜지 말자! </p>
<figure class="highlight java"><figcaption><span>jpql-basic-3</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//이런식으로 쿼리짜지말자. join걸어서 가져오는걸로 (가독성이 떨어짐 비추 무조건 명시적조인을 하자)</span></span><br><span class="line"><span class="comment">//그리고 JPQL에서는 fetch상태 자체가 무시됨.(LAZY로 걸어도 그냥 조인됨)</span></span><br><span class="line">List&lt;Team&gt; teams = entityManager.createQuery(<span class="string">&quot;select m.team from Member m&quot;</span>, Team.class)</span><br><span class="line">               				.getResultList();</span><br></pre></td></tr></table></figure>

<h3 id="1-3-프로젝션"><a href="#1-3-프로젝션" class="headerlink" title="1-3. 프로젝션"></a>1-3. 프로젝션</h3><p><img src="/images/jpa/jpql-5.png" alt="JPQL프로젝션"><br><img src="/images/jpa/jpql-6.png" alt="JPQL프로젝션-여러값조회"></p>
<p>[참고]</p>
<ul>
<li>엔티티프로젝션은 Persistance Context에 관리된다.</li>
<li>임베디드타입은 엔티티 타입이 아닌 값타입이다. 따라서 직접 조회한 값타입인 임베디드타입은 Persistance Context에 관리되지않는다.</li>
</ul>
<figure class="highlight java"><figcaption><span>jpql-projection</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MemberInfo&gt; memberInfos = entityManager</span><br><span class="line">                .createQuery(<span class="string">&quot;select new entity.MemberInfo(m.userName,m.age) from Member m&quot;</span>, MemberInfo.class)</span><br><span class="line">                .getResultList();</span><br></pre></td></tr></table></figure>

<h3 id="1-4-페이징-API"><a href="#1-4-페이징-API" class="headerlink" title="1-4. 페이징 API"></a>1-4. 페이징 API</h3><p>JPA의 페이징은 여러 DB방언의 페이징처리를 추상화 되어있다.</p>
<ul>
<li>setFirstResult(int startPosition) : 조회 시작 위치 (0부터시작)</li>
<li>setMaxResults(int maxResult) : 조회할 데이터수 </li>
</ul>
<figure class="highlight java"><figcaption><span>jpql-paging</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Member&gt; memberList = entityManager.createQuery(<span class="string">&quot;select m from Member m join fetch m.team t order by m.age desc&quot;</span>, Member.class)</span><br><span class="line">                .setFirstResult(<span class="number">0</span>)</span><br><span class="line">                .setMaxResults(<span class="number">20</span>)</span><br><span class="line">                .getResultList();</span><br></pre></td></tr></table></figure>

<h3 id="1-5-조인"><a href="#1-5-조인" class="headerlink" title="1-5. 조인"></a>1-5. 조인</h3><p>기본적인 inner join / left (outer) join / cross join (세타조인) 이 지원된다. 기본적인 ANSI표준 join이 그대로 지원된다고 생각하면됨.</p>
<h4 id="조인-ON절"><a href="#조인-ON절" class="headerlink" title="조인 - ON절"></a>조인 - ON절</h4><ol>
<li>조인 대상 필터링<ul>
<li>SELECT m, t FROM Member m LEFT JOIN m.team t on t.name = ‘A’</li>
<li>위 쿼리처럼 ON 절 뒤에 join하면서 필터작업을 미리 할수있는 기능  </li>
</ul>
</li>
<li>연관관계 없는 엔티티 외부 조인 (하이버네이트 5.1부터가능)<ul>
<li>보통 키값으로 조인을 하지만 전혀 관계없는 부분도 조인조건에 넣을수있음.</li>
<li>SELECT m, t FROM Member m LEFT JOIN Team t on m.username = t.name</li>
</ul>
</li>
</ol>
<h3 id="1-6-서브쿼리"><a href="#1-6-서브쿼리" class="headerlink" title="1-6. 서브쿼리"></a>1-6. 서브쿼리</h3><p><img src="/images/jpa/jpql-7.png" alt="JPQL서브쿼리"></p>
<figure class="highlight sql"><figcaption><span>서브쿼리-1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#나이가 평균보다 많은 회원 </span><br><span class="line"><span class="keyword">select</span> m <span class="keyword">from</span> <span class="keyword">Member</span> m </span><br><span class="line"><span class="keyword">where</span> m.age <span class="operator">&gt;</span> (<span class="keyword">select</span> <span class="built_in">avg</span>(m2.age) <span class="keyword">from</span> <span class="keyword">Member</span> m2) </span><br><span class="line"></span><br><span class="line">#한건이라도주문한고객</span><br><span class="line"><span class="keyword">select</span> m <span class="keyword">from</span> <span class="keyword">Member</span> m</span><br><span class="line"><span class="keyword">where</span> (<span class="keyword">select</span> <span class="built_in">count</span>(o) <span class="keyword">from</span> <span class="keyword">Order</span> o <span class="keyword">where</span> m <span class="operator">=</span> o.member) <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#팀A 소속인 회원</span><br><span class="line"><span class="keyword">select</span> m <span class="keyword">from</span> <span class="keyword">Member</span> m</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> t <span class="keyword">from</span> m.team t <span class="keyword">where</span> t.name <span class="operator">=</span> ‘팀A<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#전체 상품 각각의 재고보다 주문량이 많은 주문들</span></span><br><span class="line"><span class="string">select o from Order o </span></span><br><span class="line"><span class="string">where o.orderAmount &gt; ALL (select p.stockAmount from Product p)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#어떤 팀이든 팀에 소속된 회원</span></span><br><span class="line"><span class="string">select m from Member m </span></span><br><span class="line"><span class="string">where m.team = ANY (select t from Team t)</span></span><br></pre></td></tr></table></figure>

<h4 id="JPA-서브쿼리-한계"><a href="#JPA-서브쿼리-한계" class="headerlink" title="JPA 서브쿼리 한계"></a>JPA 서브쿼리 한계</h4><ul>
<li>JPA는 WHERE/HAVING절만 서브쿼리 사용가능 </li>
<li>하이버네이트에서는 SELECT절에서 서브쿼리 사용가능</li>
<li>FROM 절 서브쿼리는 현재 JPQL에서는 불가능 <ul>
<li>조인으로 풀수있으면 해결하고 그래도 안되면 쿼리를 쪼개서 처리하거나 그래도 안되면 native쿼리로 처리 해야함. </li>
</ul>
</li>
</ul>
<h3 id="1-7-JPQL-타입표현"><a href="#1-7-JPQL-타입표현" class="headerlink" title="1-7. JPQL 타입표현"></a>1-7. JPQL 타입표현</h3><h4 id="JPQL-타입-표현"><a href="#JPQL-타입-표현" class="headerlink" title="JPQL 타입 표현"></a>JPQL 타입 표현</h4><ul>
<li>문자: ‘HELLO’, ‘She’’s’ </li>
<li>Boolean: TRUE, FALSE</li>
<li>숫자: 10L(Long), 10D(Double), 10F(Float)</li>
<li>ENUM: jpabook.MemberType.Admin (패키지명 포함) </li>
<li>엔티티 타입: TYPE(m) = Member (상속 관계에서 사용)</li>
</ul>
<h4 id="JPQL-논리연산-및-비교연산"><a href="#JPQL-논리연산-및-비교연산" class="headerlink" title="JPQL 논리연산 및 비교연산"></a>JPQL 논리연산 및 비교연산</h4><ul>
<li>EXISTS, IN</li>
<li>AND, OR, NOT</li>
<li>=, &gt;, &gt;=, &lt;, &lt;=, &lt;&gt; BETWEEN, LIKE, IS NULL</li>
</ul>
<h4 id="JPQL-연산자-우선순위"><a href="#JPQL-연산자-우선순위" class="headerlink" title="JPQL 연산자 우선순위"></a>JPQL 연산자 우선순위</h4><ol>
<li>경로탐색연산(.)</li>
<li>수학연산 : 단항연산자(+,-),*,/,+,-</li>
<li>비교연산 : =,&gt;,&gt;=,&lt;,&lt;=,&lt;&gt;(다름),BETWEEN,LIKE,IN,IS NULL,IS EMPTY,EXIST </li>
<li>논리연산 : AND,OR,NOT</li>
</ol>
<h3 id="1-8-CASE-식"><a href="#1-8-CASE-식" class="headerlink" title="1-8. CASE 식"></a>1-8. CASE 식</h3><p><img src="/images/jpa/jpql-8.png" alt="CASE1"><br><img src="/images/jpa/jpql-9.png" alt="COALESCE/NULLIF"></p>
<h3 id="1-9-기본함수"><a href="#1-9-기본함수" class="headerlink" title="1-9. 기본함수"></a>1-9. 기본함수</h3><ul>
<li>concat, substring, trim, lower/upper, length, locate, abs, sqrt, mod, size, index(jpq전용)</li>
</ul>
<h4 id="사용자-정의-함수"><a href="#사용자-정의-함수" class="headerlink" title="사용자 정의 함수"></a>사용자 정의 함수</h4><p><img src="/images/jpa/jpql-10.png" alt="사용자정의함수"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/05/07/jpa-obj-query-1/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/04/28/value-type/"
                            aria-label=": value-type"
                        >
                            value-type
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-04-28T13:53:22+00:00">
	
		    Apr 28, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EA%B0%92%ED%83%80%EC%9E%85/">값타입</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="값-타입"><a href="#값-타입" class="headerlink" title="값 타입"></a>값 타입</h1><blockquote><p>JPA 데이터 분류 2가지</p>
<ol>
<li>엔티티 타입</li>
</ol>
<ul>
<li>@Entity로 정의하는 객체 </li>
<li>데이터가 변해도 식별자로 지속해서 추적 가능 </li>
</ul>
<ol start="2">
<li>값 타입 </li>
</ol>
<ul>
<li>int,long,String같은 단순히 값으로 사용하는 자바 기본 타입이나 객체 </li>
<li>식별자가 없으므로 추적 불가능 (숫자 100을 200으로 변경하면 완전히 다른 값으로 대체됨.)</li>
</ul>
<p>기본값 타입 3가지 </p>
<ul>
<li>기본값 타입 (자바 기본타입(int,double), 래퍼 클래스(Integer,Long), String)</li>
<li>임베디드 타입 (복합 값 타입)</li>
<li>컬렉션 값 타입 </li>
</ul>
</blockquote>

<h2 id="1-기본값-타입"><a href="#1-기본값-타입" class="headerlink" title="1. 기본값 타입"></a>1. 기본값 타입</h2><p><img src="/images/jpa/value-1.png" alt="기본값 타입"></p>
<h2 id="2-임베디드-타입-복합값-타입"><a href="#2-임베디드-타입-복합값-타입" class="headerlink" title="2. 임베디드 타입(복합값 타입)"></a>2. 임베디드 타입(복합값 타입)</h2><figure class="highlight java"><figcaption><span>임베디드타입 예제</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;Orders&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span> <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;order_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderAmount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;member_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Member member;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Embedded</span></span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;product_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Product product;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//getter,setter 생략</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgConstructor</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String street;</span><br><span class="line">    <span class="keyword">private</span> String zipcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="임베디드-타입-특징"><a href="#임베디드-타입-특징" class="headerlink" title="임베디드 타입 특징"></a>임베디드 타입 특징</h3><ul>
<li>int,String과 같은 값 타입 </li>
<li>주로 기본값 타입을 모아서 만들어서 복합 값 타입이라 부름 </li>
<li>새로운 값 타입을 직접 정의 가능 (응집도 높아짐에 따라 재사용성 증가)</li>
<li>Period.isWork 처럼 해당 값 타입만 사용하는 의미있는 메소드 만들수있음. </li>
<li>임베디드 타입을 포함한 모든 값 타입은 , 값 타입을 소유한 엔티티에 생명주기를 의존함. </li>
</ul>
<h3 id="임베디드-타입과-연관관계"><a href="#임베디드-타입과-연관관계" class="headerlink" title="임베디드 타입과 연관관계"></a>임베디드 타입과 연관관계</h3><p><img src="/images/jpa/value-2.png" alt="임베디드 타입과 연관관계"></p>
<ul>
<li>위 그림 처럼 entity는 여러 임베디드 타입을 가질수있으며, 임베디드타입은 다른 엔티티를 가질수 있음. </li>
</ul>
<h3 id="AttributeOverride-속성-재정의"><a href="#AttributeOverride-속성-재정의" class="headerlink" title="@AttributeOverride: 속성 재정의"></a>@AttributeOverride: 속성 재정의</h3><ul>
<li>한 엔티티에 같은 임베디드 타입을 사용하면? 컬럼명이 중복되서 에러남. </li>
<li>@AttributeOverrides, @AttributeOverride를 사용해서 컬러 명 속성을 재정의 (homeAddress,workAddress)</li>
</ul>
<h3 id="임베디드-타입과-null"><a href="#임베디드-타입과-null" class="headerlink" title="임베디드 타입과 null"></a>임베디드 타입과 null</h3><ul>
<li>임베디드 타입의 값이 null이면 매핑한 컬럼 모두 null로 세팅됨 (member.setAddress(null))</li>
</ul>
<h2 id="3-값-타입과-불변-객체"><a href="#3-값-타입과-불변-객체" class="headerlink" title="3. 값 타입과 불변 객체"></a>3. 값 타입과 불변 객체</h2><blockquote><p>값 타입은 복잡한 객체 세상을 조금이라도 단순화하려고 만든 개념이다. 따라서 값 타입은 단순하고 안전하게 다 룰 수 있어야 한다.</p>
</blockquote>

<h3 id="값-타입-복사"><a href="#값-타입-복사" class="headerlink" title="값 타입 복사"></a>값 타입 복사</h3><p><img src="/images/jpa/value-3.png" alt="값 타입 공유 참조"><br><img src="/images/jpa/value-4.png" alt="값 타입 복사"></p>
<h3 id="객체-타입-한계"><a href="#객체-타입-한계" class="headerlink" title="객체 타입 한계"></a>객체 타입 한계</h3><p><img src="/images/jpa/value-5.png" alt="객체 타입 한계"><br><img src="/images/jpa/value-6.png" alt="객체 타입 한계 예시"></p>
<h3 id="불변객체"><a href="#불변객체" class="headerlink" title="불변객체"></a>불변객체</h3><p><img src="/images/jpa/value-7.png" alt="불변객체"></p>
<h2 id="4-값-타입-비교"><a href="#4-값-타입-비교" class="headerlink" title="4. 값 타입 비교"></a>4. 값 타입 비교</h2><p><img src="/images/jpa/value-8.png" alt="값 타입 비교"></p>
<h2 id="5-값-타입-컬렉션"><a href="#5-값-타입-컬렉션" class="headerlink" title="5. 값 타입 컬렉션"></a>5. 값 타입 컬렉션</h2><ul>
<li>결론부터 이야기하면 <strong>값 타입 컬렉션은 가급적 피하는것이 좋다.</strong>  </li>
<li>값타입 특성상 엔티티 처럼 추적이 불가능하기때문에, 일부 row를 수정하려고 하면, 해당 키값의 포함된 모든 데이터를 지우고 다시 생성한다. </li>
<li>값 타입 컬렉션 대신 값타입을 엔티티로 승격시키고, <strong>cacade + 고아객체(orhanremoval)</strong> 로 주 엔티티에서 관리하도록 만들어서 관리해야함.</li>
<li>값 타입 컬렉션은 정말 단순한 데이터를 저장할때 쓴다. (예를들면 멀티셀렉트박스로 선택한 값들을 단순 저장할때.)</li>
</ul>
<h3 id="값-타입-사용시-주의사항"><a href="#값-타입-사용시-주의사항" class="headerlink" title="값 타입 사용시 주의사항"></a>값 타입 사용시 주의사항</h3><ul>
<li>값 타입은 정말 값 타입이라 판단될 때만 사용</li>
<li>엔티티와 값 타입을 혼동해서 엔티티를 값 타입으로 만들면 안됨</li>
<li>식별자가 필요하고, 지속해서 값을 추적, 변경해야 한다면 그것 은 값 타입이 아닌 엔티티</li>
</ul>
<h3 id="값-타입-컬렉션-소개"><a href="#값-타입-컬렉션-소개" class="headerlink" title="값 타입 컬렉션 소개"></a>값 타입 컬렉션 소개</h3><p><img src="/images/jpa/collection-value-1.png" alt="값 타입 컬렉션 소개1"><br><img src="/images/jpa/collection-value-2.png" alt="값 타입 컬렉션 소개2"></p>
<h3 id="값-타입-컬렉션의-제약사항"><a href="#값-타입-컬렉션의-제약사항" class="headerlink" title="값 타입 컬렉션의 제약사항"></a>값 타입 컬렉션의 제약사항</h3><p><img src="/images/jpa/collection-value-3.png" alt="값 타입 컬렉션의 제약사항"></p>
<h3 id="값-타입-컬렉션의-대안"><a href="#값-타입-컬렉션의-대안" class="headerlink" title="값 타입 컬렉션의 대안"></a>값 타입 컬렉션의 대안</h3><p><img src="/images/jpa/collection-value-4.png" alt="값 타입 컬렉션 대안"></p>
<h3 id="값-타입-정리"><a href="#값-타입-정리" class="headerlink" title="값 타입 정리"></a>값 타입 정리</h3><p><img src="/images/jpa/collection-value-5.png" alt="값 타입 정리"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/04/28/value-type/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2021/04/21/proxy-relational/"
                            aria-label=": proxy-relational"
                        >
                            proxy-relational
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2021-04-21T05:40:23+00:00">
	
		    Apr 21, 2021
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Study/">Study</a>, <a class="category-link" href="/categories/%EC%9E%90%EB%B0%94ORM%ED%91%9C%EC%A4%80JPA%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/">자바ORM표준JPA프로그래밍</a>, <a class="category-link" href="/categories/%ED%94%84%EB%A1%9D%EC%8B%9C%EC%99%80-%EC%97%B0%EA%B4%80%EA%B4%80%EA%B3%84-%EA%B4%80%EB%A6%AC/">프록시와 연관관계 관리</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="프록시와-연관관계-관리"><a href="#프록시와-연관관계-관리" class="headerlink" title="프록시와 연관관계 관리"></a>프록시와 연관관계 관리</h1><h2 id="1-프록시"><a href="#1-프록시" class="headerlink" title="1. 프록시"></a>1. 프록시</h2><h3 id="1-1-프록시-기초"><a href="#1-1-프록시-기초" class="headerlink" title="1-1. 프록시 기초"></a>1-1. 프록시 기초</h3><p>JPA에서 식별자로 엔티티 하나를 조회할 때는 EntityManager.find()를 사용한다. 이 메소드는 Persistance Context에 엔티티가 없으면 DB를 조회 한다. 이렇게 엔티티를 직접 조회하면 조회한 엔티티를 실제 사용하든 사용하지 않든 DB를 조회하게 된다. 엔티티를 실제 사용하는 시점까지 DB조회를 미루고싶으면 EntityManager.getReference()를 사용하면 된다. getReference로 호출할때 JPA는 DB조회를 하지 않고 실제 엔티티 객제도 생성 하지 않는다. 대신 DB접근을 위임한 프록시 객체를 반환한다. </p>
<p><img src="/images/jpa/proxy-1.png" alt="프록시 구조1"></p>
<p>위와 같이 프록시는 실제 클래스를 상속받아 사용되며, 실제클래스와 겉모양이 같음. 사용하는 입장에서는 진짜 객체인지 가짜객체인지 구분할 필요없이 그냥 사용하면 됨. (이론상)</p>
<p><img src="/images/jpa/proxy-2.png" alt="프록시 구조2"></p>
<p>위와 같이 프록시 객체는 실제 객체에 대한 참조를 보관하며, 프록시 객체의 메소드를 호출하면 프록시 객체는 실제 객체의 메소드를 호출한다. </p>
<h4 id="프록시-객체-초기화"><a href="#프록시-객체-초기화" class="headerlink" title="프록시 객체 초기화"></a>프록시 객체 초기화</h4><p><img src="/images/jpa/proxy-3.png" alt="프록시 객체 초기화"></p>
<h4 id="프록시-특징"><a href="#프록시-특징" class="headerlink" title="프록시 특징"></a>프록시 특징</h4><ul>
<li>프록시 객체는 처음 사용할때 한번만 호출됨</li>
<li>프록시 객체를 초기화한다고 프록시 객체가 실제 엔티티로 바뀌지는 않음.(프록시 객체가 초기화 되면 프록시 객체를 통해 실제 엔티티 접근한다.)</li>
<li>프록시 객체는 원본 엔티티를 상속받은 객체이므로 타입 체크시에 주의해서 사용해야함.(타입체크시 == 대신 instanceof 사용하자)</li>
<li>Persistance Context에 찾는 엔티티가 이미 있으면, DB를 조회할 이유가 없으므로,em.getReference()를 호출하더라도 프록시가 아닌 실제 엔티티를 반환함</li>
<li>초기화는 Persistance Context의 도움을 받아야함 따라서 Persistance Context의 도움을 받을수 없는 준영속 상태의 프록시를 초기화화면 문제가 발생함. (LazyInitializationException발생)</li>
</ul>
<h3 id="1-2-프록시와-식별자"><a href="#1-2-프록시와-식별자" class="headerlink" title="1-2. 프록시와 식별자"></a>1-2. 프록시와 식별자</h3><ul>
<li>엔티티 접근 방식을 @Access(AccessType.PROPERTY) 로 설정한경우 초기화 하지 않음</li>
<li>@Access(AccessType.FIELD)로 설정하면 JPA는 getId메소드가 id만 조회하는 메소드인지 다른 필드까지 활용해서 어떤 일을 하는 메소드인지 알지 못하므로 프록시 객체를 초기화 하게됨.</li>
<li>연관관계를 설정할때는 식별자 값만 사용하므로 프록시를 사용하면 DB접근 횟수를 줄일수있음. </li>
</ul>
<h3 id="1-3-프록시-확인"><a href="#1-3-프록시-확인" class="headerlink" title="1-3. 프록시 확인"></a>1-3. 프록시 확인</h3><ul>
<li>프록시 인스턴스의 초기화 여부 확인 (PersistenceUnitUtil.isLoaded(Object entity))</li>
<li>프록시 클래스 확인 방법 (entity.getClass().getName() 출력(..javasist.. or HibernateProxy…))</li>
<li>프록시 강제 초기화 (org.hibernate.Hibernate.initialize(entity);)</li>
<li>참고: JPA 표준은 강제 초기화 없음 (강제 호출: member.getName())</li>
</ul>
<h2 id="2-즉시로딩-과-지연로딩"><a href="#2-즉시로딩-과-지연로딩" class="headerlink" title="2. 즉시로딩 과 지연로딩"></a>2. 즉시로딩 과 지연로딩</h2><p>지연 로딩(LAZY) : 연관된 엔티티를 프록시로 조회한다. 프록시를 실제 사용할때 초기화 하면서 데이터베이스를 조회한다.<br>즉시 로딩(EAGER) : 연관된 엔티티를 즉시 조회한다. 하이버네이트는 가능하면 SQL조인을 사용해서 한번에 조회한다. </p>
<p><img src="/images/jpa/fetch-1.png" alt="프록시와 즉시로딩 주의"></p>
<blockquote><p>[참고] JPQL에서 JOIN 할시 발생하는 이슈 </p>
<ul>
<li>select m from Member join m.team 이런 쿼리를 날리면 어떻게 될까? N+1 쿼리가 나간다. 중요한건 글로벌 fetch전략과 상관없이 N+1이 나간다는것에 초점이 있다. 이런 부분을 해결하기 위해서는 join fetch를 사용해서 한방에 쿼리가 나갈수 있도록 해야한다.  </li>
</ul>
</blockquote>

<p><img src="/images/jpa/fetch-2.png" alt="실무에서 fetch전략 활용 방법"></p>
<h2 id="3-영속성-전이-CASCADE"><a href="#3-영속성-전이-CASCADE" class="headerlink" title="3. 영속성 전이: CASCADE"></a>3. 영속성 전이: CASCADE</h2><p><img src="/images/jpa/cacade-1.png" alt="cacade 정의"><br><img src="/images/jpa/cacade-2.png" alt="cacade 사용방법"><br><img src="/images/jpa/cacade-3.png" alt="cacade 사용 주의점"></p>
<ul>
<li>CACADE는 보통 ALL/PERSIST 위주로 사용하며,그나마 REMOVE까지는 쓰고 그 외 나머지는 잘 사용안함. </li>
</ul>
<h2 id="4-고아-객체"><a href="#4-고아-객체" class="headerlink" title="4. 고아 객체"></a>4. 고아 객체</h2><p><img src="/images/jpa/orhpan-1.png" alt="고아객체 정의"><br><img src="/images/jpa/orhpan-2.png" alt="고아객체 주의점"><br><img src="/images/jpa/orhpan-3.png" alt="cacade + 고아객체,생명주기"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2021/04/21/proxy-relational/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
          <li class="pagination-prev">
            <a
                class="btn btn--default btn--small"
                href="/categories/Study/"
                aria-label="NEWER POSTS"
            >
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span>NEWER POSTS</span>
            </a>
          </li>
        
        
          <li class="pagination-next">
            <a
                class="btn btn--default btn--small"
                href="/categories/Study/page/3/"
                aria-label="OLDER POSTS"
            >
              <span>OLDER POSTS</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">page 2 of 5</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2021 codexdawn. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">codexdawn</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover-v1.2.0.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-ikbi0v8fyzuu91xv5rmpcrnwb4qinfgborzd5kejmj8wr6ibfra8oaxqshyg.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
